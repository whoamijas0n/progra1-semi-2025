<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="bi bi-file-earmark-text text-primary"></i> Mis Justificaciones
            </h2>
            <button class="btn btn-primary" onclick="JustificacionesEmpleadoModule.abrirModalNuevo()">
                <i class="bi bi-plus-circle"></i> Nueva Justificación
            </button>
        </div>
    </div>

    <div id="lista-justificaciones" class="row g-3">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Nueva Justificación -->
<div class="modal fade" id="modalJustificacion" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nueva Justificación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formJustificacion">
                    <div class="mb-3">
                        <label class="form-label">Motivo *</label>
                        <textarea class="form-control" id="motivo" rows="4" maxlength="200" required placeholder="Ej: Llegué tarde por tráfico, cita médica, etc."></textarea>
                        <small class="text-muted">Máximo 200 caracteres</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">URL de Documento (Opcional)</label>
                        <input type="url" class="form-control" id="documento_url" placeholder="https://ejemplo.com/comprobante.pdf">
                        <small class="text-muted">Enlace a comprobante (foto, PDF, etc.)</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="JustificacionesEmpleadoModule.enviar()">Enviar Justificación</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    window.JustificacionesEmpleadoModule = (function () {
        async function cargarJustificaciones() {
            try {
                const res = await fetchAuth('/api/justificaciones/mis-justificaciones');
                const justificaciones = await res.json();
                renderizarJustificaciones(justificaciones);
            } catch (error) {
                document.getElementById('lista-justificaciones').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">Error al cargar justificaciones</div>
                </div>
            `;
            }
        }

        function renderizarJustificaciones(justificaciones) {
            const container = document.getElementById('lista-justificaciones');
            if (justificaciones.length === 0) {
                container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="bi bi-file-earmark-text fs-1 d-block mb-3"></i>
                        <h5>No has enviado justificaciones</h5>
                        <p>Haz clic en "Nueva Justificación" para comenzar</p>
                    </div>
                </div>
            `;
                return;
            }

            container.innerHTML = justificaciones.map(j => `
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">Justificación #${j.idJustificacion}</h6>
                            <span class="badge ${j.estado === 'Aprobado' ? 'bg-success' : j.estado === 'Rechazado' ? 'bg-danger' : 'bg-warning'}">
                                ${j.estado}
                            </span>
                        </div>
                        <p class="text-muted mb-2">${j.motivo}</p>
                        <small class="text-muted">
                            <i class="bi bi-clock"></i>
                            ${j.fecha_revision ? new Date(j.fecha_revision).toLocaleDateString() : 'Pendiente'}
                            ${j.supervisor ? ` • Supervisor: ${j.supervisor}` : ''}
                        </small>
                        ${j.documento_url ? `<br><a href="${j.documento_url}" target="_blank" class="text-primary">Ver documento adjunto</a>` : ''}
                    </div>
                </div>
            </div>
        `).join('');
        }

        function abrirModalNuevo() {
            document.getElementById('formJustificacion').reset();
            new bootstrap.Modal(document.getElementById('modalJustificacion')).show();
        }

        async function enviar() {
            const form = document.getElementById('formJustificacion');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                Motivo: document.getElementById('motivo').value.trim(),
                DocumentoUrl: document.getElementById('documento_url').value || null
            };

            try {
                await fetchAuth('/api/justificaciones', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                alert('✅ Justificación enviada exitosamente');
                document.getElementById('modalJustificacion').closest('.modal').querySelector('.btn-close').click();
                cargarJustificaciones();
            } catch (error) {
                alert('❌ Error al enviar justificación');
            }
        }

        // Inicializar
        cargarJustificaciones();

        return {
            abrirModalNuevo,
            enviar
        };
    })();
</script>