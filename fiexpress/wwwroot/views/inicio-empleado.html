<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Dashboard - FiExpress</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .stat-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

            .stat-card:hover {
                transform: translateY(-3px);
            }

        .jornada-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .info-personal {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .fichaje-btn {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 12px 24px;
        }

        .avatar {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.3);
        }

        .progress {
            height: 8px;
            border-radius: 4px;
        }

        .badge-status {
            font-size: 0.75rem;
            padding: 0.4em 0.8em;
        }

        .loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4" id="dashboard-container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-2">
                    <i class="bi bi-speedometer2 text-primary me-2"></i>
                    Mi Dashboard
                </h2>
                <p class="text-muted mb-0">Resumen de tu actividad y estado actual</p>
            </div>
        </div>

        <!-- Información Personal y Estado de Jornada -->
        <div class="row mb-4">
            <!-- Información Personal -->
            <div class="col-md-4 mb-3">
                <div class="card info-personal text-white h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <img id="avatar-empleado" src="" class="avatar rounded-circle me-3" alt="Avatar"
                                 onerror="this.src='https://ui-avatars.com/api/?name=U&size=120&background=0D6EFD&color=fff&bold=true'">
                            <div class="flex-grow-1">
                                <h4 id="nombre-empleado" class="mb-1">Cargando...</h4>
                                <p id="info-empleado" class="mb-0 opacity-90">Departamento: Cargando...</p>
                                <p id="codigo-empleado" class="mb-0 opacity-90">Código: --</p>
                            </div>
                        </div>
                        <div class="row text-center mt-3">
                            <div class="col-4">
                                <h5 id="dias-trabajados-mes" class="mb-1">0</h5>
                                <small>Días Este Mes</small>
                            </div>
                            <div class="col-4">
                                <h5 id="horas-mes" class="mb-1">0h</h5>
                                <small>Horas Mes</small>
                            </div>
                            <div class="col-4">
                                <h5 id="asistencia-percent" class="mb-1">0%</h5>
                                <small>Asistencia</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estado de Jornada -->
            <div class="col-md-8 mb-3">
                <div class="card jornada-card h-100">
                    <div class="card-body">
                        <div class="row align-items-center h-100">
                            <div class="col-md-8">
                                <h3 id="estado-jornada" class="mb-2">Estado de Jornada</h3>
                                <p id="detalle-jornada" class="mb-3 opacity-90">Cargando información...</p>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button id="btn-fichaje-entrada" class="btn btn-light fichaje-btn" onclick="DashboardEmpleado.registrarFichaje('Entrada')">
                                        <i class="bi bi-box-arrow-in-right me-2"></i>Entrada
                                    </button>
                                    <button id="btn-fichaje-salida" class="btn btn-outline-light fichaje-btn" onclick="DashboardEmpleado.registrarFichaje('Salida')">
                                        <i class="bi bi-box-arrow-right me-2"></i>Salida
                                    </button>
                                    <button class="btn btn-outline-light" onclick="DashboardEmpleado.recargarDashboard()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div id="reloj-jornada" class="display-4 fw-bold mb-2">--:--</div>
                                <small class="opacity-90">Tiempo en jornada</small>
                                <div class="mt-2">
                                    <small id="hora-actual" class="opacity-75">--:--</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas Rápidas -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-start border-primary border-4 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Horas Esta Semana</h6>
                                <h3 class="mb-0 text-primary" id="stat-horas-semana">0h</h3>
                                <small class="text-muted" id="stat-progreso-semana">0/40h</small>
                            </div>
                            <i class="bi bi-clock-history fs-1 text-primary opacity-25"></i>
                        </div>
                        <div class="progress mt-2">
                            <div class="progress-bar bg-primary" id="barra-semana" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-start border-success border-4 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Días Asistidos</h6>
                                <h3 class="mb-0 text-success" id="stat-dias-asistidos">0</h3>
                                <small class="text-muted" id="stat-progreso-dias">0/5 días</small>
                            </div>
                            <i class="bi bi-calendar-check fs-1 text-success opacity-25"></i>
                        </div>
                        <div class="progress mt-2">
                            <div class="progress-bar bg-success" id="barra-dias" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-start border-warning border-4 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Minutos Retraso</h6>
                                <h3 class="mb-0 text-warning" id="stat-minutos-retraso">0m</h3>
                                <small class="text-muted">Acumulado mensual</small>
                            </div>
                            <i class="bi bi-alarm fs-1 text-warning opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-start border-info border-4 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Horas Extra</h6>
                                <h3 class="mb-0 text-info" id="stat-horas-extra">0h</h3>
                                <small class="text-muted">Este mes</small>
                            </div>
                            <i class="bi bi-plus-circle fs-1 text-info opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="row">
            <!-- Mis Fichajes de Hoy -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history text-primary me-2"></i>
                            Mis Fichajes de Hoy
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="DashboardEmpleado.recargarFichajes()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Hora</th>
                                        <th>Tipo</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-mis-fichajes">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Cargando fichajes...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mi Horario Actual -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-week text-success me-2"></i>
                            Mi Horario Actual
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="info-horario">
                            <div class="text-center text-muted py-4">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                Cargando horario...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notificaciones Recientes -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-bell text-warning me-2"></i>
                            Notificaciones Recientes
                        </h5>
                        <a href="#" class="btn btn-sm btn-outline-warning" onclick="window.cargarVista('notificaciones-empleado', 'Mis Notificaciones')">
                            Ver Todas
                        </a>
                    </div>
                    <div class="card-body">
                        <div id="lista-notificaciones">
                            <div class="text-center text-muted py-3">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                Cargando notificaciones...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timestamp -->
        <div class="row mt-3">
            <div class="col-12 text-end">
                <small class="text-muted">
                    <i class="bi bi-clock me-1"></i>
                    Actualizado: <span id="ultima-actualizacion">--:--:--</span>
                </small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Dashboard Empleado - Corregido y Funcional
        window.DashboardEmpleado = (function () {
            'use strict';

            const state = {
                empleadoId: null,
                datos: {},
                intervaloReloj: null,
                intervaloActualizacion: null,
                intervaloHora: null
            };

            // ✅ CORRECCIÓN: Helper para llamadas API con manejo de 404
            async function apiCall(url, options = {}) {
                try {
                    const response = await fetch(url, {
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        },
                        ...options
                    });

                    if (response.status === 401) {
                        window.location.href = '/login.html';
                        throw new Error('No autenticado');
                    }

                    if (response.status === 404) {
                        console.warn(`Endpoint no encontrado: ${url}`);
                        return null; // Retorna null en lugar de error para 404
                    }

                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Error en API call:', error);
                    return null; // Retorna null en caso de error
                }
            }

            // ✅ CORRECCIÓN: Cargar datos principales con manejo de errores
            async function cargarDashboard() {
                try {
                    // Obtener información del usuario
                    const usuario = await apiCall('/api/auth/usuario-actual');
                    if (!usuario) {
                        mostrarError('No se pudo cargar la información del usuario');
                        return;
                    }

                    state.empleadoId = usuario.id;
                    state.datos.usuario = usuario;

                    // ✅ CORRECCIÓN: Cargar datos con manejo individual de errores
                    const promises = [
                        apiCall(`/api/fichajes/empleado/${state.empleadoId}?fecha=${new Date().toISOString().split('T')[0]}`),
                        apiCall(`/api/estadisticas/empleado/${state.empleadoId}?inicio=${getInicioMes()}&fin=${getFinMes()}`),
                        apiCall(`/api/horarios/activo/empleado/${state.empleadoId}`),
                        apiCall('/api/notificaciones/mis-notificaciones?soloNoLeidas=true&limit=3'),
                        apiCall(`/api/rfid/empleado/${state.empleadoId}`)
                    ];

                    const resultados = await Promise.allSettled(promises);

                    // Procesar resultados individualmente
                    state.datos.fichajes = resultados[0].status === 'fulfilled' ? (resultados[0].value || []) : [];
                    state.datos.estadisticas = resultados[1].status === 'fulfilled' ? (resultados[1].value || {}) : {};
                    state.datos.horario = resultados[2].status === 'fulfilled' ? resultados[2].value : null;
                    state.datos.notificaciones = resultados[3].status === 'fulfilled' ? (resultados[3].value || []) : [];
                    state.datos.rfid = resultados[4].status === 'fulfilled' ? (resultados[4].value || []) : [];

                    actualizarVista();
                    actualizarTimestamp();

                } catch (error) {
                    console.error('Error cargando dashboard:', error);
                    mostrarError('Error al cargar los datos del dashboard');
                }
            }

            // ✅ CORRECCIÓN: Actualizar vista con verificaciones de elementos
            function actualizarVista() {
                if (!document.getElementById('dashboard-container')) return;

                actualizarInformacionPersonal();
                actualizarEstadoJornada();
                actualizarEstadisticas();
                actualizarFichajesHoy();
                actualizarHorario();
                actualizarNotificaciones();
            }

            function actualizarInformacionPersonal() {
                const usuario = state.datos.usuario;
                if (!usuario) return;

                safeUpdateElement('nombre-empleado', usuario.nombre);
                safeUpdateElement('info-empleado', `Departamento: ${usuario.departamento || 'No asignado'}`);
                safeUpdateElement('codigo-empleado', `Código: ${usuario.codigo_empleado || '--'}`);

                const avatar = document.getElementById('avatar-empleado');
                if (avatar && usuario.foto_url) {
                    avatar.src = usuario.foto_url;
                }

                // Actualizar estadísticas resumidas
                const stats = state.datos.estadisticas;
                if (stats && stats.resumen) {
                    safeUpdateElement('dias-trabajados-mes', stats.resumen.diasTrabajados || 0);
                    safeUpdateElement('horas-mes', (stats.resumen.totalHorasTrabajadas || 0) + 'h');
                    safeUpdateElement('asistencia-percent', (stats.resumen.porcentajeAsistencia || 0) + '%');
                }
            }

            function actualizarEstadoJornada() {
                const fichajes = state.datos.fichajes;
                const ultimoFichaje = fichajes.length > 0 ? fichajes[fichajes.length - 1] : null;
                const necesitaEntrada = !ultimoFichaje || ultimoFichaje.tipo === 'Salida';

                safeUpdateElement('estado-jornada', necesitaEntrada ? 'Fuera de Jornada' : 'En Jornada Laboral');

                if (necesitaEntrada) {
                    safeUpdateElement('detalle-jornada', 'Presiona "Entrada" para comenzar tu jornada');
                    safeUpdateElement('reloj-jornada', '--:--');
                    setButtonState('btn-fichaje-entrada', false);
                    setButtonState('btn-fichaje-salida', true);
                    detenerRelojJornada();
                } else {
                    safeUpdateElement('detalle-jornada', `Última acción: ${ultimoFichaje.tipo} a las ${ultimoFichaje.hora}`);
                    setButtonState('btn-fichaje-entrada', true);
                    setButtonState('btn-fichaje-salida', false);
                    iniciarRelojJornada(ultimoFichaje.hora);
                }
            }

            function actualizarEstadisticas() {
                const stats = state.datos.estadisticas;
                if (!stats || !stats.resumen) return;

                // Horas semanales
                const horasSemanales = Math.round((stats.resumen.totalMinutosTrabajados || 0) / 60);
                safeUpdateElement('stat-horas-semana', horasSemanales + 'h');
                const progresoSemana = Math.min((horasSemanales / 40) * 100, 100);
                safeUpdateElement('stat-progreso-semana', `${horasSemanales}/40h`);
                updateProgressBar('barra-semana', progresoSemana);

                // Días asistidos
                const diasAsistidos = stats.resumen.diasTrabajados || 0;
                safeUpdateElement('stat-dias-asistidos', diasAsistidos);
                const progresoDias = Math.min((diasAsistidos / 5) * 100, 100);
                safeUpdateElement('stat-progreso-dias', `${diasAsistidos}/5 días`);
                updateProgressBar('barra-dias', progresoDias);

                // Minutos retraso
                safeUpdateElement('stat-minutos-retraso', (stats.resumen.totalMinutosRetraso || 0) + 'm');

                // Horas extra
                safeUpdateElement('stat-horas-extra', Math.round((stats.resumen.totalMinutosExtra || 0) / 60) + 'h');
            }

            function actualizarFichajesHoy() {
                const tbody = document.getElementById('tabla-mis-fichajes');
                if (!tbody) return;

                const fichajes = state.datos.fichajes;

                if (fichajes.length === 0) {
                    tbody.innerHTML = `
                            <tr>
                                <td colspan="3" class="text-center text-muted py-4">
                                    <i class="bi bi-clock fs-4 d-block mb-2"></i>
                                    No hay fichajes hoy
                                </td>
                            </tr>
                        `;
                    return;
                }

                tbody.innerHTML = fichajes.map(f => `
                        <tr>
                            <td>
                                <strong>${f.hora || '--:--'}</strong>
                            </td>
                            <td>
                                <span class="badge ${f.tipo === 'Entrada' ? 'bg-success' : 'bg-danger'} badge-status">
                                    <i class="bi ${f.tipo === 'Entrada' ? 'bi-box-arrow-in-right' : 'bi-box-arrow-right'} me-1"></i>
                                    ${f.tipo}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-info badge-status">Registrado</span>
                            </td>
                        </tr>
                    `).join('');
            }

            function actualizarHorario() {
                const contenedor = document.getElementById('info-horario');
                if (!contenedor) return;

                const horario = state.datos.horario;

                if (!horario) {
                    contenedor.innerHTML = `
                            <div class="text-center text-muted">
                                <i class="bi bi-calendar-x fs-1 d-block mb-2"></i>
                                No tienes un horario asignado actualmente
                            </div>
                        `;
                    return;
                }

                const turno = horario.turno;
                contenedor.innerHTML = `
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <h6 class="text-muted mb-1">Entrada</h6>
                                <h4 class="text-success">${turno.hora_entrada}</h4>
                            </div>
                            <div class="col-6 mb-3">
                                <h6 class="text-muted mb-1">Salida</h6>
                                <h4 class="text-danger">${turno.hora_salida}</h4>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-muted mb-2">Días Laborales:</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    ${getDiasLaborales(turno)}
                                </div>
                            </div>
                        </div>
                    `;
            }

            function actualizarNotificaciones() {
                const contenedor = document.getElementById('lista-notificaciones');
                if (!contenedor) return;

                const notificaciones = state.datos.notificaciones;

                if (!notificaciones || notificaciones.length === 0) {
                    contenedor.innerHTML = `
                            <div class="text-center text-muted">
                                <i class="bi bi-bell-slash fs-4 d-block mb-2"></i>
                                No hay notificaciones nuevas
                            </div>
                        `;
                    return;
                }

                contenedor.innerHTML = notificaciones.map(n => `
                        <div class="alert alert-light border d-flex align-items-center mb-2">
                            <i class="bi bi-bell text-warning me-3 fs-5"></i>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${n.titulo}</h6>
                                <p class="mb-1 small text-muted">${n.mensaje}</p>
                                <small class="text-muted">${new Date(n.fecha_envio).toLocaleDateString()}</small>
                            </div>
                            ${!n.leido ? '<span class="badge bg-warning">Nuevo</span>' : ''}
                        </div>
                    `).join('');
            }

            // ✅ CORRECCIÓN: Funciones del reloj con verificaciones
            function iniciarRelojJornada(horaInicio) {
                detenerRelojJornada();
                const [horas, minutos] = horaInicio.split(':');
                const inicio = new Date();
                inicio.setHours(parseInt(horas), parseInt(minutos), 0, 0);

                state.intervaloReloj = setInterval(() => {
                    const ahora = new Date();
                    const diferencia = ahora - inicio;
                    const horas = Math.floor(diferencia / (1000 * 60 * 60));
                    const minutos = Math.floor((diferencia % (1000 * 60 * 60)) / (1000 * 60));

                    safeUpdateElement('reloj-jornada',
                        `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`);
                }, 1000);
            }

            function detenerRelojJornada() {
                if (state.intervaloReloj) {
                    clearInterval(state.intervaloReloj);
                    state.intervaloReloj = null;
                }
            }

            // ✅ CORRECCIÓN: Registrar fichaje mejorado
            async function registrarFichaje(tipo) {
                try {
                    // Verificar si hay tarjetas RFID activas
                    const tarjetasRFID = state.datos.rfid;
                    const tarjetaActiva = tarjetasRFID.find(r => r.activo);

                    if (!tarjetaActiva) {
                        mostrarError('No tienes una tarjeta RFID activa asignada. Contacta con administración.');
                        return;
                    }

                    const response = await fetch('/api/fichajes/rfid', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            CodigoRFID: tarjetaActiva.codigo_rfid,
                            IP: 'dashboard-web'
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        mostrarExito(`Fichaje de ${tipo.toLowerCase()} registrado correctamente`);
                        await cargarDashboard(); // Recargar datos
                    } else {
                        const error = await response.json();
                        mostrarError(error.mensaje || 'Error al registrar el fichaje');
                    }
                } catch (error) {
                    console.error('Error registrando fichaje:', error);
                    mostrarError('Error de conexión al registrar el fichaje');
                }
            }

            // ✅ CORRECCIÓN: Funciones de utilidad seguras
            function safeUpdateElement(id, content) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = content;
                }
            }

            function setButtonState(id, disabled) {
                const button = document.getElementById(id);
                if (button) {
                    button.disabled = disabled;
                }
            }

            function updateProgressBar(id, percentage) {
                const progressBar = document.getElementById(id);
                if (progressBar) {
                    progressBar.style.width = percentage + '%';
                }
            }

            function getDiasLaborales(turno) {
                const dias = [
                    { key: 'lunes', label: 'Lun' },
                    { key: 'martes', label: 'Mar' },
                    { key: 'miercoles', label: 'Mié' },
                    { key: 'jueves', label: 'Jue' },
                    { key: 'viernes', label: 'Vie' },
                    { key: 'sabado', label: 'Sáb' },
                    { key: 'domingo', label: 'Dom' }
                ];

                return dias.map(dia =>
                    turno[dia.key] ?
                        `<span class="badge bg-primary">${dia.label}</span>` :
                        `<span class="badge bg-light text-muted">${dia.label}</span>`
                ).join('');
            }

            function getInicioMes() {
                const ahora = new Date();
                return new Date(ahora.getFullYear(), ahora.getMonth(), 1).toISOString().split('T')[0];
            }

            function getFinMes() {
                const ahora = new Date();
                return new Date(ahora.getFullYear(), ahora.getMonth() + 1, 0).toISOString().split('T')[0];
            }

            function actualizarTimestamp() {
                safeUpdateElement('ultima-actualizacion', new Date().toLocaleTimeString('es-ES'));
            }

            function actualizarHoraActual() {
                safeUpdateElement('hora-actual',
                    new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }));
            }

            function mostrarExito(mensaje) {
                mostrarNotificacion(mensaje, 'success');
            }

            function mostrarError(mensaje) {
                mostrarNotificacion(mensaje, 'danger');
            }

            function mostrarNotificacion(mensaje, tipo) {
                // Sistema de notificaciones simple
                const alertClass = tipo === 'success' ? 'alert-success' : 'alert-danger';
                const notification = document.createElement('div');
                notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
                notification.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="bi ${tipo === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle'} me-2"></i>
                            <span>${mensaje}</span>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                document.body.appendChild(notification);

                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }

            // ✅ CORRECCIÓN: Funciones públicas
            async function recargarDashboard() {
                await cargarDashboard();
                mostrarExito('Dashboard actualizado');
            }

            async function recargarFichajes() {
                if (!state.empleadoId) return;

                const fichajes = await apiCall(`/api/fichajes/empleado/${state.empleadoId}?fecha=${new Date().toISOString().split('T')[0]}`);
                if (fichajes) {
                    state.datos.fichajes = fichajes;
                    actualizarFichajesHoy();
                    actualizarEstadoJornada();
                    mostrarExito('Fichajes actualizados');
                }
            }

            // ✅ CORRECCIÓN: Inicialización segura
            async function init() {
                // Iniciar actualización de hora actual
                state.intervaloHora = setInterval(actualizarHoraActual, 1000);
                actualizarHoraActual();

                // Cargar dashboard
                await cargarDashboard();

                // Auto-actualización cada 30 segundos
                state.intervaloActualizacion = setInterval(() => {
                    cargarDashboard();
                }, 30000);
            }

            // ✅ CORRECCIÓN: Limpieza de intervalos
            function cleanup() {
                if (state.intervaloReloj) clearInterval(state.intervaloReloj);
                if (state.intervaloActualizacion) clearInterval(state.intervaloActualizacion);
                if (state.intervaloHora) clearInterval(state.intervaloHora);
            }

            // Iniciar cuando esté listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }

            // Limpiar al salir
            window.addEventListener('beforeunload', cleanup);

            return {
                init,
                recargarDashboard,
                recargarFichajes,
                registrarFichaje,
                cleanup
            };
        })();
    </script>
</body>
</html>