<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="bi bi-speedometer2 text-primary"></i>
                Mi Panel Personal
            </h2>
            <p class="text-muted" id="saludo-usuario">Bienvenido al sistema de control de asistencia FiExpress</p>
        </div>
    </div>

    <!-- Tarjetas de Estadísticas Personales -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-start border-primary border-4 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Fichajes Hoy</h6>
                            <h3 class="mb-0" id="mis-fichajes-hoy">0</h3>
                            <small class="text-muted" id="estado-hoy">-</small>
                        </div>
                        <div class="text-primary fs-1">
                            <i class="bi bi-clock-history"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-start border-success border-4 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Horas Trabajadas</h6>
                            <h3 class="mb-0 text-success" id="horas-trabajadas">0h</h3>
                            <small class="text-muted">Esta semana</small>
                        </div>
                        <div class="text-success fs-1">
                            <i class="bi bi-graph-up"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-start border-warning border-4 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Notificaciones</h6>
                            <h3 class="mb-0 text-warning" id="notificaciones-pendientes">0</h3>
                            <small class="text-muted">Sin leer</small>
                        </div>
                        <div class="text-warning fs-1">
                            <i class="bi bi-bell"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-start border-info border-4 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Mi Asistencia</h6>
                            <h3 class="mb-0 text-info" id="porcentaje-asistencia">0%</h3>
                            <small class="text-muted">Este mes</small>
                        </div>
                        <div class="text-info fs-1">
                            <i class="bi bi-calendar-check"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mi Estado Actual -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-person-badge"></i> Mi Estado Actual
                    </h5>
                    <span class="badge bg-success" id="estado-actual">Conectado</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="flex-shrink-0">
                                    <img src="" id="foto-perfil" class="rounded-circle" width="80" height="80"
                                         style="object-fit: cover;" onerror="this.src='https://ui-avatars.com/api/?name=Usuario&background=007bff&color=fff&size=80'">
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h5 id="nombre-completo">Cargando...</h5>
                                    <p class="text-muted mb-1" id="info-departamento">-</p>
                                    <p class="text-muted mb-0" id="info-codigo">-</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="border rounded p-3">
                                        <i class="bi bi-clock-history fs-4 text-primary mb-2"></i>
                                        <h6>Última Entrada</h6>
                                        <p class="mb-0 fw-bold" id="ultima-entrada">--:--</p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="border rounded p-3">
                                        <i class="bi bi-door-closed fs-4 text-danger mb-2"></i>
                                        <h6>Última Salida</h6>
                                        <p class="mb-0 fw-bold" id="ultima-salida">--:--</p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="border rounded p-3">
                                        <i class="bi bi-calendar-week fs-4 text-success mb-2"></i>
                                        <h6>Horario Actual</h6>
                                        <p class="mb-0 fw-bold" id="horario-actual">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Accesos Rápidos -->
    <div class="row mb-4">
        <div class="col-12">
            <h5 class="mb-3">Accesos Rápidos</h5>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-graph-up fs-1 text-primary mb-3"></i>
                    <h5>Mis Estadísticas</h5>
                    <p class="text-muted">Consulta tu rendimiento y asistencia</p>
                    <button class="btn btn-primary" onclick="window.cargarVista('estadisticas-personales', 'Mis Estadísticas')">
                        Ver Estadísticas
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-bell fs-1 text-warning mb-3"></i>
                    <h5>Mis Notificaciones</h5>
                    <p class="text-muted">Revisa mensajes importantes</p>
                    <button class="btn btn-warning" onclick="window.cargarVista('notificaciones-empleado', 'Mis Notificaciones')">
                        Ver Notificaciones
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-file-text fs-1 text-info mb-3"></i>
                    <h5>Solicitar Permiso</h5>
                    <p class="text-muted">Gestiona tus ausencias y permisos</p>
                    <button class="btn btn-info" onclick="window.cargarVista('permisos-empleado', 'Mis Permisos')">
                        Gestionar Permisos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mis Últimos Fichajes -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clock"></i> Mis Últimos Fichajes
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="window.cargarVista('estadisticas-personales', 'Mis Estadísticas')">
                        Ver Todos
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Entrada</th>
                                    <th>Salida</th>
                                    <th>Horas Trabajadas</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="mis-ultimos-fichajes">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        <i class="bi bi-hourglass-split"></i> Cargando...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Estado del dashboard
    const dashboardState = {
        empleadoId: null,
        usuario: null
    };

    // Cargar datos del dashboard personal
    async function cargarDashboardEmpleado() {
        try {
            console.log('🔄 Iniciando carga del dashboard...');

            // Cargar información del usuario actual
            await cargarInformacionUsuario();

            if (!dashboardState.empleadoId) {
                console.error('❌ No se pudo obtener el ID del empleado');
                return;
            }

            console.log('👤 Empleado ID:', dashboardState.empleadoId);

            // Cargar datos secuencialmente para debugging
            await cargarFichajesHoy();
            await cargarNotificacionesPendientes();
            await cargarUltimosFichajes();
            await cargarHorarioActual();

            // Las estadísticas las cargamos por separado ya que pueden fallar
            await cargarEstadisticasPersonales();

            console.log('✅ Dashboard cargado completamente');

        } catch (error) {
            console.error('❌ Error al cargar dashboard:', error);
            mostrarErrorDashboard('Error al cargar la información del dashboard');
        }
    }

    async function cargarInformacionUsuario() {
        try {
            dashboardState.usuario = window.app.usuario;

            if (dashboardState.usuario) {
                // ✅ CORREGIDO: Usar idEmpleado en lugar de id
                dashboardState.empleadoId = dashboardState.usuario.idEmpleado || dashboardState.usuario.id;

                console.log('📋 Información usuario:', dashboardState.usuario);

                // Actualizar UI con información del usuario
                document.getElementById('saludo-usuario').textContent =
                    `Bienvenido/a ${dashboardState.usuario.nombre} al sistema de control de asistencia FiExpress`;
                document.getElementById('nombre-completo').textContent = dashboardState.usuario.nombre;
                document.getElementById('info-departamento').textContent = dashboardState.usuario.departamento || 'Sin departamento';
                document.getElementById('info-codigo').textContent = `Código: ${dashboardState.usuario.codigo_empleado || 'N/A'}`;

                // Foto de perfil
                if (dashboardState.usuario.foto_url) {
                    document.getElementById('foto-perfil').src = dashboardState.usuario.foto_url;
                }
            } else {
                console.error('❌ No hay información de usuario en window.app');
            }
        } catch (error) {
            console.error('❌ Error cargando información del usuario:', error);
        }
    }

    async function cargarFichajesHoy() {
        try {
            const hoy = new Date().toISOString().split('T')[0];
            console.log('📅 Cargando fichajes de hoy:', hoy);

            // ✅ CORREGIDO: Usar el endpoint correcto para fichajes de empleado específico
            const resp = await fetchAuth(`/api/fichajes/empleado/${dashboardState.empleadoId}?fecha=${hoy}`);

            console.log('📡 Response status:', resp.status);

            if (resp.ok) {
                const fichajes = await resp.json();
                console.log('📊 Fichajes de hoy:', fichajes);

                const fichajesHoy = Array.isArray(fichajes) ? fichajes : [];

                document.getElementById('mis-fichajes-hoy').textContent = fichajesHoy.length;

                // Determinar estado actual y últimas entradas/salidas
                let ultimaEntrada = null;
                let ultimaSalida = null;

                fichajesHoy.forEach(fichaje => {
                    if (fichaje.tipo === 'Entrada') {
                        ultimaEntrada = fichaje;
                    } else if (fichaje.tipo === 'Salida') {
                        ultimaSalida = fichaje;
                    }
                });

                // ✅ CORREGIDO: Mostrar horas correctamente
                if (ultimaEntrada) {
                    document.getElementById('ultima-entrada').textContent =
                        typeof ultimaEntrada.hora === 'string' ? ultimaEntrada.hora :
                            (ultimaEntrada.hora ? ultimaEntrada.hora.toString() : '--:--');
                }

                if (ultimaSalida) {
                    document.getElementById('ultima-salida').textContent =
                        typeof ultimaSalida.hora === 'string' ? ultimaSalida.hora :
                            (ultimaSalida.hora ? ultimaSalida.hora.toString() : '--:--');
                }

                // Determinar estado
                const ultimoFichaje = fichajesHoy[fichajesHoy.length - 1];
                if (ultimoFichaje) {
                    const estado = ultimoFichaje.tipo === 'Entrada' ? 'Dentro de la empresa' : 'Fuera de la empresa';
                    document.getElementById('estado-hoy').textContent = estado;
                    document.getElementById('estado-actual').textContent = estado;
                } else {
                    document.getElementById('estado-hoy').textContent = 'Sin fichajes hoy';
                    document.getElementById('estado-actual').textContent = 'Sin actividad';
                }

            } else {
                console.error('❌ Error en respuesta de fichajes:', resp.status);
            }
        } catch (error) {
            console.error('❌ Error cargando fichajes de hoy:', error);
        }
    }

    async function cargarNotificacionesPendientes() {
        try {
            const resp = await fetchAuth('/api/notificaciones/mis-notificaciones?soloNoLeidas=true');
            if (resp.ok) {
                const notificaciones = await resp.json();
                document.getElementById('notificaciones-pendientes').textContent = notificaciones.length;
            }
        } catch (error) {
            console.error('Error cargando notificaciones:', error);
        }
    }

    async function cargarEstadisticasPersonales() {
        try {
            console.log('📈 Cargando estadísticas personales...');

            // Cargar estadísticas de esta semana
            const hoy = new Date();
            const inicioSemana = new Date(hoy);
            inicioSemana.setDate(hoy.getDate() - 7); // Últimos 7 días para asegurar datos

            const fechaInicio = inicioSemana.toISOString().split('T')[0];
            const fechaFin = hoy.toISOString().split('T')[0];

            console.log('📅 Rango fechas:', fechaInicio, 'a', fechaFin);

            const resp = await fetchAuth(`/api/estadisticas/empleado/${dashboardState.empleadoId}?inicio=${fechaInicio}&fin=${fechaFin}`);

            console.log('📡 Response estadísticas:', resp.status);

            if (resp.ok) {
                const data = await resp.json();
                console.log('📊 Datos estadísticas:', data);

                // ✅ CORREGIDO: Usar la estructura correcta de la respuesta
                if (data.resumen) {
                    const totalMinutos = data.resumen.totalHorasTrabajadas * 60 || 0; // Convertir horas a minutos
                    const horas = Math.floor(totalMinutos / 60);
                    document.getElementById('horas-trabajadas').textContent = `${horas}h`;

                    const porcentaje = data.resumen.porcentajeAsistencia || 0;
                    document.getElementById('porcentaje-asistencia').textContent = `${porcentaje}%`;
                } else {
                    // Si no hay resumen, calcular manualmente
                    calcularEstadisticasManuales();
                }
            } else {
                console.warn('⚠️ No se pudieron cargar estadísticas, calculando manualmente...');
                calcularEstadisticasManuales();
            }
        } catch (error) {
            console.error('❌ Error cargando estadísticas personales:', error);
            calcularEstadisticasManuales();
        }
    }

    async function calcularEstadisticasManuales() {
        try {
            // Calcular horas trabajadas manualmente con los últimos fichajes
            const resp = await fetchAuth(`/api/fichajes/empleado/${dashboardState.empleadoId}?limit=20`);
            if (resp.ok) {
                const fichajes = await resp.json();

                // Calcular horas de los últimos 7 días
                const ultimaSemana = new Date();
                ultimaSemana.setDate(ultimaSemana.getDate() - 7);

                let totalMinutos = 0;
                let diasConAsistencia = 0;
                let totalDias = 7;

                // Agrupar fichajes por fecha
                const fichajesPorFecha = {};
                fichajes.forEach(f => {
                    const fecha = f.fecha;
                    if (!fichajesPorFecha[fecha]) {
                        fichajesPorFecha[fecha] = { entrada: null, salida: null };
                    }

                    if (f.tipo === 'Entrada') {
                        fichajesPorFecha[fecha].entrada = f.hora;
                    } else if (f.tipo === 'Salida') {
                        fichajesPorFecha[fecha].salida = f.hora;
                    }
                });

                // Calcular horas trabajadas
                Object.values(fichajesPorFecha).forEach(dia => {
                    if (dia.entrada && dia.salida) {
                        const minutos = calcularMinutosTrabajados(dia.entrada, dia.salida);
                        totalMinutos += minutos;
                        diasConAsistencia++;
                    }
                });

                const horas = Math.floor(totalMinutos / 60);
                const porcentaje = Math.round((diasConAsistencia / totalDias) * 100);

                document.getElementById('horas-trabajadas').textContent = `${horas}h`;
                document.getElementById('porcentaje-asistencia').textContent = `${porcentaje}%`;
            }
        } catch (error) {
            console.error('Error cálculo manual:', error);
            document.getElementById('horas-trabajadas').textContent = '0h';
            document.getElementById('porcentaje-asistencia').textContent = '0%';
        }
    }

    function calcularMinutosTrabajados(entrada, salida) {
        try {
            const [hEnt, mEnt] = entrada.split(':').map(Number);
            const [hSal, mSal] = salida.split(':').map(Number);

            return (hSal * 60 + mSal) - (hEnt * 60 + mEnt);
        } catch (error) {
            return 0;
        }
    }

    async function cargarUltimosFichajes() {
        try {
            console.log('🕒 Cargando últimos fichajes...');
            const resp = await fetchAuth(`/api/fichajes/empleado/${dashboardState.empleadoId}`);

            console.log('📡 Response últimos fichajes:', resp.status);

            if (resp.ok) {
                const todosFichajes = await resp.json();
                console.log('📊 Todos los fichajes:', todosFichajes);
                mostrarMisUltimosFichajes(todosFichajes);
            } else {
                console.error('❌ Error cargando últimos fichajes:', resp.status);
            }
        } catch (error) {
            console.error('❌ Error cargando últimos fichajes:', error);
        }
    }

    async function cargarHorarioActual() {
        try {
            const resp = await fetchAuth(`/api/horarios/activo/empleado/${dashboardState.empleadoId}`);
            if (resp.ok) {
                const horario = await resp.json();
                console.log('🕐 Horario actual:', horario);

                const turno = horario.turno;
                if (turno) {
                    // ✅ CORREGIDO: Formatear correctamente las horas
                    const horaEntrada = typeof turno.hora_entrada === 'string' ?
                        turno.hora_entrada :
                        (turno.hora_entrada ? turno.hora_entrada.toString() : '--:--');

                    const horaSalida = typeof turno.hora_salida === 'string' ?
                        turno.hora_salida :
                        (turno.hora_salida ? turno.hora_salida.toString() : '--:--');

                    document.getElementById('horario-actual').textContent =
                        `${horaEntrada} - ${horaSalida}`;
                } else {
                    document.getElementById('horario-actual').textContent = 'No asignado';
                }
            } else {
                document.getElementById('horario-actual').textContent = 'No asignado';
            }
        } catch (error) {
            console.error('Error cargando horario actual:', error);
            document.getElementById('horario-actual').textContent = 'No asignado';
        }
    }

    function mostrarMisUltimosFichajes(fichajes) {
        const tbody = document.getElementById('mis-ultimos-fichajes');

        if (!fichajes || fichajes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay fichajes registrados</td></tr>';
            return;
        }

        console.log('🎨 Renderizando fichajes:', fichajes);

        // Agrupar fichajes por fecha
        const fichajesPorFecha = {};
        fichajes.forEach(f => {
            const fecha = f.fecha;
            if (!fichajesPorFecha[fecha]) {
                fichajesPorFecha[fecha] = { entrada: null, salida: null };
            }

            if (f.tipo === 'Entrada') {
                fichajesPorFecha[fecha].entrada = f.hora;
            } else if (f.tipo === 'Salida') {
                fichajesPorFecha[fecha].salida = f.hora;
            }
        });

        // Convertir a array y ordenar por fecha (más reciente primero)
        const dias = Object.entries(fichajesPorFecha)
            .map(([fecha, datos]) => ({ fecha, ...datos }))
            .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
            .slice(0, 5); // Últimos 5 días

        console.log('📅 Días agrupados:', dias);

        tbody.innerHTML = dias.map(dia => {
            const horasTrabajadas = calcularHorasTrabajadas(dia.entrada, dia.salida);
            const estado = determinarEstadoDia(dia.entrada, dia.salida);

            return `
                <tr>
                    <td>${new Date(dia.fecha).toLocaleDateString('es-ES')}</td>
                    <td><span class="badge bg-success">${dia.entrada || '--:--'}</span></td>
                    <td><span class="badge bg-danger">${dia.salida || '--:--'}</span></td>
                    <td>${horasTrabajadas}</td>
                    <td><span class="badge ${estado.clase}">${estado.texto}</span></td>
                </tr>
            `;
        }).join('');
    }

    function calcularHorasTrabajadas(entrada, salida) {
        if (!entrada || !salida) return '--:--';

        try {
            const minutos = calcularMinutosTrabajados(entrada, salida);
            const horas = Math.floor(minutos / 60);
            const minutosRestantes = minutos % 60;

            return `${horas}h ${minutosRestantes}m`;
        } catch (error) {
            return '--:--';
        }
    }

    function determinarEstadoDia(entrada, salida) {
        if (!entrada) return { clase: 'bg-danger', texto: 'Ausente' };
        if (!salida) return { clase: 'bg-warning', texto: 'Activo' };
        return { clase: 'bg-success', texto: 'Completo' };
    }

    function mostrarErrorDashboard(mensaje) {
        const tbody = document.getElementById('mis-ultimos-fichajes');
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">${mensaje}</td></tr>`;
    }

    // Cargar dashboard cuando se muestre la vista
    document.addEventListener('DOMContentLoaded', cargarDashboardEmpleado);

    // También recargar cuando se vuelva a esta vista
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', cargarDashboardEmpleado);
    } else {
        cargarDashboardEmpleado();
    }
</script>