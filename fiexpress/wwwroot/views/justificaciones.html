<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="bi bi-file-earmark-text text-primary"></i> Gestión de Justificaciones
            </h2>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Buscar empleado</label>
                    <input type="text" class="form-control" id="filtro-empleado" placeholder="Nombre o código">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Estado</label>
                    <select class="form-select" id="filtro-estado">
                        <option value="">Todos</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Aprobado">Aprobado</option>
                        <option value="Rechazado">Rechazado</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Desde</label>
                    <input type="date" class="form-control" id="filtro-desde">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Hasta</label>
                    <input type="date" class="form-control" id="filtro-hasta">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button class="btn btn-outline-secondary w-100" onclick="JustificacionesSupervisorModule.aplicarFiltros()">
                        <i class="bi bi-funnel"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#pendientes">Pendientes</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#historial">Historial</button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="pendientes">
            <div id="lista-pendientes" class="row g-3">
                <div class="col-12 text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="historial">
            <div id="lista-historial" class="row g-3">
                <div class="col-12 text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    window.JustificacionesSupervisorModule = (function () {
        let pendientes = [];
        let historial = [];

        async function cargarPendientes() {
            try {
                const res = await fetchAuth('/api/justificaciones/pending');
                pendientes = await res.json();
                renderizarPendientes(pendientes);
            } catch (error) {
                document.getElementById('lista-pendientes').innerHTML = `<div class="col-12"><div class="alert alert-danger">Error</div></div>`;
            }
        }

        async function cargarHistorial() {
            try {
                const res = await fetchAuth('/api/justificaciones/historial');
                historial = await res.json();
                renderizarHistorial(historial);
            } catch (error) {
                document.getElementById('lista-historial').innerHTML = `<div class="col-12"><div class="alert alert-danger">Error</div></div>`;
            }
        }

        function aplicarFiltros() {
            const texto = document.getElementById('filtro-empleado').value.toLowerCase();
            const estado = document.getElementById('filtro-estado').value;
            const desde = document.getElementById('filtro-desde').value;
            const hasta = document.getElementById('filtro-hasta').value;

            let filtradosPendientes = pendientes.filter(j => {
                const matchEmpleado = j.empleado.nombre.toLowerCase().includes(texto) ||
                    j.empleado.codigo_empleado.toLowerCase().includes(texto);
                return matchEmpleado;
            });
            renderizarPendientes(filtradosPendientes);

            let filtradosHistorial = historial.filter(j => {
                const matchEmpleado = j.empleado.nombre.toLowerCase().includes(texto) ||
                    j.empleado.codigo_empleado.toLowerCase().includes(texto);
                const matchEstado = !estado || j.estado === estado;
                return matchEmpleado && matchEstado;
            });
            renderizarHistorial(filtradosHistorial);
        }

        function renderizarPendientes(justificaciones) {
            const container = document.getElementById('lista-pendientes');
            if (justificaciones.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">No hay justificaciones pendientes</div></div>';
                return;
            }

            container.innerHTML = justificaciones.map(j => `
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h6>${j.empleado.nombre} (${j.empleado.codigo_empleado})</h6>
                        <p class="text-muted mb-1">${j.motivo}</p>
                        <small class="text-muted">
                            <i class="bi bi-building"></i> ${j.empleado.departamento}
                        </small>
                        ${j.documento_url ? `<br><a href="${j.documento_url}" target="_blank" class="text-primary">Ver documento</a>` : ''}
                        <div class="mt-3">
                            <button class="btn btn-success btn-sm me-2" onclick="JustificacionesSupervisorModule.aprobar(${j.idJustificacion})">
                                <i class="bi bi-check"></i> Aprobar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="JustificacionesSupervisorModule.rechazar(${j.idJustificacion})">
                                <i class="bi bi-x"></i> Rechazar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        }

        function renderizarHistorial(justificaciones) {
            const container = document.getElementById('lista-historial');
            if (justificaciones.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">No hay historial</div></div>';
                return;
            }

            container.innerHTML = justificaciones.map(j => `
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h6>${j.empleado.nombre}</h6>
                            <span class="badge ${j.estado === 'Aprobado' ? 'bg-success' : 'bg-danger'}">${j.estado}</span>
                        </div>
                        <p class="text-muted mb-1">${j.motivo}</p>
                        <small class="text-muted">
                            <i class="bi bi-building"></i> ${j.empleado.departamento} |
                            <i class="bi bi-person"></i> ${j.supervisor || 'N/A'}
                        </small>
                        ${j.documento_url ? `<br><a href="${j.documento_url}" target="_blank" class="text-primary">Ver documento</a>` : ''}
                    </div>
                </div>
            </div>
        `).join('');
        }

        async function aprobar(id) {
            if (!confirm('¿Aprobar esta justificación?')) return;
            try {
                await fetchAuth(`/api/justificaciones/${id}/aprobar`, { method: 'PUT' });
                alert('✅ Aprobado');
                cargarPendientes();
                cargarHistorial();
            } catch (error) {
                alert('❌ Error al aprobar');
            }
        }

        async function rechazar(id) {
            if (!confirm('¿Rechazar esta justificación?')) return;
            try {
                await fetchAuth(`/api/justificaciones/${id}/rechazar`, { method: 'PUT' });
                alert('✅ Rechazado');
                cargarPendientes();
                cargarHistorial();
            } catch (error) {
                alert('❌ Error al rechazar');
            }
        }

        // Inicializar
        cargarPendientes();
        cargarHistorial();

        return {
            aprobar,
            rechazar,
            aplicarFiltros
        };
    })();
</script>