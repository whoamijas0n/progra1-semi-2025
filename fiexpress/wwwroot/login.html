<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FiExpress - Iniciar Sesión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* === NUEVA PALETA DE COLORES PERSONALIZADA === */
        .bg-gradient-brand {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
        }

        .text-brand {
            color: #2c5364;
        }

        .bg-brand {
            background-color: #2c5364;
        }

        .bg-brand-dark {
            background-color: #203a43;
        }

        .border-brand {
            border-color: #2c5364;
        }

        .ring-brand:focus {
            --tw-ring-color: #2c5364;
        }

        /* Animaciones decorativas */
        @keyframes scan {
            0% {
                top: 0;
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0.5;
            }
        }

        .animate-scan {
            animation: scan 1.5s linear infinite;
        }

        @keyframes blob {
            0% {
                transform: translate(0px, 0px) scale(1);
            }

            33% {
                transform: translate(30px, -50px) scale(1.1);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }

            100% {
                transform: translate(0px, 0px) scale(1);
            }
        }

        .animate-blob {
            animation: blob 7s infinite;
        }

        .animation-delay-2000 {
            animation-delay: 2s;
        }

        @keyframes shake {
            0%, 100% {
                transform: translateX(0);
            }

            10%, 30%, 50%, 70%, 90% {
                transform: translateX(-5px);
            }

            20%, 40%, 60%, 80% {
                transform: translateX(5px);
            }
        }

        .shake-animation {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* Perspectiva y Clases de Estado */
        .perspective-1000 {
            perspective: 1000px;
        }

        .card-typing {
            transform: scale(1.1) translateX(20px) rotateY(-12deg) !important;
            transition: all 0.5s ease-in-out;
            right: 25% !important;
        }

        .card-validating {
            transform: scale(0.9) translateX(0) translateY(50px) rotateX(12deg) !important;
            transition: all 0.5s ease-in-out;
            top: 28% !important;
            z-index: 50 !important; /* Máxima prioridad al validar */
        }

        .card-success {
            transform: translateX(1000px) rotate(12deg) !important;
            opacity: 0;
            transition: all 0.7s ease-in-out;
        }

        .card-error {
            transform: translateX(0) translateY(0) rotate(0) !important;
            transition: all 0.3s ease-in-out;
        }

        /* Animación suave para la alerta al aparecer */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-50 overflow-hidden">

    <div class="min-h-screen w-full flex">

        <!-- SECCIÓN IZQUIERDA: FORMULARIO -->
        <div class="w-full lg:w-1/2 flex flex-col justify-center px-8 md:px-16 lg:px-24 relative z-10 bg-white shadow-2xl lg:shadow-none">

            <div class="max-w-md w-full mx-auto">
                <div class="mb-8 text-center lg:text-left" style="text-align:center;">
                  
                    <h2 class="text-3xl font-bold text-slate-800">FiExpress</h2>
                    <p class="text-slate-500 mt-2">Sistema de Control de Asistencia</p>
                </div>

                <div id="alert-container" class="mb-4"></div>

                <form id="login-form" class="space-y-6">

                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <!-- Icono cambia a color marca al enfocar -->
                            <i class="bi bi-person-fill text-gray-400 group-focus-within:text-brand transition-colors text-xl"></i>
                        </div>
                        <input type="text" id="username" required
                               class="block w-full pl-10 pr-3 py-4 border border-gray-200 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:ring-2 ring-brand focus:border-transparent transition-all duration-300"
                               placeholder="Usuario">
                        <label for="username" class="absolute -top-2 left-2 bg-white px-1 text-xs text-brand font-semibold hidden group-focus-within:block">Usuario</label>
                    </div>

                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="bi bi-lock-fill text-gray-400 group-focus-within:text-brand transition-colors text-xl"></i>
                        </div>
                        <input type="password" id="password" required
                               class="block w-full pl-10 pr-3 py-4 border border-gray-200 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:ring-2 ring-brand focus:border-transparent transition-all duration-300"
                               placeholder="Contraseña">
                        <label for="password" class="absolute -top-2 left-2 bg-white px-1 text-xs text-brand font-semibold hidden group-focus-within:block">Contraseña</label>
                    </div>

                    <button type="submit" id="btn-login"
                            class="w-full flex justify-center py-4 px-4 border border-transparent text-sm font-bold rounded-xl text-white bg-brand hover:bg-brand-dark focus:outline-none focus:ring-2 focus:ring-offset-2 ring-brand transition-all duration-300 transform hover:scale-[1.02] shadow-lg shadow-slate-400">

                        <span id="login-text" class="flex items-center gap-2">
                            Iniciar Sesión <i class="bi bi-arrow-right"></i>
                        </span>

                        <div id="login-spinner" class="hidden flex items-center gap-2">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Validando...</span>
                        </div>
                        <span id="login-success-text" class="hidden flex items-center gap-2"><i class="bi bi-check-circle-fill"></i> Acceso Concedido</span>
                        <span id="login-error-text" class="hidden flex items-center gap-2"><i class="bi bi-x-circle-fill"></i> Error</span>
                    </button>
                </form>
            </div>

            <div class="mt-8 text-center text-xs text-gray-400">
                &copy; 2025 FiExpress System. Secure Login.
            </div>
        </div>

        <!-- SECCIÓN DERECHA: ANIMACIÓN 3D -->
        <div class="hidden lg:flex w-1/2 relative items-center justify-center perspective-1000 overflow-hidden bg-gradient-brand">

            <!-- Elementos decorativos de fondo ajustados a la nueva paleta -->
            <div class="absolute w-[500px] h-[500px] bg-[#2c5364] rounded-full mix-blend-overlay filter blur-[100px] opacity-30 animate-blob top-0 right-0"></div>
            <div class="absolute w-[500px] h-[500px] bg-[#0f2027] rounded-full mix-blend-multiply filter blur-[100px] opacity-40 animate-blob animation-delay-2000 bottom-0 left-0"></div>

            <div class="relative w-full h-full flex items-center justify-center perspective-1000">

                <!-- 1. EL LECTOR -->
                <!-- z-0 para que quede al fondo -->
                <div id="reader-device" class="relative z-0 w-64 h-96 bg-slate-800 rounded-3xl shadow-2xl border border-slate-700 flex flex-col items-center justify-between p-6 transition-all duration-300">
                    <div class="w-full h-32 bg-black rounded-lg border border-slate-600 relative overflow-hidden flex items-center justify-center">
                        <div id="screen-bg" class="absolute inset-0 bg-[#2c5364] opacity-20 transition-colors duration-500"></div>

                        <!-- Texto de pantalla: z-10 (menor que la tarjeta) -->
                        <div class="relative z-10 text-center font-mono font-bold">
                            <span id="screen-text" class="text-[#2c5364] text-sm animate-pulse">ESPERANDO...</span>
                        </div>

                        <div id="scan-line" class="absolute top-0 left-0 w-full h-1 bg-[#2c5364] shadow-[0_0_10px_rgba(44,83,100,0.8)] hidden"></div>
                    </div>

                    <div class="w-40 h-40 rounded-full bg-slate-700 border-4 border-slate-600 flex items-center justify-center relative">
                        <div id="led-ring" class="absolute inset-0 rounded-full border-4 border-slate-600 transition-all duration-500 blur-[2px]"></div>
                        <i class="bi bi-wifi text-5xl text-slate-500"></i>
                    </div>

                    <div class="text-slate-600 text-xs font-bold tracking-widest">SECURE ACCESS</div>
                </div>

                <!-- 2. LA TARJETA -->
                <!-- z-20 AQUI ASEGURA QUE SIEMPRE ESTÉ SOBRE EL LECTOR Y SU TEXTO -->
                <div id="employee-card" class="absolute z-20 w-56 h-80 bg-white rounded-2xl shadow-xl overflow-hidden border-t border-white/50"
                     style="right: 15%; transform-style: preserve-3d;">

                    <div class="h-full w-full relative flex flex-col">
                        <!-- Header de tarjeta con el color de la marca -->
                        <div class="h-24 bg-brand p-4 flex justify-between items-start">
                            <div class="w-3 h-3 rounded-full bg-white/50"></div>
                            <div class="text-white/80 text-[10px] font-mono">ID: EMP-2025</div>
                        </div>
                        <div class="absolute top-12 left-1/2 transform -translate-x-1/2 w-24 h-24 bg-gray-200 rounded-lg border-4 border-white shadow-sm overflow-hidden flex items-center justify-center">
                            <i class="bi bi-person-bounding-box text-5xl text-gray-400"></i>
                        </div>
                        <div class="mt-16 flex-1 p-4 text-center space-y-3">
                            <div class="h-4 w-32 bg-gray-200 rounded mx-auto"></div>
                            <div class="h-3 w-20 bg-gray-100 rounded mx-auto"></div>
                            <div class="pt-4 space-y-2 opacity-50">
                                <div class="h-2 w-full bg-gray-100 rounded"></div>
                                <div class="h-2 w-full bg-gray-100 rounded"></div>
                            </div>
                        </div>
                        <div class="h-12 bg-white border-t border-gray-100 flex items-center justify-center gap-1 px-4 opacity-50">
                            <div class="w-full h-4 bg-black/80" style="clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%, 10% 50%, 0 0);"></div>
                        </div>
                    </div>
                    <!-- Brillo -->
                    <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/20 to-transparent pointer-events-none"></div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const card = document.getElementById('employee-card');
        const reader = document.getElementById('reader-device');
        const screenText = document.getElementById('screen-text');
        const screenBg = document.getElementById('screen-bg');
        const ledRing = document.getElementById('led-ring');
        const scanLine = document.getElementById('scan-line');
        const inputs = document.querySelectorAll('input');

        let currentState = 'idle';

        // Parallax Mouse Move
        document.addEventListener('mousemove', (e) => {
            if (currentState === 'idle' || currentState === 'typing') {
                const x = (window.innerWidth - e.pageX) / 50;
                const y = (window.innerHeight - e.pageY) / 50;
                if (currentState === 'idle') {
                    card.style.transform = `rotateY(${x}deg) rotateX(${y}deg) translateZ(20px)`;
                }
            }
        });

        inputs.forEach(input => {
            input.addEventListener('focus', () => {
                if (currentState !== 'validating') setVisualState('typing');
            });
            input.addEventListener('blur', () => {
                const user = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                if (user === '' && pass === '' && currentState !== 'validating') setVisualState('idle');
            });
        });

        function setVisualState(state) {
            currentState = state;

            // RESETEAMOS LAS CLASES
            card.className = `absolute z-20 w-56 h-80 bg-white rounded-2xl shadow-xl overflow-hidden border-t border-white/50`;
            reader.classList.remove('shake-animation');
            scanLine.classList.add('hidden');
            scanLine.classList.remove('animate-scan');

            if (state === 'idle') {
                card.style.right = '15%';
                screenText.innerText = "ESPERANDO...";
                // Texto color brand
                screenText.className = "text-[#2c5364] text-sm animate-pulse";
                screenBg.className = "absolute inset-0 bg-[#2c5364] opacity-20 transition-colors duration-500";
                ledRing.className = "absolute inset-0 rounded-full border-4 border-slate-600 blur-[2px]";
            }
            else if (state === 'typing') {
                card.classList.add('card-typing');
                screenText.innerText = "LISTO...";
                screenText.className = "text-yellow-400 text-sm";
                ledRing.className = "absolute inset-0 rounded-full border-4 border-yellow-500 blur-[2px] opacity-50";
            }
            else if (state === 'validating') {
                card.classList.add('card-validating');
                screenText.innerText = "LEYENDO...";
                screenText.className = "text-white text-sm font-bold";
                scanLine.classList.remove('hidden');
                scanLine.classList.add('animate-scan');
                // Usamos el color intermedio para validar
                ledRing.className = "absolute inset-0 rounded-full border-4 border-[#2c5364] shadow-[0_0_15px_rgba(44,83,100,0.4)] blur-[2px]";
            }
            else if (state === 'success') {
                card.classList.add('card-success');
                screenText.innerText = "BIENVENIDO";
                screenText.className = "text-green-400 text-sm font-bold";
                screenBg.className = "absolute inset-0 bg-green-500 opacity-30";
                ledRing.className = "absolute inset-0 rounded-full border-4 border-green-500 shadow-[0_0_20px_rgba(34,197,94,0.6)] blur-[2px]";
            }
            else if (state === 'error') {
                card.classList.add('card-error');
                reader.classList.add('shake-animation');
                screenText.innerText = "DENEGADO";
                screenText.className = "text-red-400 text-sm font-bold";
                screenBg.className = "absolute inset-0 bg-red-500 opacity-30";
                ledRing.className = "absolute inset-0 rounded-full border-4 border-red-500 shadow-[0_0_20px_rgba(239,68,68,0.6)] blur-[2px]";
            }
        }

        // LÓGICA DE LOGIN
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            const btn = document.getElementById('btn-login');
            const btnText = document.getElementById('login-text');
            const btnSpinner = document.getElementById('login-spinner');
            const btnSuccess = document.getElementById('login-success-text');
            const btnError = document.getElementById('login-error-text');

            btn.disabled = true;
            btnText.classList.add('hidden');
            btnSuccess.classList.add('hidden');
            btnError.classList.add('hidden');
            btnSpinner.classList.remove('hidden');

            setVisualState('validating');

            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, rememberMe: false }),
                    credentials: 'include'
                });

                const data = await res.json();

                if (res.ok) {
                    setVisualState('success');
                    btnSpinner.classList.add('hidden');
                    btnSuccess.classList.remove('hidden');
                    btn.classList.remove('bg-brand', 'hover:bg-brand-dark');
                    btn.classList.add('bg-green-500', 'hover:bg-green-600');

                    setTimeout(() => {
                        const destino = (data.usuario.rol === 'Admin' || data.usuario.esSupervisor)
                            ? '/index.html'
                            : '/panel-empleado.html';
                        window.location.href = destino;
                    }, 1000);

                } else {
                    throw new Error(data.mensaje || 'Credenciales incorrectas');
                }
            } catch (error) {
                console.error('Error:', error);
                setVisualState('error');
                btnSpinner.classList.add('hidden');
                btnError.classList.remove('hidden');
                btn.classList.remove('bg-brand', 'hover:bg-brand-dark');
                btn.classList.add('bg-red-500', 'hover:bg-red-600');
                mostrarAlerta(error.message || 'Error de conexión', 'danger');

                setTimeout(() => {
                    resetButton();
                    setVisualState('idle');
                }, 2000);
            }
        });

        function resetButton() {
            const btn = document.getElementById('btn-login');
            btn.disabled = false;
            btn.classList.remove('bg-red-500', 'hover:bg-red-600', 'bg-green-500');
            btn.classList.add('bg-brand', 'hover:bg-brand-dark');
            document.getElementById('login-text').classList.remove('hidden');
            document.getElementById('login-spinner').classList.add('hidden');
            document.getElementById('login-error-text').classList.add('hidden');
            document.getElementById('login-success-text').classList.add('hidden');
        }

        function mostrarAlerta(mensaje, tipo) {
            const container = document.getElementById('alert-container');
            // Usamos color brand-dark para el borde si no es danger, para mantener tema
            const colorClass = tipo === 'danger'
                ? 'bg-red-50 text-red-700 border-red-200'
                : 'bg-slate-50 text-slate-700 border-slate-200';

            container.innerHTML = `
                    <div class="p-4 mb-4 text-sm border rounded-lg ${colorClass} flex justify-between items-center animate-fade-in" role="alert">
                        <span><i class="bi bi-exclamation-triangle-fill mr-2"></i>${mensaje}</span>
                        <button onclick="this.parentElement.remove()" class="font-bold text-lg">&times;</button>
                    </div>
                `;
        }
    </script>
</body>
</html>