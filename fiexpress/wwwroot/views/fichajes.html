<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="bi bi-clock-history text-primary"></i>
                Gestión de Fichajes
            </h2>
            <p class="text-muted">Vista en tiempo real de todos los fichajes del sistema</p>
        </div>
    </div>

    <!-- Tarjetas de Estadísticas -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <h6 class="text-muted">Total Fichajes</h6>
                    <h3 id="total-fichajes">0</h3>
                    <small class="text-muted" id="info-fichajes">Cargando...</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <h6 class="text-muted">Entradas</h6>
                    <h3 class="text-success" id="total-entradas">0</h3>
                    <small class="text-muted">Registros de entrada</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-danger border-4">
                <div class="card-body">
                    <h6 class="text-muted">Salidas</h6>
                    <h3 class="text-danger" id="total-salidas">0</h3>
                    <small class="text-muted">Registros de salida</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <h6 class="text-muted">Neto (Entradas - Salidas)</h6>
                    <h3 class="text-warning" id="empleados-neto">0</h3>
                    <small class="text-muted">Diferencia total</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Controles de Filtro -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Fecha</label>
                    <input type="date" class="form-control" id="filtro-fecha">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Empleado</label>
                    <select class="form-select" id="filtro-empleado">
                        <option value="">Todos los empleados</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" id="filtro-tipo">
                        <option value="">Todos</option>
                        <option value="Entrada">Entrada</option>
                        <option value="Salida">Salida</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button class="btn btn-primary" onclick="FichajesModule.cargarFichajes()">
                            <i class="bi bi-filter"></i> Filtrar
                        </button>
                        <button class="btn btn-outline-secondary" onclick="FichajesModule.limpiarFiltros()">
                            <i class="bi bi-x-circle"></i> Limpiar
                        </button>
                        <button class="btn btn-outline-primary" onclick="FichajesModule.cargarFichajes()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Fichajes -->
    <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-list-ul"></i> Registros de Fichajes
                <span class="badge bg-primary ms-2" id="contador-fichajes">0</span>
            </h5>
            <span class="text-muted small" id="ultima-actualizacion"></span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Empleado</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Tipo</th>
                            <th>IP</th>
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-fichajes">
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                Cargando fichajes...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    window.FichajesModule = (function () {
        'use strict';
        const state = { fichajes: [], empleados: [] };

        async function init() {
            // Inicializar fecha con la del cliente (solo como sugerencia visual)
            const hoy = new Date();
            const offset = hoy.getTimezoneOffset() * 60000;
            const hoyLocal = new Date(hoy.getTime() - offset);
            document.getElementById('filtro-fecha').value = hoyLocal.toISOString().split('T')[0];

            await cargarEmpleados();
            await cargarFichajes();
            setInterval(() => {
                if (!document.hidden) cargarFichajes();
            }, 30000);
        }

        async function cargarEmpleados() {
            try {
                const res = await fetchAuth('/api/empleados?incluirInactivos=false');
                const empleados = await res.json();
                const select = document.getElementById('filtro-empleado');
                select.innerHTML = '<option value="">Todos los empleados</option>';
                empleados.forEach(e => {
                    select.innerHTML += `<option value="${e.idEmpleado}">${e.nombre} (${e.codigo_empleado})</option>`;
                });
                state.empleados = empleados;
            } catch (err) {
                console.error('Error al cargar empleados:', err);
            }
        }

        async function cargarFichajes() {
            try {
                mostrarLoading();
                const params = new URLSearchParams();
                const fecha = document.getElementById('filtro-fecha').value;
                const emp = document.getElementById('filtro-empleado').value;
                const tipo = document.getElementById('filtro-tipo').value;

                if (fecha) params.append('fecha', fecha);
                if (emp) params.append('empleadoId', emp);
                if (tipo) params.append('tipo', tipo);

                const url = `/api/fichajes?${params.toString()}`;
                const res = await fetchAuth(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                state.fichajes = await res.json();
                renderizarFichajes();
                actualizarEstadisticas();
                actualizarTimestamp();
            } catch (err) {
                console.error('Error al cargar fichajes:', err);
                document.getElementById('tabla-fichajes').innerHTML = `
                <tr><td colspan="7" class="text-center text-danger py-4">
                    Error al cargar datos. Intente de nuevo.
                </td></tr>
            `;
            }
        }

        function renderizarFichajes() {
            const tbody = document.getElementById('tabla-fichajes');
            const contador = document.getElementById('contador-fichajes');
            contador.textContent = state.fichajes.length;

            if (state.fichajes.length === 0) {
                tbody.innerHTML = `
                <tr><td colspan="7" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    No hay fichajes con los filtros aplicados.
                </td></tr>
            `;
                return;
            }

            tbody.innerHTML = state.fichajes.map(f => `
            <tr>
                <td><strong>${f.empleado || 'N/A'}</strong></td>
                <td><span class="badge bg-light text-dark">${formatearFecha(f.fecha)}</span></td>
                <td><strong class="text-primary">${f.hora || 'N/A'}</strong></td>
                <td>
                    <span class="badge ${f.tipo === 'Entrada' ? 'bg-success' : 'bg-danger'}">
                        ${f.tipo}
                    </span>
                </td>
                <td><small class="text-muted">${f.ip || 'Local'}</small></td>
                <td><small class="text-muted">${f.observacion || '—'}</small></td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary" disabled>
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        }

        function actualizarEstadisticas() {
            const fichajes = state.fichajes;
            const entradas = fichajes.filter(f => f.tipo === 'Entrada').length;
            const salidas = fichajes.filter(f => f.tipo === 'Salida').length;

            document.getElementById('total-fichajes').textContent = fichajes.length;
            document.getElementById('total-entradas').textContent = entradas;
            document.getElementById('total-salidas').textContent = salidas;
            document.getElementById('empleados-neto').textContent = entradas - salidas;

            // Mostrar la fecha usada en el filtro (la que se envió al backend)
            let info = "Filtros aplicados";
            const fecha = document.getElementById('filtro-fecha').value;
            if (fecha) info = formatearFecha(fecha);
            const empId = document.getElementById('filtro-empleado').value;
            if (empId) {
                const emp = state.empleados.find(e => e.idEmpleado == empId);
                info += emp ? ` • ${emp.nombre}` : '';
            }
            if (document.getElementById('filtro-tipo').value) {
                info += ` • ${document.getElementById('filtro-tipo').value}`;
            }
            document.getElementById('info-fichajes').textContent = info;
        }

        function formatearFecha(fechaStr) {
            if (!fechaStr) return 'N/A';
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return new Date(fechaStr).toLocaleDateString('es-ES', options);
        }

        function actualizarTimestamp() {
            document.getElementById('ultima-actualizacion').textContent =
                'Actualizado: ' + new Date().toLocaleTimeString();
        }

        function mostrarLoading() {
            document.getElementById('tabla-fichajes').innerHTML = `
            <tr><td colspan="7" class="text-center text-muted py-4">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Cargando fichajes...
            </td></tr>
        `;
        }

        function limpiarFiltros() {
            const hoy = new Date();
            const offset = hoy.getTimezoneOffset() * 60000;
            const hoyLocal = new Date(hoy.getTime() - offset);
            document.getElementById('filtro-fecha').value = hoyLocal.toISOString().split('T')[0];
            document.getElementById('filtro-empleado').value = '';
            document.getElementById('filtro-tipo').value = '';
            cargarFichajes();
        }

        // Iniciar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        return {
            cargarFichajes,
            limpiarFiltros
        };
    })();
</script>