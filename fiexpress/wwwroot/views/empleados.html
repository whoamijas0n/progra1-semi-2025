<!-- views/empleados.html -->
<div class="container-fluid py-4" id="empleados-container">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="bi bi-person-badge text-primary"></i>
                Gestión de Empleados
            </h2>
        </div>
    </div>
    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <h6 class="text-muted">Total Empleados</h6>
                    <h3 id="stat-total">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <h6 class="text-muted">Activos</h6>
                    <h3 class="text-success" id="stat-activos">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <h6 class="text-muted">Inactivos</h6>
                    <h3 class="text-warning" id="stat-inactivos">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-info border-4">
                <div class="card-body">
                    <h6 class="text-muted">Con Usuario</h6>
                    <h3 class="text-info" id="stat-con-usuario">0</h3>
                </div>
            </div>
        </div>
    </div>
    <!-- Barra de búsqueda y acciones -->
    <div class="row mb-4">
        <div class="col-md-4">
            <input type="text" class="form-control" id="input-buscar" placeholder="🔍 Buscar por nombre, código o email...">
        </div>
        <div class="col-md-2">
            <select class="form-select" id="select-departamento">
                <option value="">Todos los departamentos</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="select-rol">
                <option value="">Todos los roles</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="select-estado">
                <option value="">Todos los estados</option>
                <option value="activo">Activos</option>
                <option value="inactivo">Inactivos</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="EmpleadosModule.abrirModalNuevo()">
                <i class="bi bi-plus-lg"></i> Nuevo Empleado
            </button>
        </div>
    </div>
    <!-- Lista de empleados -->
    <div class="row g-3" id="lista-empleados">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear/Editar Empleado -->
<div class="modal fade" id="modalEmpleado" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Nuevo Empleado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEmpleado">
                    <input type="hidden" id="empleadoId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Código Empleado *</label>
                            <input type="text" class="form-control" id="txtCodigoEmpleado" required maxlength="35">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre Completo *</label>
                            <input type="text" class="form-control" id="txtNombre" required maxlength="65">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" id="txtEmail" required maxlength="50">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono *</label>
                            <input type="text" class="form-control" id="txtTelefono" required maxlength="9">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha Nacimiento *</label>
                            <input type="date" class="form-control" id="txtFechaNacimiento" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha Ingreso *</label>
                            <input type="date" class="form-control" id="txtFechaIngreso" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Departamento *</label>
                            <select class="form-select" id="selDepartamento" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Rol *</label>
                            <select class="form-select" id="selRol" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Foto URL</label>
                            <input type="text" class="form-control" id="txtFotoUrl" maxlength="150">
                            <small class="text-muted">Opcional. Dejar vacío para usar avatar predeterminado.</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="EmpleadosModule.guardarEmpleado()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    window.EmpleadosModule = (function () {
        'use strict';
        const state = {
            empleados: [],
            departamentos: [],
            roles: [],
            modalInstance: null
        };

        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    credentials: 'include',
                    ...options
                });
                if (!response.ok) throw new Error(`Error ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function cargarEmpleados() {
            try {
                // ✅ Incluir empleados inactivos para verlos y reactivarlos
                const url = '/api/empleados?incluirInactivos=true';
                state.empleados = await apiCall(url);
                actualizarEstadisticas();
                renderizarEmpleados();
            } catch (error) {
                document.getElementById('lista-empleados').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">Error al cargar empleados</div>
                    </div>
                `;
            }
        }

        async function cargarCatalogos() {
            try {
                state.departamentos = await apiCall('/api/departamentos?incluirInactivos=false');
                state.roles = await apiCall('/api/roles?incluirInactivos=false');

                const deptoSelect = document.getElementById('selDepartamento');
                const deptoFiltro = document.getElementById('select-departamento');
                deptoSelect.innerHTML = '<option value="">Seleccione...</option>';
                deptoFiltro.innerHTML = '<option value="">Todos los departamentos</option>';
                state.departamentos.forEach(d => {
                    deptoSelect.innerHTML += `<option value="${d.idDepartamento}">${d.nombre}</option>`;
                    deptoFiltro.innerHTML += `<option value="${d.idDepartamento}">${d.nombre}</option>`;
                });

                const rolSelect = document.getElementById('selRol');
                const rolFiltro = document.getElementById('select-rol');
                rolSelect.innerHTML = '<option value="">Seleccione...</option>';
                rolFiltro.innerHTML = '<option value="">Todos los roles</option>';
                state.roles.forEach(r => {
                    rolSelect.innerHTML += `<option value="${r.idRol}">${r.nombre}</option>`;
                    rolFiltro.innerHTML += `<option value="${r.idRol}">${r.nombre}</option>`;
                });
            } catch (error) {
                console.error('Error al cargar catálogos:', error);
            }
        }

        function actualizarEstadisticas() {
            const total = state.empleados.length;
            const activos = state.empleados.filter(e => e.activo).length;
            const inactivos = total - activos;
            const conUsuario = state.empleados.filter(e => e.tieneUsuario).length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-activos').textContent = activos;
            document.getElementById('stat-inactivos').textContent = inactivos;
            document.getElementById('stat-con-usuario').textContent = conUsuario;
        }

        function renderizarEmpleados() {
            const container = document.getElementById('lista-empleados');
            if (state.empleados.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="bi bi-people fs-1 d-block mb-3"></i>
                            <h5>No hay empleados registrados</h5>
                            <button class="btn btn-primary mt-2" onclick="EmpleadosModule.abrirModalNuevo()">
                                <i class="bi bi-plus"></i> Crear Empleado
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = state.empleados.map(emp => `
                <div class="col-md-6 col-lg-4 col-xl-3">
                    <div class="card h-100 ${!emp.activo ? 'opacity-50' : ''}">
                        <div class="card-body text-center">
                            <img src="${emp.foto_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(emp.nombre) + '&size=100'}"
                                 class="rounded-circle mb-3"
                                 style="width: 80px; height: 80px; object-fit: cover;"
                                 alt="${emp.nombre}">
                            <h6 class="card-title mb-1">${emp.nombre}</h6>
                            <p class="text-muted small mb-2">${emp.codigo_empleado}</p>
                            <span class="badge bg-primary mb-2">${emp.departamento}</span>
                            <span class="badge bg-secondary mb-2">${emp.rol}</span>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center small mb-3">
                                <span class="text-muted">
                                    <i class="bi bi-envelope"></i> ${emp.email}
                                </span>
                                ${emp.activo ?
                    '<span class="badge bg-success">Activo</span>' :
                    '<span class="badge bg-danger">Inactivo</span>'}
                            </div>
                            <div class="btn-group w-100">
                                <button class="btn btn-sm btn-outline-primary" onclick="EmpleadosModule.editarEmpleado(${emp.idEmpleado})">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                                ${emp.activo ?
                    `<button class="btn btn-sm btn-outline-danger" onclick="EmpleadosModule.desactivarEmpleado(${emp.idEmpleado}, '${emp.nombre}')">
                                        <i class="bi bi-x-circle"></i> Desactivar
                                    </button>` :
                    `<button class="btn btn-sm btn-outline-success" onclick="EmpleadosModule.activarEmpleado(${emp.idEmpleado})">
                                        <i class="bi bi-check-circle"></i> Activar
                                    </button>`
                }
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function abrirModalNuevo() {
            document.getElementById('formEmpleado').reset();
            document.getElementById('empleadoId').value = '';
            document.getElementById('modalTitle').textContent = 'Nuevo Empleado';

            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('txtFechaIngreso').value = hoy;
            document.getElementById('txtFechaNacimiento').max = hoy;

            if (!state.modalInstance) {
                state.modalInstance = new bootstrap.Modal(document.getElementById('modalEmpleado'));
            }
            state.modalInstance.show();
        }

        async function editarEmpleado(id) {
            try {
                const emp = await apiCall(`/api/empleados/${id}`);
                document.getElementById('empleadoId').value = emp.idEmpleado;
                document.getElementById('txtCodigoEmpleado').value = emp.codigo_empleado;
                document.getElementById('txtNombre').value = emp.nombre;
                document.getElementById('txtEmail').value = emp.email;
                document.getElementById('txtTelefono').value = emp.telefono;
                document.getElementById('txtFechaNacimiento').value = emp.fecha_nacimiento;
                document.getElementById('txtFechaIngreso').value = emp.fecha_ingreso;
                document.getElementById('selDepartamento').value = emp.departamento.idDepartamento;
                document.getElementById('selRol').value = emp.rol.idRol;
                document.getElementById('txtFotoUrl').value = emp.foto_url || '';
                document.getElementById('modalTitle').textContent = 'Editar Empleado';

                if (!state.modalInstance) {
                    state.modalInstance = new bootstrap.Modal(document.getElementById('modalEmpleado'));
                }
                state.modalInstance.show();
            } catch (error) {
                alert('Error al cargar empleado');
            }
        }

        async function guardarEmpleado() {
            const form = document.getElementById('formEmpleado');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // ✅ Corrección clave: enviar null si FechaIngreso está vacío
            const data = {
                CodigoEmpleado: document.getElementById('txtCodigoEmpleado').value.trim(),
                Nombre: document.getElementById('txtNombre').value.trim(),
                Email: document.getElementById('txtEmail').value.trim(),
                Telefono: document.getElementById('txtTelefono').value.trim(),
                FechaNacimiento: document.getElementById('txtFechaNacimiento').value,
                FechaIngreso: document.getElementById('txtFechaIngreso').value || null, // ✅ null si vacío
                IdDepartamento: parseInt(document.getElementById('selDepartamento').value),
                IdRol: parseInt(document.getElementById('selRol').value),
                FotoUrl: document.getElementById('txtFotoUrl').value || null
            };

            try {
                const empleadoId = document.getElementById('empleadoId').value;
                if (empleadoId) {
                    await apiCall(`/api/empleados/${empleadoId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    mostrarAlerta('Empleado actualizado exitosamente', 'success');
                } else {
                    await apiCall('/api/empleados', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    mostrarAlerta('Empleado creado exitosamente', 'success');
                }

                if (state.modalInstance) state.modalInstance.hide();
                await cargarEmpleados();
            } catch (error) {
                mostrarAlerta('Error al guardar: ' + error.message, 'danger');
            }
        }

        async function desactivarEmpleado(id, nombre) {
            if (!confirm(`¿Desactivar a ${nombre}?`)) return;
            try {
                await apiCall(`/api/empleados/${id}`, { method: 'DELETE' });
                mostrarAlerta('Empleado desactivado', 'success');
                await cargarEmpleados();
            } catch (error) {
                mostrarAlerta('Error al desactivar', 'danger');
            }
        }

        async function activarEmpleado(id) {
            try {
                await apiCall(`/api/empleados/${id}/activar`, { method: 'PUT' });
                mostrarAlerta('Empleado activado', 'success');
                await cargarEmpleados();
            } catch (error) {
                mostrarAlerta('Error al activar', 'danger');
            }
        }

        function mostrarAlerta(mensaje, tipo) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `${mensaje}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }

        async function init() {
            if (!document.getElementById('empleados-container')) return;
            await Promise.all([cargarEmpleados(), cargarCatalogos()]);

            // ✅ Configurar filtros dinámicos
            ['input-buscar', 'select-departamento', 'select-rol', 'select-estado'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', cargarEmpleados);
                    if (id === 'input-buscar') {
                        el.addEventListener('input', cargarEmpleados);
                    }
                }
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        return {
            abrirModalNuevo,
            editarEmpleado,
            guardarEmpleado,
            desactivarEmpleado,
            activarEmpleado
        };
    })();
</script>