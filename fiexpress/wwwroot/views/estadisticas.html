<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Estadísticas - Sistema de Fichajes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

            .loading-overlay.hidden {
                opacity: 0;
                visibility: hidden;
            }

        .loading-logo {
            font-size: 3rem;
            color: white;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }

        .loading-text {
            color: white;
            font-size: 1.2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .loading-progress {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .loading-steps {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            text-align: center;
            min-height: 24px;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .content-hidden {
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .content-visible {
            opacity: 1;
        }

        .card-estadistica {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            animation: fadeInUp 0.6s ease;
        }

            .card-estadistica:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }

        .stat-card {
            transition: transform 0.2s ease;
            animation: fadeInUp 0.6s ease;
        }

            .stat-card:hover {
                transform: translateY(-3px);
            }

        .avatar {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border: 3px solid #e9ecef;
        }

        .badge-estadistica {
            font-size: 0.75em;
            padding: 4px 8px;
        }

        .progress {
            height: 8px;
        }

        .empleado-inactivo {
            opacity: 0.7;
            position: relative;
            border-left: 4px solid #dc3545;
        }

        .empleado-activo {
            border-left: 4px solid #198754;
        }

        .btn-vista-activa {
            font-weight: bold;
            border-width: 2px;
        }

        .animate-delay-1 {
            animation-delay: 0.1s;
        }

        .animate-delay-2 {
            animation-delay: 0.2s;
        }

        .animate-delay-3 {
            animation-delay: 0.3s;
        }

        .animate-delay-4 {
            animation-delay: 0.4s;
        }

        .animate-delay-5 {
            animation-delay: 0.5s;
        }

        .search-highlight {
            background-color: #fff3cd;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Pantalla de carga -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-logo"><i class="bi bi-graph-up"></i></div>
        <div class="loading-text">Cargando panel de estadísticas...</div>
        <div class="loading-progress">
            <div id="loading-progress-bar" class="loading-progress-bar"></div>
        </div>
        <div id="loading-steps" class="loading-steps">Iniciando sistema...</div>
    </div>

    <!-- Vista de Panel de Estadísticas -->
    <div class="container-fluid py-4 content-hidden" id="estadisticas-container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-3">
                            <i class="bi bi-graph-up text-primary"></i>
                            Panel de Estadísticas
                        </h2>
                        <p class="text-muted">Estadísticas automáticas basadas en horarios y fichajes de los empleados.</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary" onclick="EstadisticasModule.recargarEstadisticas()">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas Principales CORREGIDAS -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card border-start border-primary border-4 animate-delay-1">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Empleados Activos</h6>
                                <h3 id="stat-total-empleados" class="mb-0">0</h3>
                            </div>
                            <i class="bi bi-people fs-1 text-primary opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-start border-success border-4 animate-delay-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Asistencia Promedio</h6>
                                <h3 class="text-success mb-0" id="stat-asistencia">0%</h3>
                            </div>
                            <i class="bi bi-check-circle fs-1 text-success opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-start border-warning border-4 animate-delay-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Horas de Retraso</h6>
                                <h3 class="text-warning mb-0" id="stat-retraso">0h</h3>
                            </div>
                            <i class="bi bi-clock-history fs-1 text-warning opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-start border-info border-4 animate-delay-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Horas Extra</h6>
                                <h3 class="text-info mb-0" id="stat-extra">0h</h3>
                            </div>
                            <i class="bi bi-plus-circle fs-1 text-info opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barra de Búsqueda Rápida MEJORADA -->
        <div class="card mb-4 animate-delay-2">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <label class="form-label fw-bold">
                            <i class="bi bi-search me-1"></i>Búsqueda Rápida de Empleados
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control" id="busqueda-rapida"
                                   placeholder="Buscar por nombre, código o departamento...">
                            <button class="btn btn-outline-secondary" type="button" onclick="EstadisticasModule.limpiarBusqueda()">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                        <small class="text-muted">Escribe para filtrar y ordenar la lista de empleados en tiempo real</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-eye me-1"></i>Vista Rápida
                        </label>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-vista-activa" id="btn-activos" onclick="EstadisticasModule.mostrarSoloActivos()">
                                <i class="bi bi-people me-1"></i> Ver Activos
                            </button>
                            <button class="btn btn-outline-secondary" id="btn-inactivos" onclick="EstadisticasModule.mostrarSoloInactivos()">
                                <i class="bi bi-person-x me-1"></i> Ver Inactivos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros Principales SIMPLIFICADOS -->
        <div class="card mb-4 animate-delay-3">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Fecha Inicio</label>
                        <input type="date" class="form-control" id="filtro-inicio">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Fecha Fin</label>
                        <input type="date" class="form-control" id="filtro-fin">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Departamento</label>
                        <select class="form-select" id="filtro-departamento">
                            <option value="">Todos los departamentos</option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="EstadisticasModule.aplicarFiltros()">
                                <i class="bi bi-filter me-1"></i> Aplicar Filtros
                            </button>
                            <button class="btn btn-outline-secondary" onclick="EstadisticasModule.limpiarFiltros()">
                                <i class="bi bi-x-circle me-1"></i> Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Estadísticas en Cards -->
        <div class="row g-3" id="lista-estadisticas">
            <!-- El contenido se carga dinámicamente -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ✅ MÓDULO COMPLETAMENTE FUNCIONAL Y CORREGIDO - SIN AUTO-REFRESH
        window.EstadisticasModule = (function () {
            'use strict';

            const state = {
                estadisticas: null,
                empleados: [],
                departamentos: [],
                estadisticasOriginales: null,
                mostrarSoloActivos: true, // Por defecto solo mostrar activos
                busquedaActual: '',
                pasosCarga: [
                    "Iniciando sistema...",
                    "Cargando información de empleados...",
                    "Obteniendo departamentos...",
                    "Configurando filtros...",
                    "Cargando estadísticas...",
                    "Procesando datos...",
                    "Preparando interfaz...",
                    "¡Listo!"
                ],
                pasoActual: 0
            };

            const STORAGE_KEY = 'fiExpress_estadisticas_data';

            // ✅ CONTROL DE PANTALLA DE CARGA
            function actualizarProgresoCarga(paso, mensajePersonalizado = null) {
                const progressBar = document.getElementById('loading-progress-bar');
                const stepsText = document.getElementById('loading-steps');

                const progreso = ((paso + 1) / state.pasosCarga.length) * 100;
                progressBar.style.width = `${progreso}%`;

                const mensaje = mensajePersonalizado || state.pasosCarga[paso];
                stepsText.textContent = mensaje;
                state.pasoActual = paso;
            }

            function mostrarPantallaCarga() {
                const overlay = document.getElementById('loading-overlay');
                const contenido = document.getElementById('estadisticas-container');
                overlay.classList.remove('hidden');
                contenido.classList.add('content-hidden');
                contenido.classList.remove('content-visible');
                actualizarProgresoCarga(0);
            }

            function ocultarPantallaCarga() {
                const overlay = document.getElementById('loading-overlay');
                const contenido = document.getElementById('estadisticas-container');
                actualizarProgresoCarga(state.pasosCarga.length - 1, "¡Panel de estadísticas listo!");
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    contenido.classList.remove('content-hidden');
                    contenido.classList.add('content-visible');
                }, 800);
            }

            // ✅ PERSISTENCIA DE DATOS
            function guardarDatosEnStorage(datos) {
                try {
                    const datosConTimestamp = {
                        ...datos,
                        timestamp: Date.now(),
                        filtros: {
                            inicio: document.getElementById('filtro-inicio').value,
                            fin: document.getElementById('filtro-fin').value,
                            departamento: document.getElementById('filtro-departamento').value
                        }
                    };
                    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(datosConTimestamp));
                } catch (error) {
                    console.warn('No se pudo guardar en sessionStorage:', error);
                }
            }

            function cargarDatosDesdeStorage() {
                try {
                    const datosGuardados = sessionStorage.getItem(STORAGE_KEY);
                    if (!datosGuardados) return null;

                    const datos = JSON.parse(datosGuardados);
                    const cincoMinutos = 5 * 60 * 1000;

                    // Verificar que los datos no sean viejos y que los filtros sean los mismos
                    const filtrosActuales = {
                        inicio: document.getElementById('filtro-inicio').value,
                        fin: document.getElementById('filtro-fin').value,
                        departamento: document.getElementById('filtro-departamento').value
                    };

                    if (Date.now() - datos.timestamp > cincoMinutos ||
                        JSON.stringify(datos.filtros) !== JSON.stringify(filtrosActuales)) {
                        sessionStorage.removeItem(STORAGE_KEY);
                        return null;
                    }

                    return datos;
                } catch (error) {
                    console.warn('Error al cargar datos desde sessionStorage:', error);
                    return null;
                }
            }

            // ✅ API HELPER MEJORADO
            async function apiCall(url, options = {}) {
                try {
                    console.log(`🔍 API Call: ${url}`);
                    const response = await fetch(url, {
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        },
                        ...options
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`❌ API Error ${response.status}:`, errorText);
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('💥 API Call Error:', error);
                    mostrarAlerta(`Error de conexión: ${error.message}`, 'danger');
                    throw error;
                }
            }

            // ✅ FUNCIÓN PRINCIPAL MEJORADA
            async function cargarEstadisticas(forceRefresh = false) {
                console.log('📊 Cargando estadísticas...');

                if (!forceRefresh) {
                    const datosGuardados = cargarDatosDesdeStorage();
                    if (datosGuardados) {
                        console.log('✅ Usando datos guardados en sessionStorage');
                        state.estadisticas = datosGuardados;
                        state.estadisticasOriginales = JSON.parse(JSON.stringify(datosGuardados));
                        actualizarVistaCompleta();
                        ocultarPantallaCarga();
                        return;
                    }
                }

                mostrarPantallaCarga();

                try {
                    actualizarProgresoCarga(1, "Validando fechas...");

                    const inicio = document.getElementById('filtro-inicio').value;
                    const fin = document.getElementById('filtro-fin').value;
                    const departamentoId = document.getElementById('filtro-departamento').value;

                    // ✅ VALIDACIÓN DE FECHAS MEJORADA
                    if (!inicio || !fin) {
                        mostrarAlerta('❌ Debes seleccionar un rango de fechas válido', 'warning');
                        ocultarPantallaCarga();
                        return;
                    }

                    if (new Date(inicio) > new Date(fin)) {
                        mostrarAlerta('❌ La fecha de inicio no puede ser mayor a la fecha fin', 'warning');
                        ocultarPantallaCarga();
                        return;
                    }

                    // ✅ CONSTRUCCIÓN CORRECTA DE URL
                    let url = `/api/estadisticas/generales?inicio=${inicio}&fin=${fin}`;
                    if (departamentoId) url += `&departamentoId=${departamentoId}`;

                    console.log(`🔗 URL de API: ${url}`);

                    actualizarProgresoCarga(2, "Solicitando datos a la API...");
                    state.estadisticas = await apiCall(url);
                    state.estadisticasOriginales = JSON.parse(JSON.stringify(state.estadisticas));

                    actualizarProgresoCarga(3, "Procesando estadísticas...");

                    // ✅ GUARDAR Y ACTUALIZAR
                    guardarDatosEnStorage(state.estadisticas);
                    actualizarProgresoCarga(4, "Actualizando interfaz...");
                    actualizarVistaCompleta();

                    mostrarAlerta('✅ Estadísticas actualizadas correctamente', 'success');
                    setTimeout(ocultarPantallaCarga, 500);

                } catch (error) {
                    console.error('💥 Error crítico al cargar estadísticas:', error);
                    mostrarAlerta('❌ Error crítico al cargar las estadísticas', 'danger');
                    ocultarPantallaCarga();
                }
            }

            // ✅ FUNCIÓN CRÍTICA: ACTUALIZAR ESTADÍSTICAS PRINCIPALES (COMPLETAMENTE CORREGIDA)
            function actualizarEstadisticasPrincipales() {
                if (!state.estadisticas || !state.estadisticas.resumenGeneral) {
                    console.warn('⚠️ No hay datos para actualizar estadísticas principales');

                    // Resetear a valores por defecto
                    document.getElementById('stat-total-empleados').textContent = '0';
                    document.getElementById('stat-asistencia').textContent = '0%';
                    document.getElementById('stat-retraso').textContent = '0h';
                    document.getElementById('stat-extra').textContent = '0h';
                    return;
                }

                const resumen = state.estadisticas.resumenGeneral;
                console.log('📈 Resumen general:', resumen);

                // ✅ EMPLEADOS ACTIVOS: SIEMPRE contar solo empleados activos del sistema
                const empleadosActivos = state.empleados.filter(emp => emp.activo).length;
                document.getElementById('stat-total-empleados').textContent = empleadosActivos;

                // ✅ ASISTENCIA PROMEDIO: Solo de empleados activos en las estadísticas filtradas
                let asistenciaPromedio = 0;
                if (state.estadisticas.estadisticasDetalladas && state.estadisticas.estadisticasDetalladas.length > 0) {
                    const estadisticasActivas = state.estadisticas.estadisticasDetalladas.filter(est => {
                        const empleado = state.empleados.find(e => e.idEmpleado === est.empleado?.idEmpleado);
                        return empleado ? empleado.activo : false;
                    });

                    if (estadisticasActivas.length > 0) {
                        asistenciaPromedio = estadisticasActivas.reduce((sum, est) => sum + est.porcentajeAsistencia, 0) / estadisticasActivas.length;
                    }
                }
                document.getElementById('stat-asistencia').textContent = `${asistenciaPromedio.toFixed(1)}%`;

                // ✅ HORAS DE RETRASO (minutos a horas) - Solo de empleados activos
                let totalRetrasoMinutos = 0;
                if (state.estadisticas.estadisticasDetalladas) {
                    state.estadisticas.estadisticasDetalladas.forEach(est => {
                        const empleado = state.empleados.find(e => e.idEmpleado === est.empleado?.idEmpleado);
                        if (empleado && empleado.activo) {
                            totalRetrasoMinutos += est.totalMinutosRetraso || 0;
                        }
                    });
                }
                const horasRetraso = (totalRetrasoMinutos / 60).toFixed(1);
                document.getElementById('stat-retraso').textContent = `${horasRetraso}h`;

                // ✅ HORAS EXTRA (minutos a horas) - Solo de empleados activos
                let totalExtraMinutos = 0;
                if (state.estadisticas.estadisticasDetalladas) {
                    state.estadisticas.estadisticasDetalladas.forEach(est => {
                        const empleado = state.empleados.find(e => e.idEmpleado === est.empleado?.idEmpleado);
                        if (empleado && empleado.activo) {
                            totalExtraMinutos += est.totalMinutosExtra || 0;
                        }
                    });
                }
                const horasExtra = (totalExtraMinutos / 60).toFixed(1);
                document.getElementById('stat-extra').textContent = `${horasExtra}h`;

                console.log('✅ Estadísticas principales actualizadas correctamente');
            }

            // ✅ ACTUALIZAR VISTA COMPLETA
            function actualizarVistaCompleta() {
                actualizarEstadisticasPrincipales();
                mostrarEstadisticas();
                actualizarBotonesVista();
            }

            // ✅ MOSTRAR ESTADÍSTICAS EN CARDS CON ORDENACIÓN POR BÚSQUEDA
            function mostrarEstadisticas() {
                const container = document.getElementById('lista-estadisticas');
                const datosAMostrar = state.estadisticasOriginales || state.estadisticas;

                if (!datosAMostrar || !datosAMostrar.estadisticasDetalladas) {
                    container.innerHTML = `
                            <div class="col-12">
                                <div class="alert alert-info text-center py-4">
                                    <i class="bi bi-graph-up fs-1 d-block mb-3 text-info"></i>
                                    <h5>No hay estadísticas disponibles</h5>
                                    <p class="mb-0">No se encontraron datos con los filtros aplicados</p>
                                </div>
                            </div>
                        `;
                    return;
                }

                let estadisticas = [...datosAMostrar.estadisticasDetalladas];

                // ✅ FILTRAR POR ESTADO (ACTIVOS/INACTIVOS)
                if (state.mostrarSoloActivos) {
                    estadisticas = estadisticas.filter(est => {
                        const empleado = state.empleados.find(e => e.idEmpleado === est.empleado?.idEmpleado);
                        return empleado ? empleado.activo : false;
                    });
                } else {
                    estadisticas = estadisticas.filter(est => {
                        const empleado = state.empleados.find(e => e.idEmpleado === est.empleado?.idEmpleado);
                        return empleado ? !empleado.activo : true;
                    });
                }

                // ✅ ORDENAR POR BÚSQUEDA SI HAY TEXTO
                if (state.busquedaActual) {
                    estadisticas = ordenarPorRelevancia(estadisticas, state.busquedaActual);
                }

                if (estadisticas.length === 0) {
                    const mensaje = state.mostrarSoloActivos ?
                        'No hay estadísticas de empleados activos' :
                        'No hay estadísticas de empleados inactivos';

                    container.innerHTML = `
                            <div class="col-12">
                                <div class="alert alert-warning text-center py-4">
                                    <i class="bi bi-inbox fs-1 d-block mb-3 text-warning"></i>
                                    <h5>${mensaje}</h5>
                                    <p class="mb-0">Intenta con otros filtros o rango de fechas</p>
                                </div>
                            </div>
                        `;
                    return;
                }

                container.innerHTML = estadisticas.map(est => {
                    const empleado = state.empleados.find(e => e.idEmpleado === est.empleado?.idEmpleado);
                    const esActivo = empleado ? empleado.activo : true;
                    const textoBusqueda = state.busquedaActual.toLowerCase();

                    // ✅ RESALTAR TEXTO DE BÚSQUEDA
                    const resaltarTexto = (texto) => {
                        if (!textoBusqueda || !texto) return texto;
                        const regex = new RegExp(`(${textoBusqueda})`, 'gi');
                        return texto.toString().replace(regex, '<mark class="search-highlight">$1</mark>');
                    };

                    return `
                            <div class="col-md-6 col-lg-4">
                                <div class="card card-estadistica h-100 ${esActivo ? 'empleado-activo' : 'empleado-inactivo'}">
                                    <div class="card-body">
                                        <div class="d-flex align-items-start mb-3">
                                            <img src="${est.empleado?.foto_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(est.empleado?.nombre || 'Empleado')}&size=100&background=0D6EFD&color=fff&bold=true`}"
                                                 class="avatar rounded-circle me-3"
                                                 alt="${est.empleado?.nombre}"
                                                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(est.empleado?.nombre || 'Empleado')}&size=100&background=0D6EFD&color=fff&bold=true'">
                                            <div class="flex-grow-1">
                                                <h6 class="card-title mb-1 fw-bold">${resaltarTexto(est.empleado?.nombre) || 'N/A'}</h6>
                                                <p class="text-muted small mb-2">${resaltarTexto(est.empleado?.codigo_empleado) || ''}</p>
                                                <span class="badge bg-primary">${resaltarTexto(est.empleado?.departamento) || 'N/A'}</span>
                                                ${!esActivo ? '<span class="badge bg-danger ms-1">Inactivo</span>' : ''}
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">Asistencia</small>
                                                <small class="fw-bold ${est.porcentajeAsistencia >= 90 ? 'text-success' : est.porcentajeAsistencia >= 70 ? 'text-warning' : 'text-danger'}">
                                                    ${est.porcentajeAsistencia}%
                                                </small>
                                            </div>
                                            <div class="progress">
                                                <div class="progress-bar ${est.porcentajeAsistencia >= 90 ? 'bg-success' : est.porcentajeAsistencia >= 70 ? 'bg-warning' : 'bg-danger'}"
                                                     style="width: ${est.porcentajeAsistencia}%">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row text-center mb-3">
                                            <div class="col-4">
                                                <div class="border-end">
                                                    <h6 class="mb-0 fw-bold">${est.diasTrabajados}/${est.totalDias}</h6>
                                                    <small class="text-muted">Días</small>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="border-end">
                                                    <h6 class="mb-0 fw-bold text-warning">${Math.floor(est.totalMinutosRetraso / 60)}h</h6>
                                                    <small class="text-muted">Retraso</small>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <h6 class="mb-0 fw-bold text-info">${Math.floor(est.totalMinutosExtra / 60)}h</h6>
                                                <small class="text-muted">Extra</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                }).join('');
            }

            // ✅ ORDENAR POR RELEVANCIA DE BÚSQUEDA
            function ordenarPorRelevancia(estadisticas, textoBusqueda) {
                const texto = textoBusqueda.toLowerCase();

                return estadisticas.sort((a, b) => {
                    const aPuntos = calcularPuntosRelevancia(a, texto);
                    const bPuntos = calcularPuntosRelevancia(b, texto);

                    return bPuntos - aPuntos; // Orden descendente
                });
            }

            function calcularPuntosRelevancia(estadistica, texto) {
                let puntos = 0;
                const campos = [
                    estadistica.empleado?.nombre,
                    estadistica.empleado?.codigo_empleado,
                    estadistica.empleado?.departamento
                ];

                campos.forEach(campo => {
                    if (!campo) return;

                    const campoLower = campo.toLowerCase();

                    // Coincidencia exacta
                    if (campoLower === texto) puntos += 10;

                    // Coincidencia al inicio
                    if (campoLower.startsWith(texto)) puntos += 5;

                    // Coincidencia en cualquier parte
                    if (campoLower.includes(texto)) puntos += 3;
                });

                return puntos;
            }

            // ✅ CARGAR FILTROS MEJORADO
            async function cargarFiltros() {
                try {
                    actualizarProgresoCarga(1, "Cargando empleados...");

                    // Cargar TODOS los empleados para filtros
                    state.empleados = await apiCall('/api/empleados?incluirInactivos=true');

                    actualizarProgresoCarga(2, "Cargando departamentos...");
                    state.departamentos = await apiCall('/api/departamentos?incluirInactivos=true');

                    const selectDepto = document.getElementById('filtro-departamento');
                    selectDepto.innerHTML = '<option value="">Todos los departamentos</option>';
                    state.departamentos.forEach(depto => {
                        selectDepto.innerHTML += `<option value="${depto.idDepartamento}">${depto.nombre}</option>`;
                    });

                } catch (error) {
                    console.error('❌ Error al cargar filtros:', error);
                    mostrarAlerta('Error al cargar los filtros', 'danger');
                }
            }

            // ✅ BÚSQUEDA RÁPIDA MEJORADA
            function configurarBusquedaRapida() {
                const inputBusqueda = document.getElementById('busqueda-rapida');
                inputBusqueda.addEventListener('input', function (e) {
                    state.busquedaActual = e.target.value.trim();
                    mostrarEstadisticas();
                });
            }

            // ✅ FUNCIONES DE VISTA RÁPIDA MEJORADAS
            function mostrarSoloActivos() {
                state.mostrarSoloActivos = true;
                state.busquedaActual = '';
                document.getElementById('busqueda-rapida').value = '';
                actualizarBotonesVista();
                mostrarEstadisticas();
                mostrarAlerta('👥 Mostrando solo empleados activos', 'info');
            }

            function mostrarSoloInactivos() {
                state.mostrarSoloActivos = false;
                state.busquedaActual = '';
                document.getElementById('busqueda-rapida').value = '';
                actualizarBotonesVista();
                mostrarEstadisticas();
                mostrarAlerta('👥 Mostrando empleados inactivos', 'warning');
            }

            function actualizarBotonesVista() {
                const btnActivos = document.getElementById('btn-activos');
                const btnInactivos = document.getElementById('btn-inactivos');

                if (state.mostrarSoloActivos) {
                    btnActivos.classList.remove('btn-outline-primary');
                    btnActivos.classList.add('btn-primary', 'btn-vista-activa');
                    btnInactivos.classList.remove('btn-primary', 'btn-vista-activa');
                    btnInactivos.classList.add('btn-outline-secondary');
                } else {
                    btnInactivos.classList.remove('btn-outline-secondary');
                    btnInactivos.classList.add('btn-primary', 'btn-vista-activa');
                    btnActivos.classList.remove('btn-primary', 'btn-vista-activa');
                    btnActivos.classList.add('btn-outline-primary');
                }
            }

            // ✅ FUNCIONES DE FILTROS
            function aplicarFiltros() {
                cargarEstadisticas(true);
            }

            function limpiarFiltros() {
                document.getElementById('filtro-inicio').value = '';
                document.getElementById('filtro-fin').value = '';
                document.getElementById('filtro-departamento').value = '';
                document.getElementById('busqueda-rapida').value = '';
                state.busquedaActual = '';
                state.mostrarSoloActivos = true;
                actualizarBotonesVista();
                mostrarAlerta('🔄 Filtros limpiados', 'info');
            }

            function limpiarBusqueda() {
                document.getElementById('busqueda-rapida').value = '';
                state.busquedaActual = '';
                mostrarEstadisticas();
            }

            function recargarEstadisticas() {
                cargarEstadisticas(true);
            }

            // ✅ CONFIGURACIÓN AUTOMÁTICA
            function configurarFechasPorDefecto() {
                const hoy = new Date();
                const hace30Dias = new Date();
                hace30Dias.setDate(hoy.getDate() - 30);

                document.getElementById('filtro-inicio').value = hace30Dias.toISOString().split('T')[0];
                document.getElementById('filtro-fin').value = hoy.toISOString().split('T')[0];
            }

            // ✅ ELIMINADO: configurarAutoRefresh - NO MÁS AUTO-REFRESH

            // ✅ ALERTAS MEJORADAS
            function mostrarAlerta(mensaje, tipo = 'info') {
                const alertasAnteriores = document.querySelectorAll('.alert-fixed');
                alertasAnteriores.forEach(alerta => alerta.remove());

                const iconos = {
                    success: 'bi-check-circle',
                    danger: 'bi-exclamation-triangle',
                    warning: 'bi-exclamation-circle',
                    info: 'bi-info-circle'
                };

                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 alert-fixed`;
                alertDiv.style.zIndex = '9999';
                alertDiv.style.minWidth = '300px';
                alertDiv.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="bi ${iconos[tipo]} me-2"></i>
                            <span>${mensaje}</span>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                document.body.appendChild(alertDiv);

                setTimeout(() => {
                    if (alertDiv.parentNode) alertDiv.remove();
                }, 5000);
            }

            // ✅ INICIALIZACIÓN
            async function init() {
                console.log('📈 Iniciando módulo de estadísticas...');

                if (!document.getElementById('estadisticas-container')) {
                    console.log('❌ No estamos en la vista de estadísticas');
                    return;
                }

                try {
                    mostrarPantallaCarga();
                    configurarFechasPorDefecto();
                    await cargarFiltros();
                    await cargarEstadisticas(false);
                    configurarBusquedaRapida();
                    // ✅ ELIMINADO: configurarAutoRefresh - NO MÁS AUTO-REFRESH
                    actualizarBotonesVista();

                    console.log('✅ Módulo de estadísticas iniciado correctamente');
                } catch (error) {
                    console.error('💥 Error en inicialización:', error);
                    mostrarAlerta('Error al inicializar el módulo de estadísticas', 'danger');
                }
            }

            // Iniciar cuando el DOM esté listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }

            // API pública del módulo
            return {
                init,
                cargarEstadisticas,
                recargarEstadisticas,
                aplicarFiltros,
                limpiarFiltros,
                limpiarBusqueda,
                mostrarSoloActivos,
                mostrarSoloInactivos
            };
        })();
    </script>
</body>
</html>