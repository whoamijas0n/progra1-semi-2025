<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - Sistema de Fichajes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Estilos personalizados para mejorar la apariencia */
        .card-empleado {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

            .card-empleado:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }

        .avatar {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 3px solid #e9ecef;
        }

        .stat-card {
            transition: transform 0.2s ease;
        }

            .stat-card:hover {
                transform: translateY(-3px);
            }

        #selEmpleado {
            font-size: 0.9rem;
        }

            #selEmpleado option {
                padding: 8px 12px;
                border-bottom: 1px solid #f0f0f0;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

                #selEmpleado option:hover {
                    background-color: #e9ecef;
                }

        .search-highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }

        .btn-group-xs > .btn, .btn-xs {
            padding: 0.25rem 0.4rem;
            font-size: 0.75rem;
            line-height: 1.5;
            border-radius: 0.2rem;
        }
    </style>
</head>
<body>
    <!-- Vista de Gestión de Usuarios -->
    <div class="container-fluid py-4" id="usuarios-container">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-3">
                    <i class="bi bi-person-badge text-primary"></i>
                    Gestión de Usuarios
                </h2>
                <p class="text-muted">Administra los usuarios del sistema y sus permisos de acceso.</p>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card border-start border-primary border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Total Usuarios</h6>
                                <h3 id="stat-total" class="mb-0">0</h3>
                            </div>
                            <i class="bi bi-people fs-1 text-primary opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-start border-success border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Activos</h6>
                                <h3 class="text-success mb-0" id="stat-activos">0</h3>
                            </div>
                            <i class="bi bi-check-circle fs-1 text-success opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-start border-warning border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Inactivos</h6>
                                <h3 class="text-warning mb-0" id="stat-inactivos">0</h3>
                            </div>
                            <i class="bi bi-pause-circle fs-1 text-warning opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-start border-info border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Sin Usuario</h6>
                                <h3 class="text-info mb-0" id="stat-sin-usuario">0</h3>
                            </div>
                            <i class="bi bi-person-plus fs-1 text-info opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barra de búsqueda y acciones -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-light">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control" id="input-buscar" placeholder="Buscar por usuario, nombre o email...">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="select-estado">
                    <option value="">Todos los estados</option>
                    <option value="activo">Activos</option>
                    <option value="inactivo">Inactivos</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary w-100" onclick="UsuariosModule.abrirModalNuevo()">
                    <i class="bi bi-plus-lg me-1"></i> Nuevo Usuario
                </button>
            </div>
        </div>

        <!-- Lista de usuarios -->
        <div class="row g-3" id="lista-usuarios">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="text-muted mt-2">Cargando usuarios...</p>
            </div>
        </div>
    </div>

    <!-- Modal Crear/Editar Usuario -->
    <div class="modal fade" id="modalUsuario" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="bi bi-person-plus me-2"></i>Nuevo Usuario
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formUsuario">
                        <input type="hidden" id="usuarioId">

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label fw-bold">Seleccionar Empleado *</label>

                                <!-- 🔍 BARRA DE BÚSQUEDA MEJORADA -->
                                <div class="input-group mb-2">
                                    <span class="input-group-text bg-light">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text"
                                           class="form-control"
                                           id="buscarEmpleado"
                                           placeholder="Buscar por nombre, código, email o departamento..."
                                           aria-label="Buscar empleado">
                                </div>
                                <small class="text-muted d-block mb-2">
                                    <i class="bi bi-info-circle me-1"></i>Escribe para filtrar la lista. Se muestran solo empleados activos sin usuario.
                                </small>

                                <!-- 📋 COMBOBOX CON BÚSQUEDA -->
                                <select class="form-select" id="selEmpleado" required size="6" style="min-height: 150px;">
                                    <option value="">Seleccione un empleado de la lista...</option>
                                </select>

                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-people me-1"></i>
                                        <span id="contadorEmpleados">0</span> empleados disponibles
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Nombre de Usuario *</label>
                                <input type="text" class="form-control" id="txtUsername" required
                                       placeholder="Ej: juan.perez" minlength="3" maxlength="50">
                                <small class="text-muted">Mínimo 3 caracteres, sin espacios</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Contraseña *</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="txtPassword" required
                                           minlength="6" maxlength="35" placeholder="Mínimo 6 caracteres">
                                    <button class="btn btn-outline-secondary" type="button" id="btnTogglePassword">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Mínimo 6 caracteres</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="chkActivo" checked>
                                    <label class="form-check-label fw-bold" for="chkActivo">Usuario activo</label>
                                </div>
                                <small class="text-muted">Los usuarios inactivos no pueden iniciar sesión</small>
                            </div>
                        </div>

                        <!-- Información del empleado seleccionado -->
                        <div class="row" id="info-empleado" style="display: none;">
                            <div class="col-md-12">
                                <div class="card bg-light border-0">
                                    <div class="card-body">
                                        <h6 class="card-title text-primary">
                                            <i class="bi bi-check-circle me-2"></i>Empleado Seleccionado
                                        </h6>
                                        <div class="row">
                                            <div class="col-md-6 mb-2">
                                                <small><strong>Nombre:</strong> <span id="info-nombre">-</span></small>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <small><strong>Email:</strong> <span id="info-email">-</span></small>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <small><strong>Departamento:</strong> <span id="info-departamento">-</span></small>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <small><strong>Rol:</strong> <span id="info-rol">-</span></small>
                                            </div>
                                            <div class="col-md-12 mt-1">
                                                <small><strong>Código:</strong> <span id="info-codigo">-</span></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="UsuariosModule.guardarUsuario()">
                        <i class="bi bi-check-circle me-1"></i>Guardar Usuario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cambiar Contraseña -->
    <div class="modal fade" id="modalPassword" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">
                        <i class="bi bi-key me-2"></i>Cambiar Contraseña
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formPassword">
                        <input type="hidden" id="passwordUsuarioId">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nueva Contraseña *</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="txtNewPassword" required
                                       minlength="6" maxlength="35" placeholder="Mínimo 6 caracteres">
                                <button class="btn btn-outline-secondary" type="button" id="btnToggleNewPassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <small class="text-muted">Mínimo 6 caracteres</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="UsuariosModule.cambiarPassword()">
                        <i class="bi bi-check-circle me-1"></i>Actualizar Contraseña
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // MÓDULO AISLADO - Gestión de Usuarios
        window.UsuariosModule = (function () {
            'use strict';

            // Estado privado del módulo
            const state = {
                usuarios: [],
                empleadosSinUsuario: [],
                modalInstance: null,
                modalPasswordInstance: null
            };

            // API Helper
            async function apiCall(url, options = {}) {
                try {
                    const response = await fetch(url, {
                        credentials: 'include',
                        ...options
                    });

                    if (!response.ok) {
                        const text = await response.text();
                        console.error(`API Error ${response.status}:`, text);
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('API Call Error:', error);
                    mostrarAlerta(`Error: ${error.message}`, 'danger');
                    throw error;
                }
            }

            // Cargar usuarios
            async function cargarUsuarios() {
                console.log('Cargando usuarios...');
                try {
                    state.usuarios = await apiCall('/api/usuarios?incluirInactivos=true');
                    console.log('Usuarios cargados:', state.usuarios.length, state.usuarios);
                    actualizarEstadisticas();
                    renderizarUsuarios();
                } catch (error) {
                    console.error('Error al cargar usuarios:', error);
                    document.getElementById('lista-usuarios').innerHTML = `
                            <div class="col-12">
                                <div class="alert alert-danger">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    Error al cargar usuarios: ${error.message}
                                </div>
                            </div>
                        `;
                }
            }


            // Cargar empleados sin usuario
            async function cargarEmpleadosSinUsuario() {
                console.log(' Cargando empleados sin usuario...');
                try {
                    state.empleadosSinUsuario = await apiCall('/api/usuarios/empleados-sin-usuario');
                    console.log('Empleados sin usuario cargados:', state.empleadosSinUsuario.length);

                    // Verificar datos
                    if (state.empleadosSinUsuario.length === 0) {
                        console.warn('No se encontraron empleados sin usuario');
                    } else {
                        console.log('Primer empleado sin usuario:', state.empleadosSinUsuario[0]);
                    }
                } catch (error) {
                    console.error('Error al cargar empleados sin usuario:', error);
                    // Inicializar array vacío en caso de error
                    state.empleadosSinUsuario = [];
                }
            }


            // Función para llenar el select de empleados
            function llenarSelectEmpleados() {
                const selectEmpleado = document.getElementById('selEmpleado');
                const contador = document.getElementById('contadorEmpleados');

                if (!selectEmpleado) return;

                // Guardar la opción seleccionada actualmente
                const valorSeleccionado = selectEmpleado.value;

                // Limpiar y reconstruir el select
                selectEmpleado.innerHTML = '<option value="">Seleccione un empleado de la lista...</option>';

                let contadorEmpleados = 0;

                state.empleadosSinUsuario.forEach(emp => {
                    const textoCompleto = `${emp.codigo_empleado} - ${emp.nombre} - ${emp.departamento} - ${emp.email}`;
                    const opcion = document.createElement('option');
                    opcion.value = emp.idEmpleado;
                    opcion.textContent = textoCompleto;
                    opcion.dataset.nombre = emp.nombre;
                    opcion.dataset.email = emp.email;
                    opcion.dataset.departamento = emp.departamento;
                    opcion.dataset.rol = emp.rol;
                    opcion.dataset.codigo = emp.codigo_empleado;

                    selectEmpleado.appendChild(opcion);
                    contadorEmpleados++;
                });

                // Restaurar selección anterior si existe
                if (valorSeleccionado && selectEmpleado.querySelector(`option[value="${valorSeleccionado}"]`)) {
                    selectEmpleado.value = valorSeleccionado;
                }

                // Actualizar contador
                if (contador) {
                    contador.textContent = contadorEmpleados;
                    contador.className = contadorEmpleados > 0 ? 'text-success fw-bold' : 'text-danger fw-bold';
                }
            }

            // Función para filtrar empleados en tiempo real
            function configurarBusquedaEmpleados() {
                const inputBuscar = document.getElementById('buscarEmpleado');
                const selectEmpleado = document.getElementById('selEmpleado');
                const contador = document.getElementById('contadorEmpleados');

                if (!inputBuscar || !selectEmpleado) return;

                inputBuscar.addEventListener('input', function (e) {
                    const textoBusqueda = e.target.value.toLowerCase().trim();
                    const opciones = selectEmpleado.querySelectorAll('option');
                    let contadorVisible = 0;

                    opciones.forEach(opcion => {
                        if (opcion.value === '') return; // Saltar la opción por defecto

                        const textoOpcion = opcion.textContent.toLowerCase();
                        const coincide = textoBusqueda === '' || textoOpcion.includes(textoBusqueda);

                        opcion.style.display = coincide ? 'block' : 'none';
                        if (coincide) contadorVisible++;
                    });

                    if (contador) {
                        contador.textContent = contadorVisible;
                        contador.className = contadorVisible > 0 ? 'text-success fw-bold' : 'text-danger fw-bold';
                    }

                    // Si hay solo un resultado y coincide exactamente, seleccionarlo automáticamente
                    if (contadorVisible === 1 && textoBusqueda.length > 2) {
                        const opcionUnica = Array.from(opciones).find(op =>
                            op.style.display !== 'none' && op.value !== ''
                        );
                        if (opcionUnica) {
                            selectEmpleado.value = opcionUnica.value;
                            // Disparar el evento change para mostrar la info
                            const event = new Event('change');
                            selectEmpleado.dispatchEvent(event);
                        }
                    }
                });

                // Limpiar búsqueda al abrir el modal
                inputBuscar.value = '';
            }

            // Actualizar estadísticas
            function actualizarEstadisticas() {
                console.log('Actualizando estadísticas...');
                console.log('Usuarios cargados:', state.usuarios.length);
                console.log('Empleados sin usuario:', state.empleadosSinUsuario.length);

                const total = state.usuarios.length;
                const activos = state.usuarios.filter(u => u.activo).length;
                const inactivos = total - activos;
                const sinUsuario = state.empleadosSinUsuario.length;

                console.log('Estadísticas calculadas:', { total, activos, inactivos, sinUsuario });

                // ✅ CORRECCIÓN: Actualizar DOM de forma segura
                const statTotal = document.getElementById('stat-total');
                const statActivos = document.getElementById('stat-activos');
                const statInactivos = document.getElementById('stat-inactivos');
                const statSinUsuario = document.getElementById('stat-sin-usuario');

                if (statTotal) statTotal.textContent = total;
                if (statActivos) statActivos.textContent = activos;
                if (statInactivos) statInactivos.textContent = inactivos;
                if (statSinUsuario) statSinUsuario.textContent = sinUsuario;

                console.log('Estadísticas actualizadas en el DOM');
            }



            // Renderizar usuarios
            function renderizarUsuarios() {
                const container = document.getElementById('lista-usuarios');

                if (state.usuarios.length === 0) {
                    container.innerHTML = `
                            <div class="col-12">
                                <div class="alert alert-info text-center py-4">
                                    <i class="bi bi-people fs-1 d-block mb-3 text-info"></i>
                                    <h5>No hay usuarios registrados</h5>
                                    <p class="mb-3">Comienza creando el primer usuario del sistema</p>
                                    <button class="btn btn-primary" onclick="UsuariosModule.abrirModalNuevo()">
                                        <i class="bi bi-plus-lg me-1"></i>Crear Primer Usuario
                                    </button>
                                </div>
                            </div>
                        `;
                    return;
                }

                container.innerHTML = state.usuarios.map(user => `
                        <div class="col-md-6 col-lg-4 col-xl-3">
                            <div class="card card-empleado h-100 ${!user.activo ? 'opacity-75' : ''}">
                                <div class="card-body text-center">
                                    <img src="${user.empleado?.foto_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.username) + '&size=100&background=0D6EFD&color=fff&bold=true'}"
                                         class="avatar rounded-circle mb-3"
                                         alt="${user.username}"
                                         onerror="this.src='https://ui-avatars.com/api/?name='+encodeURIComponent('${user.username}')+'&size=100&background=0D6EFD&color=fff&bold=true'">
                                    <h6 class="card-title mb-1 fw-bold">${user.username}</h6>
                                    <p class="text-muted small mb-2">${user.empleado?.nombre || 'Sin empleado'}</p>
                                    <span class="badge bg-primary mb-2">${user.empleado?.departamento || 'N/A'}</span>
                                    <span class="badge bg-secondary mb-2">${user.empleado?.rol || 'N/A'}</span>
                                    <hr>
                                    <div class="d-flex justify-content-between align-items-center small mb-3">
                                        <span class="text-muted">
                                            <i class="bi bi-calendar me-1"></i>
                                            ${user.ultimo_login ? new Date(user.ultimo_login).toLocaleDateString() : 'Nunca'}
                                        </span>
                                        ${user.activo ?
                        '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Activo</span>' :
                        '<span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Inactivo</span>'}
                                    </div>

                                    <div class="btn-group w-100">
                                        <button class="btn btn-sm btn-outline-primary" onclick="UsuariosModule.editarUsuario(${user.idUsuario})">
                                            <i class="bi bi-pencil"></i> Editar
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="UsuariosModule.cambiarPasswordModal(${user.idUsuario}, '${user.username}')">
                                            <i class="bi bi-key"></i>
                                        </button>
                                        ${user.activo ?
                        `<button class="btn btn-sm btn-outline-danger" onclick="UsuariosModule.eliminarUsuario(${user.idUsuario}, '${user.username}')">
                                    <i class="bi bi-trash"></i> Desactivar
                                </button>` :
                        `<button class="btn btn-sm btn-outline-success" onclick="UsuariosModule.activarUsuario(${user.idUsuario}, '${user.username}')">
                                    <i class="bi bi-check-circle"></i> Activar
                                </button>`
                    }
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
            }

            // Abrir modal para nuevo usuario
            async function abrirModalNuevo() {
                console.log('Abriendo modal para nuevo usuario');

                // Recargar empleados sin usuario
                await cargarEmpleadosSinUsuario();

                document.getElementById('formUsuario').reset();
                document.getElementById('usuarioId').value = '';
                document.getElementById('modalTitle').innerHTML = '<i class="bi bi-person-plus me-2"></i>Nuevo Usuario';
                document.getElementById('chkActivo').checked = true;
                document.getElementById('info-empleado').style.display = 'none';

                // Llenar y configurar el select
                llenarSelectEmpleados();
                configurarBusquedaEmpleados();

                // Configurar evento para mostrar información del empleado
                const selEmpleado = document.getElementById('selEmpleado');
                const infoHandler = function () {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.value) {
                        document.getElementById('info-nombre').textContent = selectedOption.dataset.nombre;
                        document.getElementById('info-email').textContent = selectedOption.dataset.email;
                        document.getElementById('info-departamento').textContent = selectedOption.dataset.departamento;
                        document.getElementById('info-rol').textContent = selectedOption.dataset.rol;
                        document.getElementById('info-codigo').textContent = selectedOption.dataset.codigo;
                        document.getElementById('info-empleado').style.display = 'block';

                        // Sugerir username basado en el email
                        const email = selectedOption.dataset.email;
                        const usernameSugerido = email.split('@')[0];
                        document.getElementById('txtUsername').value = usernameSugerido;

                        // Auto-completar búsqueda con el nombre seleccionado
                        document.getElementById('buscarEmpleado').value = selectedOption.dataset.nombre;
                    } else {
                        document.getElementById('info-empleado').style.display = 'none';
                        document.getElementById('buscarEmpleado').value = '';
                    }
                };

                // Remover evento anterior si existe y agregar nuevo
                selEmpleado.removeEventListener('change', infoHandler);
                selEmpleado.addEventListener('change', infoHandler);

                if (!state.modalInstance) {
                    state.modalInstance = new bootstrap.Modal(document.getElementById('modalUsuario'));
                }
                state.modalInstance.show();

                // Enfocar el campo de búsqueda automáticamente
                setTimeout(() => {
                    const buscarInput = document.getElementById('buscarEmpleado');
                    if (buscarInput) buscarInput.focus();
                }, 500);

                console.log('Modal de usuario abierto con búsqueda');
            }

            // Editar usuario
            async function editarUsuario(id) {
                console.log('Editando usuario ID:', id);
                try {
                    const user = await apiCall(`/api/usuarios/${id}`);
                    console.log('Datos del usuario cargados:', user);

                    // Rellenar formulario
                    document.getElementById('usuarioId').value = user.idUsuario;
                    document.getElementById('txtUsername').value = user.username;
                    document.getElementById('txtPassword').value = ''; // No se muestra la contraseña actual
                    document.getElementById('chkActivo').checked = user.activo;

                    // Mostrar info del empleado (solo lectura)
                    document.getElementById('info-nombre').textContent = user.empleado.nombre;
                    document.getElementById('info-email').textContent = user.empleado.email;
                    document.getElementById('info-departamento').textContent = user.empleado.departamento;
                    document.getElementById('info-rol').textContent = user.empleado.rol;
                    document.getElementById('info-codigo').textContent = user.empleado.codigo_empleado;
                    document.getElementById('info-empleado').style.display = 'block';

                    // Establecer el IdEmpleado en un campo oculto o en el select (solo lectura visual)
                    const select = document.getElementById('selEmpleado');
                    select.innerHTML = `<option value="${user.empleado.idEmpleado}" selected>${user.empleado.codigo_empleado} - ${user.empleado.nombre} - ${user.empleado.departamento} - ${user.empleado.email}</option>`;
                    select.disabled = true; // Visualmente deshabilitado, pero el valor se envía

                    document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Usuario';
                    if (!state.modalInstance) {
                        state.modalInstance = new bootstrap.Modal(document.getElementById('modalUsuario'));
                    }
                    state.modalInstance.show();
                } catch (error) {
                    console.error('Error al cargar usuario:', error);
                    mostrarAlerta('Error al cargar usuario: ' + error.message, 'danger');
                }
            }

            // Guardar usuario
            async function guardarUsuario() {
                const form = document.getElementById('formUsuario');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const usuarioId = document.getElementById('usuarioId').value;
                const data = {
                    IdEmpleado: parseInt(document.getElementById('selEmpleado').value),
                    Username: document.getElementById('txtUsername').value.trim(),
                    Password: document.getElementById('txtPassword').value,
                    // Activo se maneja por el backend o por otro endpoint
                };

                try {
                    if (usuarioId) {
                        // Actualizar con todos los datos
                        await apiCall(`/api/usuarios/${usuarioId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        mostrarAlerta('Usuario actualizado exitosamente', 'success');
                    } else {
                        // Crear nuevo
                        await apiCall('/api/usuarios', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        mostrarAlerta('Usuario creado exitosamente', 'success');
                    }

                    if (state.modalInstance) {
                        state.modalInstance.hide();
                    }
                    await cargarUsuarios();
                    await cargarEmpleadosSinUsuario();
                } catch (error) {
                    console.error('Error al guardar:', error);
                    mostrarAlerta('Error al guardar: ' + error.message, 'danger');
                }
            }

            // Abrir modal para cambiar contraseña
            function cambiarPasswordModal(id, username) {
                console.log('Cambiando contraseña para usuario:', username);

                document.getElementById('passwordUsuarioId').value = id;
                document.getElementById('txtNewPassword').value = '';

                if (!state.modalPasswordInstance) {
                    state.modalPasswordInstance = new bootstrap.Modal(document.getElementById('modalPassword'));
                }
                state.modalPasswordInstance.show();
            }

            // Cambiar contraseña
            async function cambiarPassword() {
                const usuarioId = document.getElementById('passwordUsuarioId').value;
                const nuevaPassword = document.getElementById('txtNewPassword').value;

                if (!nuevaPassword || nuevaPassword.length < 6) {
                    mostrarAlerta('La contraseña debe tener al menos 6 caracteres', 'warning');
                    return;
                }

                try {
                    await apiCall(`/api/usuarios/${usuarioId}/cambiar-password`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            nuevaPassword: nuevaPassword
                        })
                    });

                    mostrarAlerta('Contraseña actualizada exitosamente', 'success');

                    if (state.modalPasswordInstance) {
                        state.modalPasswordInstance.hide();
                    }
                } catch (error) {
                    console.error('Error al cambiar contraseña:', error);
                    mostrarAlerta('Error al cambiar contraseña: ' + error.message, 'danger');
                }
            }

            // Eliminar usuario (desactivar)
            async function eliminarUsuario(id, username) {
                if (!confirm(`¿Estás seguro de desactivar al usuario "${username}"?\n\nEl usuario no podrá iniciar sesión pero se conservarán sus datos.`)) return;

                try {
                    await apiCall(`/api/usuarios/${id}`, { method: 'DELETE' });
                    mostrarAlerta('Usuario desactivado exitosamente', 'success');
                    await cargarUsuarios();
                    await cargarEmpleadosSinUsuario(); // Actualizar estadísticas
                } catch (error) {
                    mostrarAlerta('Error al desactivar: ' + error.message, 'danger');
                }
            }

            // Activar usuario
            async function activarUsuario(id, username) {
                if (!confirm(`¿Estás seguro de activar al usuario "${username}"?`)) return;
                try {
                    await apiCall(`/api/usuarios/${id}/activar`, { method: 'PUT' });
                    mostrarAlerta('Usuario activado exitosamente', 'success');
                    await cargarUsuarios();
                    await cargarEmpleadosSinUsuario(); // Actualizar estadísticas
                } catch (error) {
                    mostrarAlerta('Error al activar: ' + error.message, 'danger');
                }
            }

            // Mostrar alerta
            function mostrarAlerta(mensaje, tipo = 'info') {
                // Eliminar alertas anteriores
                const alertasAnteriores = document.querySelectorAll('.alert-fixed');
                alertasAnteriores.forEach(alerta => alerta.remove());

                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 alert-fixed`;
                alertDiv.style.zIndex = '9999';
                alertDiv.style.minWidth = '300px';
                alertDiv.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="bi ${tipo === 'success' ? 'bi-check-circle' : tipo === 'danger' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
                            <span>${mensaje}</span>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                document.body.appendChild(alertDiv);

                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 4000);
            }

            // Inicializar
            async function init() {
                console.log('Iniciando módulo de usuarios...');

                // Verificar que estamos en la vista correcta
                if (!document.getElementById('usuarios-container')) {
                    console.log('No estamos en la vista de usuarios, saliendo...');
                    return;
                }

                try {
                    // Cargar ambas fuentes de datos y ESPERAR a que terminen
                    console.log('Cargando datos iniciales...');

                    // Ejecutar ambas cargas en paralelo y esperar a que terminen
                    await Promise.all([
                        cargarUsuarios(),
                        cargarEmpleadosSinUsuario()
                    ]);

                    console.log('Ambos datasets cargados correctamente');

                    // Actualizar estadísticas con todos los datos disponibles
                    actualizarEstadisticas();

                    // Renderizar usuarios con datos completos
                    renderizarUsuarios();

                } catch (error) {
                    console.error('Error en inicialización:', error);
                    mostrarAlerta('Error al cargar los datos iniciales', 'danger');
                }

                // Configurar búsqueda global
                const inputBuscar = document.getElementById('input-buscar');
                if (inputBuscar) {
                    inputBuscar.addEventListener('input', (e) => {
                        const texto = e.target.value.toLowerCase();
                        const filtrados = state.usuarios.filter(user =>
                            user.username.toLowerCase().includes(texto) ||
                            (user.empleado?.nombre || '').toLowerCase().includes(texto) ||
                            (user.empleado?.email || '').toLowerCase().includes(texto)
                        );
                        const temp = state.usuarios;
                        state.usuarios = filtrados;
                        renderizarUsuarios();
                        state.usuarios = temp;
                    });
                }

                // Configurar filtro de estado
                const selectEstado = document.getElementById('select-estado');
                if (selectEstado) {
                    selectEstado.addEventListener('change', (e) => {
                        const estado = e.target.value;
                        let filtrados = state.usuarios;

                        if (estado === 'activo') {
                            filtrados = state.usuarios.filter(u => u.activo);
                        } else if (estado === 'inactivo') {
                            filtrados = state.usuarios.filter(u => !u.activo);
                        }

                        const temp = state.usuarios;
                        state.usuarios = filtrados;
                        renderizarUsuarios();
                        state.usuarios = temp;
                    });
                }

                // Configurar toggle de contraseñas
                document.getElementById('btnTogglePassword')?.addEventListener('click', function () {
                    const passwordInput = document.getElementById('txtPassword');
                    const icon = this.querySelector('i');
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.className = 'bi bi-eye-slash';
                    } else {
                        passwordInput.type = 'password';
                        icon.className = 'bi bi-eye';
                    }
                });

                document.getElementById('btnToggleNewPassword')?.addEventListener('click', function () {
                    const passwordInput = document.getElementById('txtNewPassword');
                    const icon = this.querySelector('i');
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.className = 'bi bi-eye-slash';
                    } else {
                        passwordInput.type = 'password';
                        icon.className = 'bi bi-eye';
                    }
                });

                console.log('Módulo de usuarios iniciado correctamente');
            }

            // Iniciar cuando el DOM esté listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }

            // API pública del módulo
            return {
                init,
                abrirModalNuevo,
                editarUsuario,
                guardarUsuario,
                cambiarPasswordModal,
                cambiarPassword,
                eliminarUsuario,
                activarUsuario
            };
        })();
    </script>
</body>
</html>