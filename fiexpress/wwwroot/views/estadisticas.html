<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Estadísticas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f7fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .stats-header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

            .stats-header h1 {
                font-size: 24px;
                font-weight: 600;
                color: #2c3e50;
                margin: 0;
                display: flex;
                align-items: center;
                gap: 12px;
            }

        .btn-actualizar {
            background: white;
            border: 1px solid #e0e0e0;
            color: #3498db;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

            .btn-actualizar:hover {
                background: #f8f9fa;
                border-color: #3498db;
            }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 42px;
            font-weight: 700;
            line-height: 1;
        }

        .stat-loading {
            width: 60px;
            height: 60px;
            display: inline-block;
        }

        .spinner-blue {
            color: #3498db;
        }

        .spinner-green {
            color: #2ecc71;
        }

        .spinner-yellow {
            color: #f1c40f;
        }

        .spinner-red {
            color: #e74c3c;
        }

        .spinner-cyan {
            color: #1abc9c;
        }

        .text-blue {
            color: #3498db;
        }

        .text-green {
            color: #2ecc71;
        }

        .text-yellow {
            color: #f1c40f;
        }

        .text-red {
            color: #e74c3c;
        }

        .text-cyan {
            color: #1abc9c;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="stats-header d-flex justify-content-between align-items-center">
            <h1>
                <i class="bi bi-bar-chart-fill" style="color: #3498db;"></i>
                Panel de Estadísticas de Empleados
            </h1>
            <button class="btn btn-actualizar" onclick="EstadisticasModule.cargarDatos()">
                <i class="bi bi-arrow-clockwise"></i>
                Actualizar Datos
            </button>
        </div>

        <!-- Primera fila de estadísticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">TOTAL REGISTROS</div>
                <div class="stat-value text-blue" id="total-registros">
                    <div class="spinner-border spinner-blue stat-loading" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-label">ASISTENCIA COMPLETA</div>
                <div class="stat-value text-green" id="asistencia-completa">
                    <div class="spinner-border spinner-green stat-loading" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-label">CON RETRASOS</div>
                <div class="stat-value text-yellow" id="con-retrasos">
                    <div class="spinner-border spinner-yellow stat-loading" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-label">FALTAS</div>
                <div class="stat-value text-red" id="faltas">
                    <div class="spinner-border spinner-red stat-loading" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Segunda fila de estadísticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">PROMEDIO MIN. TRABAJADOS</div>
                <div class="stat-value text-cyan" id="promedio-minutos">
                    <div class="spinner-border spinner-cyan stat-loading" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-label">TOTAL MIN. EXTRAS</div>
                <div class="stat-value text-blue" id="total-extras">
                    <div class="spinner-border spinner-blue stat-loading" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-label">% ASISTENCIA GENERAL</div>
                <div class="stat-value text-green" id="asistencia-general">
                    <div class="spinner-border spinner-green stat-loading" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de empleados -->
        <div class="card mt-4" style="display: none;" id="tabla-empleados-container">
            <div class="card-header bg-white">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0">Detalle por Empleado</h5>
                    </div>
                    <div class="col-md-6">
                        <input type="text"
                               class="form-control"
                               id="buscar-empleado"
                               placeholder="🔍 Buscar por nombre o código..."
                               style="border-radius: 8px;">
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th class="text-center">Días Trabajados</th>
                                <th class="text-center">Min. Retraso</th>
                                <th class="text-center">Min. Extra</th>
                                <th class="text-center">% Asistencia</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-empleados-body">
                        </tbody>
                    </table>
                </div>
                <div id="no-resultados" style="display: none;" class="text-center py-4 text-muted">
                    <i class="bi bi-search" style="font-size: 48px;"></i>
                    <p class="mt-2">No se encontraron empleados con ese criterio de búsqueda</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.EstadisticasModule = (function () {
            'use strict';

            const state = {
                generales: null
            };

            // API Helper
            async function apiCall(url, options = {}) {
                try {
                    const response = await fetch(url, {
                        credentials: 'include',
                        ...options
                    });

                    if (!response.ok) {
                        throw new Error(`Error ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Error:', error);
                    throw error;
                }
            }

            // Cargar Estadísticas Generales
            async function cargarEstadisticasGenerales() {
                try {
                    state.generales = await apiCall('/api/estadisticas/generales?periodo=mes');
                    calcularYMostrarEstadisticas();
                } catch (error) {
                    console.error('Error al cargar estadísticas:', error);
                    mostrarError();
                }
            }

            // Calcular y mostrar estadísticas
            function calcularYMostrarEstadisticas() {
                if (!state.generales) return;

                const { resumen, empleados } = state.generales;

                // TOTAL REGISTROS - Total de días trabajados por todos los empleados
                document.getElementById('total-registros').textContent = resumen.totalDiasTrabajados;

                // ASISTENCIA COMPLETA - Empleados con 100% asistencia y sin retrasos
                const asistenciaCompleta = empleados.filter(emp => {
                    const porcentaje = emp.totalDias > 0 ? (emp.diasTrabajados / emp.totalDias) * 100 : 0;
                    return porcentaje === 100 && emp.minutosRetraso === 0;
                }).length;
                document.getElementById('asistencia-completa').textContent = asistenciaCompleta;

                // CON RETRASOS - Empleados que tienen minutos de retraso
                const conRetrasos = empleados.filter(emp => emp.minutosRetraso > 0).length;
                document.getElementById('con-retrasos').textContent = conRetrasos;

                // FALTAS - Suma de días no trabajados
                const totalFaltas = empleados.reduce((sum, emp) => {
                    return sum + (emp.totalDias - emp.diasTrabajados);
                }, 0);
                document.getElementById('faltas').textContent = totalFaltas;

                // PROMEDIO MIN. TRABAJADOS - Promedio de minutos trabajados por empleado
                // Asumiendo 8 horas (480 min) por día trabajado
                const totalMinutosTrabajados = empleados.reduce((sum, emp) => {
                    return sum + (emp.diasTrabajados * 480) + emp.minutosExtra - emp.minutosRetraso;
                }, 0);
                const promedioMinutos = empleados.length > 0
                    ? Math.round(totalMinutosTrabajados / empleados.length)
                    : 0;
                document.getElementById('promedio-minutos').textContent = promedioMinutos;

                // TOTAL MIN. EXTRAS
                document.getElementById('total-extras').textContent = resumen.totalMinutosExtra;

                // % ASISTENCIA GENERAL
                document.getElementById('asistencia-general').textContent = resumen.porcentajeAsistenciaGeneral + '%';

                // Opcional: Llenar tabla de empleados
                llenarTablaEmpleados(empleados);
            }

            // Llenar tabla de empleados (opcional)
            function llenarTablaEmpleados(empleados) {
                const tbody = document.getElementById('tabla-empleados-body');
                if (!tbody) return;

                tbody.innerHTML = empleados.map(emp => {
                    const porcentaje = emp.totalDias > 0
                        ? ((emp.diasTrabajados / emp.totalDias) * 100).toFixed(1)
                        : 0;

                    return `
                            <tr>
                                <td><span class="badge bg-secondary">${emp.codigo}</span></td>
                                <td><strong>${emp.nombre}</strong></td>
                                <td class="text-center">${emp.diasTrabajados} / ${emp.totalDias}</td>
                                <td class="text-center">
                                    <span class="badge ${emp.minutosRetraso > 0 ? 'bg-warning text-dark' : 'bg-light text-dark'}">
                                        ${emp.minutosRetraso}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge ${emp.minutosExtra > 0 ? 'bg-success' : 'bg-light text-dark'}">
                                        ${emp.minutosExtra}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-${porcentaje >= 95 ? 'success' : porcentaje >= 80 ? 'warning text-dark' : 'danger'}">
                                        ${porcentaje}%
                                    </span>
                                </td>
                            </tr>
                        `;
                }).join('');

                // Mostrar tabla si hay datos
                document.getElementById('tabla-empleados-container').style.display = 'block';
            }

            // Mostrar error en las tarjetas
            function mostrarError() {
                const ids = [
                    'total-registros',
                    'asistencia-completa',
                    'con-retrasos',
                    'faltas',
                    'promedio-minutos',
                    'total-extras',
                    'asistencia-general'
                ];

                ids.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.innerHTML = '<i class="bi bi-exclamation-triangle"></i>';
                        element.style.fontSize = '32px';
                    }
                });
            }

            // Cargar datos
            async function cargarDatos() {
                // Mostrar spinners
                const ids = [
                    'total-registros',
                    'asistencia-completa',
                    'con-retrasos',
                    'faltas',
                    'promedio-minutos',
                    'total-extras',
                    'asistencia-general'
                ];

                const spinnerClasses = [
                    'spinner-blue',
                    'spinner-green',
                    'spinner-yellow',
                    'spinner-red',
                    'spinner-cyan',
                    'spinner-blue',
                    'spinner-green'
                ];

                ids.forEach((id, index) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.innerHTML = `
                                <div class="spinner-border ${spinnerClasses[index]} stat-loading" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            `;
                    }
                });

                await cargarEstadisticasGenerales();
            }

            // Inicializar
            async function init() {
                await cargarDatos();
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }

            return {
                cargarDatos
            };
        })();
    </script>
</body>
</html>
