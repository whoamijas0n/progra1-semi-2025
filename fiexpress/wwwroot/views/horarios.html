<!-- Vista de Gestión de Horarios -->
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<div class="container-fluid py-4" id="horarios-container">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="bi bi-calendar-week text-primary"></i>
                Gestión de Horarios
            </h2>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <h6 class="text-muted">Total Horarios</h6>
                    <h3 id="stat-total">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <h6 class="text-muted">Activos</h6>
                    <h3 class="text-success" id="stat-activos">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <h6 class="text-muted">Turnos Configurados</h6>
                    <h3 class="text-warning" id="stat-turnos">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-info border-4">
                <div class="card-body">
                    <h6 class="text-muted">Empleados con Horario</h6>
                    <h3 class="text-info" id="stat-empleados">0</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de búsqueda y acciones -->
    <div class="row mb-4">
        <div class="col-md-4">
            <input type="text" class="form-control" id="input-buscar" placeholder="🔍 Buscar por empleado o turno...">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="select-empleado">
                <option value="">Todos los empleados</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="select-estado">
                <option value="">Todos los estados</option>
                <option value="activo">Activos</option>
                <option value="inactivo">Inactivos</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="HorariosModule.abrirModalNuevo()">
                <i class="bi bi-plus-lg"></i> Nuevo Horario
            </button>
        </div>
    </div>

    <!-- Lista de horarios -->
    <div class="row g-3" id="lista-horarios">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear/Editar Horario -->
<div class="modal fade" id="modalHorario" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Nuevo Horario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formHorario">
                    <input type="hidden" id="horarioId">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Empleado *</label>
                            <select class="form-select" id="selEmpleado" required>
                                <option value="">Seleccione un empleado...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Turno *</label>
                            <select class="form-select" id="selTurno" required>
                                <option value="">Seleccione un turno...</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha Inicio *</label>
                            <input type="date" class="form-control" id="txtFechaInicio" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha Fin (Opcional)</label>
                            <input type="date" class="form-control" id="txtFechaFin">
                            <small class="text-muted">Dejar vacío si es horario indefinido</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="chkActivo" checked>
                                <label class="form-check-label" for="chkActivo">Horario activo</label>
                            </div>
                            <small class="text-muted">Los horarios inactivos no se consideran en los cálculos</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="HorariosModule.guardarHorario()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ✅ MÓDULO CORREGIDO - Con todas las funcionalidades
    window.HorariosModule = (function () {
        'use strict';

        const state = {
            horarios: [],
            empleados: [],
            turnos: [],
            modalInstance: null
        };

        // ✅ API Helper
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    credentials: 'include',
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        // ✅ Cargar horarios
        async function cargarHorarios() {
            try {
                state.horarios = await apiCall('/api/horarios');
                actualizarEstadisticas(); // ✅ LLAMAR A ESTADÍSTICAS
                renderizarHorarios();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('lista-horarios').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            Error al cargar horarios
                        </div>
                    </div>
                `;
            }
        }

        // ✅ Cargar empleados
        async function cargarEmpleados() {
            try {
                state.empleados = await apiCall('/api/empleados?incluirInactivos=false');
                llenarSelectEmpleados();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ✅ Cargar turnos
        async function cargarTurnos() {
            try {
                state.turnos = await apiCall('/api/turnos?incluirInactivos=false');
                llenarSelectTurnos();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ✅ Llenar selects
        function llenarSelectEmpleados() {
            const selectFiltro = document.getElementById('select-empleado');
            const selectModal = document.getElementById('selEmpleado');

            if (selectFiltro) {
                selectFiltro.innerHTML = '<option value="">Todos los empleados</option>';
                state.empleados.forEach(emp => {
                    selectFiltro.innerHTML += `<option value="${emp.idEmpleado}">${emp.nombre}</option>`;
                });
            }

            if (selectModal) {
                selectModal.innerHTML = '<option value="">Seleccione un empleado</option>';
                state.empleados.forEach(emp => {
                    selectModal.innerHTML += `<option value="${emp.idEmpleado}">${emp.codigo_empleado} - ${emp.nombre}</option>`;
                });
            }
        }

        function llenarSelectTurnos() {
            const selectModal = document.getElementById('selTurno');
            if (selectModal) {
                selectModal.innerHTML = '<option value="">Seleccione un turno</option>';
                state.turnos.forEach(turno => {
                    selectModal.innerHTML += `<option value="${turno.idTurno}">${turno.nombre} (${turno.hora_entrada} - ${turno.hora_salida})</option>`;
                });
            }
        }

        // ✅ ACTUALIZAR ESTADÍSTICAS (FUNCIÓN CORREGIDA)
        function actualizarEstadisticas() {
            const total = state.horarios.length;
            const activos = state.horarios.filter(h => h.activo).length;
            const turnosUnicos = [...new Set(state.horarios.map(h => h.turno?.idTurno))].length;
            const empleadosUnicos = [...new Set(state.horarios.map(h => h.empleado?.idEmpleado))].length;

            // ✅ ACTUALIZAR LOS ELEMENTOS CORRECTAMENTE
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-activos').textContent = activos;
            document.getElementById('stat-turnos').textContent = turnosUnicos;
            document.getElementById('stat-empleados').textContent = empleadosUnicos;
        }

        // ✅ RENDERIZAR HORARIOS (MEJORADO)
        function renderizarHorarios() {
            const container = document.getElementById('lista-horarios');
            if (!container) return;

            if (state.horarios.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="bi bi-calendar-week fs-1 d-block mb-3"></i>
                            <h5>No hay horarios registrados</h5>
                            <p>Haz clic en "Nuevo Horario" para asignar uno</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = state.horarios.map(horario => `
                <div class="col-md-6 col-lg-4 col-xl-3">
                    <div class="card h-100 ${!horario.activo ? 'opacity-50' : ''}">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <img src="${horario.empleado?.foto_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(horario.empleado?.nombre || 'Empleado') + '&size=100'}"
                                     class="rounded-circle me-3"
                                     style="width: 50px; height: 50px; object-fit: cover;"
                                     alt="${horario.empleado?.nombre}">
                                <div>
                                    <h6 class="card-title mb-0">${horario.empleado?.nombre || 'N/A'}</h6>
                                    <small class="text-muted">${horario.empleado?.codigo_empleado || ''}</small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <span class="badge bg-primary">${horario.turno?.nombre || 'N/A'}</span>
                                <span class="badge bg-secondary">${horario.turno?.hora_entrada || ''} - ${horario.turno?.hora_salida || ''}</span>
                            </div>

                            <div class="small text-muted mb-2">
                                <div><strong>Inicio:</strong> ${horario.fecha_inicio}</div>
                                ${horario.fecha_fin ? `<div><strong>Fin:</strong> ${horario.fecha_fin}</div>` : '<div><strong>Fin:</strong> Indefinido</div>'}
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge ${horario.activo ? 'bg-success' : 'bg-secondary'}">
                                    ${horario.activo ? 'Activo' : 'Inactivo'}
                                </span>
                            </div>

                            <div class="btn-group w-100">
                                <button class="btn btn-sm btn-outline-primary" onclick="HorariosModule.editarHorario(${horario.idHorario})">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="HorariosModule.eliminarHorario(${horario.idHorario}, '${horario.empleado?.nombre}')">
                                    <i class="bi bi-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ✅ ABRIR MODAL NUEVO
        async function abrirModalNuevo() {
            await cargarEmpleados();
            await cargarTurnos();

            document.getElementById('formHorario').reset();
            document.getElementById('horarioId').value = '';
            document.getElementById('modalTitle').textContent = 'Nuevo Horario';
            document.getElementById('chkActivo').checked = true;

            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('txtFechaInicio').value = hoy;

            if (!state.modalInstance) {
                state.modalInstance = new bootstrap.Modal(document.getElementById('modalHorario'));
            }
            state.modalInstance.show();
        }

        // ✅ EDITAR HORARIO
        async function editarHorario(id) {
            try {
                const horario = await apiCall(`/api/horarios/${id}`);

                document.getElementById('horarioId').value = horario.idHorario;
                document.getElementById('selEmpleado').value = horario.idHorario_De_Empleado;
                document.getElementById('selTurno').value = horario.idTurno;
                document.getElementById('txtFechaInicio').value = horario.fecha_inicio;
                document.getElementById('txtFechaFin').value = horario.fecha_fin || '';
                document.getElementById('chkActivo').checked = horario.activo;
                document.getElementById('modalTitle').textContent = 'Editar Horario';

                if (!state.modalInstance) {
                    state.modalInstance = new bootstrap.Modal(document.getElementById('modalHorario'));
                }
                state.modalInstance.show();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ✅ GUARDAR HORARIO - CON CONFIRMACIÓN
        async function guardarHorario() {
            const form = document.getElementById('formHorario');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                IdEmpleado: parseInt(document.getElementById('selEmpleado').value),
                IdTurno: parseInt(document.getElementById('selTurno').value),
                FechaInicio: document.getElementById('txtFechaInicio').value,
                FechaFin: document.getElementById('txtFechaFin').value || null,
                Activo: document.getElementById('chkActivo').checked
            };

            try {
                const horarioId = document.getElementById('horarioId').value;

                if (horarioId) {
                    await apiCall(`/api/horarios/${horarioId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    // ✅ MOSTRAR CONFIRMACIÓN
                    mostrarAlerta('Horario actualizado exitosamente', 'success');
                } else {
                    await apiCall('/api/horarios', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    // ✅ MOSTRAR CONFIRMACIÓN
                    mostrarAlerta('Horario creado exitosamente', 'success');
                }

                // ✅ CERRAR MODAL Y RECARGAR DATOS
                if (state.modalInstance) {
                    state.modalInstance.hide();
                }
                await cargarHorarios(); // ✅ RECARGAR DATOS AUTOMÁTICAMENTE

            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al guardar horario', 'danger');
            }
        }

        // ✅ ELIMINAR HORARIO - CON CONFIRMACIÓN
        async function eliminarHorario(id, nombreEmpleado) {
            if (!confirm(`¿Estás seguro de eliminar el horario de ${nombreEmpleado}?`)) return;

            try {
                await apiCall(`/api/horarios/${id}`, { method: 'DELETE' });
                // ✅ MOSTRAR CONFIRMACIÓN
                mostrarAlerta('Horario eliminado exitosamente', 'success');
                await cargarHorarios(); // ✅ RECARGAR DATOS AUTOMÁTICAMENTE
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al eliminar horario', 'danger');
            }
        }

        // ✅ FUNCIÓN MOSTRAR ALERTA
        function mostrarAlerta(mensaje, tipo = 'info') {
            // Remover alertas existentes
            const existingAlerts = document.querySelectorAll('.alert.position-fixed');
            existingAlerts.forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 4000);
        }

        // ✅ CONFIGURAR FILTROS
        function configurarFiltros() {
            const inputBuscar = document.getElementById('input-buscar');
            if (inputBuscar) {
                inputBuscar.addEventListener('input', (e) => {
                    const texto = e.target.value.toLowerCase();
                    const filtrados = state.horarios.filter(horario =>
                        (horario.empleado?.nombre || '').toLowerCase().includes(texto) ||
                        (horario.turno?.nombre || '').toLowerCase().includes(texto)
                    );
                    const temp = state.horarios;
                    state.horarios = filtrados;
                    renderizarHorarios();
                    actualizarEstadisticas(); // ✅ ACTUALIZAR ESTADÍSTICAS AL FILTRAR
                    state.horarios = temp;
                });
            }

            const selectEmpleado = document.getElementById('select-empleado');
            if (selectEmpleado) {
                selectEmpleado.addEventListener('change', (e) => {
                    const empleadoId = e.target.value;
                    let filtrados = state.horarios;

                    if (empleadoId) {
                        filtrados = state.horarios.filter(horario =>
                            horario.empleado?.idEmpleado == empleadoId
                        );
                    }

                    const temp = state.horarios;
                    state.horarios = filtrados;
                    renderizarHorarios();
                    actualizarEstadisticas(); // ✅ ACTUALIZAR ESTADÍSTICAS AL FILTRAR
                    state.horarios = temp;
                });
            }

            const selectEstado = document.getElementById('select-estado');
            if (selectEstado) {
                selectEstado.addEventListener('change', (e) => {
                    const estado = e.target.value;
                    let filtrados = state.horarios;

                    if (estado === 'activo') {
                        filtrados = state.horarios.filter(h => h.activo);
                    } else if (estado === 'inactivo') {
                        filtrados = state.horarios.filter(h => !h.activo);
                    }

                    const temp = state.horarios;
                    state.horarios = filtrados;
                    renderizarHorarios();
                    actualizarEstadisticas(); // ✅ ACTUALIZAR ESTADÍSTICAS AL FILTRAR
                    state.horarios = temp;
                });
            }
        }

        // ✅ INICIALIZAR
        async function init() {
            if (!document.getElementById('horarios-container')) return;

            await Promise.all([
                cargarHorarios(),
                cargarEmpleados(),
                cargarTurnos()
            ]);

            configurarFiltros();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        return {
            abrirModalNuevo,
            editarHorario,
            guardarHorario,
            eliminarHorario
        };
    })();
</script>