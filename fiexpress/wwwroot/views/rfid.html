<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="bi bi-credit-card text-warning"></i> Gestión de Tarjetas RFID
            </h2>
            <p class="text-muted">Administra las tarjetas RFID asignadas a los empleados</p>
        </div>
    </div>

    <!-- ✅ BOTÓN DE LECTURA DE TARJETAS NO REGISTRADAS -->
    <div class="row mb-4">
        <div class="col-12">
            <button class="btn btn-outline-info" onclick="RFIDModule.iniciarModoCaptura()">
                <i class="bi bi-qr-code-scan"></i> Leer Tarjeta Nueva (No Registrada)
            </button>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <h6 class="text-muted">Tarjetas Activas</h6>
                    <h3 id="total-tarjetas-activas">0</h3>
                    <small class="text-muted">En uso</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <h6 class="text-muted">Empleados con Tarjeta</h6>
                    <h3 class="text-success" id="empleados-con-tarjeta">0</h3>
                    <small class="text-muted">Asignaciones activas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-info border-4">
                <div class="card-body">
                    <h6 class="text-muted">Sin Tarjeta</h6>
                    <h3 class="text-info" id="empleados-sin-tarjeta">0</h3>
                    <small class="text-muted">Pendientes</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-secondary border-4">
                <div class="card-body">
                    <h6 class="text-muted">Tarjetas Inactivas</h6>
                    <h3 class="text-secondary" id="tarjetas-inactivas">0</h3>
                    <small class="text-muted">Desactivadas</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Controles -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Buscar</label>
                    <input type="text" class="form-control" id="buscar-rfid" placeholder="Código, empleado, código empleado...">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Estado</label>
                    <select class="form-select" id="filtro-estado-rfid">
                        <option value="">Todos</option>
                        <option value="activo">Activas</option>
                        <option value="inactivo">Inactivas</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button class="btn btn-warning" onclick="RFIDModule.mostrarModalAsignar()">
                            <i class="bi bi-plus-circle"></i> Asignar Nueva Tarjeta
                        </button>
                        <button class="btn btn-outline-primary" onclick="RFIDModule.cargarTarjetas()">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Tarjetas -->
    <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-credit-card-2-front"></i> Tarjetas RFID
                <span class="badge bg-warning ms-2" id="contador-tarjetas">0</span>
            </h5>
            <span class="text-muted small" id="ultima-actualizacion"></span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Código RFID</th>
                            <th>Empleado</th>
                            <th>Departamento</th>
                            <th>Fecha Asignación</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-tarjetas">
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                Cargando...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ✅ MODAL: Lectura de tarjeta no registrada -->
<div class="modal fade" id="modalCapturaRFID" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-qr-code-scan text-info"></i> Lectura de Tarjeta Nueva</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="estado-captura">
                    <i class="bi bi-credit-card fs-1 text-muted mb-3 d-block"></i>
                    <p>Acerca una tarjeta <strong>no registrada</strong> al lector RFID</p>
                    <p class="text-muted small">Tienes 30 segundos</p>
                    <div class="spinner-border text-info" role="status"></div>
                </div>
                <div id="resultado-captura" style="display:none;">
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle-fill"></i> ¡Tarjeta detectada!</h5>
                        <p class="fs-5"><code id="codigo-capturado"></code></p>
                        <button class="btn btn-outline-secondary" onclick="RFIDModule.copiarCodigo()">
                            <i class="bi bi-clipboard"></i> Copiar código
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Asignar -->
<div class="modal fade" id="modalAsignarRFID" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-credit-card text-warning"></i> Asignar Tarjeta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Empleado *</label>
                        <select class="form-select" id="selectEmpleadoRFID" required>
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Código RFID *</label>
                        <input type="text" class="form-control" id="inputCodigoRFID" maxlength="50" placeholder="Ej: A1B2C3D4">
                        <div class="form-text">Copia el código desde una tarjeta no registrada</div>
                    </div>
                </div>
                <div class="card bg-light mt-3" id="infoEmpleadoCard" style="display:none;">
                    <div class="card-body">
                        <h6>Información del empleado</h6>
                        <small><strong>Nombre:</strong> <span id="infoNombre">-</span></small><br>
                        <small><strong>Departamento:</strong> <span id="infoDepartamento">-</span></small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btnAsignar" onclick="RFIDModule.asignarTarjeta()">
                    <span id="btnAsignarText">Asignar</span>
                    <span id="btnAsignarSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Editar -->
<div class="modal fade" id="modalEditarRFID" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil-square text-primary"></i> Editar Tarjeta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTarjetaId">
                <div class="mb-3">
                    <label class="form-label">Código RFID</label>
                    <input type="text" class="form-control" id="editCodigoRFID" maxlength="50">
                </div>
                <div class="mb-3">
                    <label class="form-label">Empleado</label>
                    <input type="text" class="form-control" id="editEmpleadoNombre" readonly>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="editActivo">
                    <label class="form-check-label" for="editActivo">Activa</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardar" onclick="RFIDModule.guardarEdicion()">
                    <span id="btnGuardarText">Guardar</span>
                    <span id="btnGuardarSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    window.RFIDModule = (function () {
        'use strict';
        const state = {
            tarjetas: [],
            modalAsignar: null,
            modalEditar: null,
            modalCaptura: null
        };

        async function cargarTarjetas() {
            try {
                mostrarLoading();
                const res = await fetchAuth('/api/rfid?incluirInactivos=true');
                state.tarjetas = await res.json();
                renderizarTarjetas();
                actualizarEstadisticas();
                actualizarTimestamp();
            } catch (err) {
                mostrarError('Error al cargar tarjetas');
            }
        }

        async function cargarEmpleadosSinTarjeta() {
            try {
                const res = await fetchAuth('/api/rfid/empleados-sin-tarjeta');
                const empleados = await res.json();
                const select = document.getElementById('selectEmpleadoRFID');
                select.innerHTML = '<option value="">Seleccionar...</option>';
                empleados.forEach(e => {
                    select.innerHTML += `<option value="${e.idEmpleado}" data-nombre="${e.nombre}" data-departamento="${e.departamento}">${e.codigo_empleado} - ${e.nombre}</option>`;
                });
            } catch (err) {
                console.error('Error al cargar empleados sin tarjeta:', err);
            }
        }

        function llenarSelectEmpleados() {
            const select = document.getElementById('selectEmpleadoRFID');
            select.onchange = function () {
                const opt = this.options[this.selectedIndex];
                if (opt.value) {
                    document.getElementById('infoNombre').textContent = opt.dataset.nombre;
                    document.getElementById('infoDepartamento').textContent = opt.dataset.departamento;
                    document.getElementById('infoEmpleadoCard').style.display = 'block';
                } else {
                    document.getElementById('infoEmpleadoCard').style.display = 'none';
                }
            };
        }

        // ✅ INICIAR MODO CAPTURA
        async function iniciarModoCaptura() {
            try {
                await fetchAuth('/api/rfid/capture/start', { method: 'POST' });
                if (!state.modalCaptura) {
                    state.modalCaptura = new bootstrap.Modal(document.getElementById('modalCapturaRFID'));
                }
                state.modalCaptura.show();
                document.getElementById('estado-captura').style.display = 'block';
                document.getElementById('resultado-captura').style.display = 'none';

                // Polling cada 2 segundos
                const interval = setInterval(async () => {
                    try {
                        const res = await fetchAuth('/api/rfid/capture/result');
                        const data = await res.json();
                        if (data.rfid) {
                            document.getElementById('codigo-capturado').textContent = data.rfid;
                            document.getElementById('estado-captura').style.display = 'none';
                            document.getElementById('resultado-captura').style.display = 'block';
                            clearInterval(interval);
                        }
                    } catch (err) {
                        console.error('Error en polling:', err);
                    }
                }, 2000);

                setTimeout(() => {
                    clearInterval(interval);
                    if (document.getElementById('estado-captura').style.display !== 'none') {
                        document.getElementById('estado-captura').innerHTML = '<p class="text-danger">Tiempo agotado</p>';
                    }
                }, 30000);
            } catch (err) {
                mostrarAlerta('Error al iniciar modo de captura', 'danger');
            }
        }

        // ✅ COPIAR CÓDIGO CAPTURADO
        function copiarCodigo() {
            const codigo = document.getElementById('codigo-capturado').textContent;
            navigator.clipboard.writeText(codigo).then(() => {
                document.getElementById('inputCodigoRFID').value = codigo;
                document.getElementById('resultado-captura').style.display = 'none';
                if (!state.modalAsignar) {
                    state.modalAsignar = new bootstrap.Modal(document.getElementById('modalAsignarRFID'));
                }
                state.modalAsignar.show();
                state.modalCaptura.hide();
            });
        }

        async function mostrarModalAsignar() {
            await cargarEmpleadosSinTarjeta();
            document.getElementById('formAsignarRFID')?.reset();
            document.getElementById('infoEmpleadoCard').style.display = 'none';
            llenarSelectEmpleados();
            if (!state.modalAsignar) {
                state.modalAsignar = new bootstrap.Modal(document.getElementById('modalAsignarRFID'));
            }
            state.modalAsignar.show();
        }

        async function asignarTarjeta() {
            const empleadoId = document.getElementById('selectEmpleadoRFID').value;
            const codigo = document.getElementById('inputCodigoRFID').value.trim();
            if (!empleadoId || !codigo) {
                mostrarAlerta('Completa todos los campos', 'warning');
                return;
            }
            if (state.tarjetas.some(t => t.codigo_rfid === codigo)) {
                mostrarAlerta('El código RFID ya está en uso', 'warning');
                return;
            }
            toggleBotonAsignar(true);
            try {
                const res = await fetchAuth('/api/rfid', {
                    method: 'POST',
                    body: JSON.stringify({ codigoRfid: codigo, idEmpleado: parseInt(empleadoId) })
                });
                if (res.ok) {
                    mostrarAlerta('✅ Tarjeta asignada', 'success');
                    state.modalAsignar.hide();
                    await cargarTarjetas();
                } else {
                    const err = await res.json();
                    mostrarAlerta(err.mensaje || 'Error al asignar', 'danger');
                }
            } catch (err) {
                mostrarAlerta('Error de red', 'danger');
            } finally {
                toggleBotonAsignar(false);
            }
        }

        async function editarTarjeta(id) {
            const t = state.tarjetas.find(x => x.idRfid === id);
            if (!t) return;
            document.getElementById('editTarjetaId').value = id;
            document.getElementById('editCodigoRFID').value = t.codigo_rfid;
            document.getElementById('editEmpleadoNombre').value = t.empleado?.nombre || '—';
            document.getElementById('editActivo').checked = t.activo;
            if (!state.modalEditar) {
                state.modalEditar = new bootstrap.Modal(document.getElementById('modalEditarRFID'));
            }
            state.modalEditar.show();
        }

        async function guardarEdicion() {
            const id = document.getElementById('editTarjetaId').value;
            const codigo = document.getElementById('editCodigoRFID').value.trim();
            const activo = document.getElementById('editActivo').checked;
            if (!codigo) {
                mostrarAlerta('El código RFID es obligatorio', 'warning');
                return;
            }
            toggleBotonGuardar(true);
            try {
                const t = state.tarjetas.find(x => x.idRfid == id);
                if (!t) throw new Error('Tarjeta no encontrada');
                const res = await fetchAuth(`/api/rfid/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ codigoRfid: codigo, idEmpleado: t.idEmpleadoAsignado })
                });
                if (res.ok) {
                    if (activo !== t.activo) {
                        const url = activo ? `/api/rfid/${id}/activar` : `/api/rfid/${id}`;
                        await fetchAuth(url, { method: activo ? 'PUT' : 'DELETE' });
                    }
                    mostrarAlerta('✅ Tarjeta actualizada', 'success');
                    state.modalEditar.hide();
                    await cargarTarjetas();
                } else {
                    const err = await res.json();
                    mostrarAlerta(err.mensaje || 'Error al actualizar', 'danger');
                }
            } catch (err) {
                mostrarAlerta('Error al guardar', 'danger');
            } finally {
                toggleBotonGuardar(false);
            }
        }

        async function cambiarEstado(id, activar) {
            try {
                const url = activar ? `/api/rfid/${id}/activar` : `/api/rfid/${id}`;
                const method = activar ? 'PUT' : 'DELETE';
                const res = await fetchAuth(url, { method });
                if (res.ok) {
                    await cargarTarjetas();
                    mostrarAlerta(`✅ Tarjeta ${activar ? 'activada' : 'desactivada'}`, 'success');
                } else {
                    mostrarAlerta('Error al cambiar estado', 'danger');
                }
            } catch (err) {
                mostrarAlerta('Error de red', 'danger');
            }
        }

        function toggleBotonAsignar(loading) {
            const btn = document.getElementById('btnAsignar');
            const text = document.getElementById('btnAsignarText');
            const spinner = document.getElementById('btnAsignarSpinner');
            if (loading) {
                btn.disabled = true;
                text.classList.add('d-none');
                spinner.classList.remove('d-none');
            } else {
                btn.disabled = false;
                text.classList.remove('d-none');
                spinner.classList.add('d-none');
            }
        }

        function toggleBotonGuardar(loading) {
            const btn = document.getElementById('btnGuardar');
            const text = document.getElementById('btnGuardarText');
            const spinner = document.getElementById('btnGuardarSpinner');
            if (loading) {
                btn.disabled = true;
                text.classList.add('d-none');
                spinner.classList.remove('d-none');
            } else {
                btn.disabled = false;
                text.classList.remove('d-none');
                spinner.classList.add('d-none');
            }
        }

        function renderizarTarjetas() {
            const tbody = document.getElementById('tabla-tarjetas');
            const buscar = document.getElementById('buscar-rfid').value.toLowerCase();
            const estado = document.getElementById('filtro-estado-rfid').value;
            let filtradas = state.tarjetas;
            if (buscar) {
                filtradas = filtradas.filter(t =>
                    t.codigo_rfid.toLowerCase().includes(buscar) ||
                    (t.empleado?.nombre || '').toLowerCase().includes(buscar) ||
                    (t.empleado?.codigo_empleado || '').toLowerCase().includes(buscar) ||
                    (t.empleado?.departamento || '').toLowerCase().includes(buscar)
                );
            }
            if (estado) {
                filtradas = filtradas.filter(t => estado === 'activo' ? t.activo : !t.activo);
            }
            document.getElementById('contador-tarjetas').textContent = filtradas.length;
            if (filtradas.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4"><i class="bi bi-inbox fs-1 d-block mb-2"></i>No se encontraron tarjetas</td></tr>`;
                return;
            }
            tbody.innerHTML = filtradas.map(t => `
            <tr class="${!t.activo ? 'table-light' : ''}">
                <td><code>${t.codigo_rfid}</code></td>
                <td><strong>${t.empleado?.nombre || '—'}</strong></td>
                <td>${t.empleado?.departamento || '—'}</td>
                <td>${formatearFecha(t.fecha_asignacion)}</td>
                <td>${t.activo ? '<span class="badge bg-success">Activa</span>' : '<span class="badge bg-secondary">Inactiva</span>'}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="RFIDModule.editarTarjeta(${t.idRfid})"><i class="bi bi-pencil"></i></button>
                        ${t.activo ?
                    `<button class="btn btn-outline-danger" onclick="RFIDModule.cambiarEstado(${t.idRfid}, false)"><i class="bi bi-power"></i></button>` :
                    `<button class="btn btn-outline-success" onclick="RFIDModule.cambiarEstado(${t.idRfid}, true)"><i class="bi bi-power"></i></button>`
                }
                    </div>
                </td>
            </tr>
        `).join('');
        }

        function actualizarEstadisticas() {
            const activas = state.tarjetas.filter(t => t.activo).length;
            const inactivas = state.tarjetas.length - activas;
            const empleadosCon = new Set(state.tarjetas.filter(t => t.activo).map(t => t.idEmpleadoAsignado)).size;
            document.getElementById('total-tarjetas-activas').textContent = activas;
            document.getElementById('empleados-con-tarjeta').textContent = empleadosCon;
            document.getElementById('tarjetas-inactivas').textContent = inactivas;
            fetchAuth('/api/rfid/empleados-sin-tarjeta')
                .then(r => r.json())
                .then(e => document.getElementById('empleados-sin-tarjeta').textContent = e.length)
                .catch(() => { });
        }

        function formatearFecha(f) {
            if (!f) return '—';
            return new Date(f).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function actualizarTimestamp() {
            document.getElementById('ultima-actualizacion').textContent = new Date().toLocaleTimeString();
        }

        function mostrarLoading() {
            document.getElementById('tabla-tarjetas').innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4"><div class="spinner-border spinner-border-sm me-2" role="status"></div>Cargando...</td></tr>`;
        }

        function mostrarError(mensaje) {
            document.getElementById('tabla-tarjetas').innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4"><i class="bi bi-exclamation-triangle fs-1 d-block mb-2"></i>${mensaje}</td></tr>`;
        }

        function mostrarAlerta(mensaje, tipo = 'info') {
            const div = document.createElement('div');
            div.className = `alert alert-${tipo} position-fixed bottom-0 end-0 m-3`;
            div.style.zIndex = '9999';
            div.innerHTML = `${mensaje} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function init() {
            cargarTarjetas();
            document.getElementById('buscar-rfid').addEventListener('input', renderizarTarjetas);
            document.getElementById('filtro-estado-rfid').addEventListener('change', renderizarTarjetas);
            setInterval(cargarTarjetas, 30000);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        return {
            cargarTarjetas,
            mostrarModalAsignar,
            asignarTarjeta,
            editarTarjeta,
            guardarEdicion,
            cambiarEstado,
            iniciarModoCaptura,
            copiarCodigo
        };
    })();
</script>