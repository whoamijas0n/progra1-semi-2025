<!-- Vista de Gestión de Empleados -->
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<div class="container-fluid py-4" id="empleados-container">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="bi bi-person-badge text-primary"></i>
                Gestión de Empleados
            </h2>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <h6 class="text-muted">Total Empleados</h6>
                    <h3 id="stat-total">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <h6 class="text-muted">Activos</h6>
                    <h3 class="text-success" id="stat-activos">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <h6 class="text-muted">Inactivos</h6>
                    <h3 class="text-warning" id="stat-inactivos">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-info border-4">
                <div class="card-body">
                    <h6 class="text-muted">Sin Usuario</h6>
                    <h3 class="text-info" id="stat-sin-usuario">0</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de búsqueda y acciones -->
    <div class="row mb-4">
        <div class="col-md-5">
            <input type="text" class="form-control" id="input-buscar" placeholder="🔍 Buscar por nombre, código o email...">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="select-estado">
                <option value="">Todos los estados</option>
                <option value="activo">Activos</option>
                <option value="inactivo">Inactivos</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="select-departamento">
                <option value="">Todos los deptos.</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="EmpleadosModule.abrirModalNuevo()">
                <i class="bi bi-plus-lg"></i> Nuevo Empleado
            </button>
        </div>
    </div>

    <!-- Lista de empleados -->
    <div class="row g-3" id="lista-empleados">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear/Editar Empleado -->
<div class="modal fade" id="modalEmpleado" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Nuevo Empleado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEmpleado">
                    <input type="hidden" id="empleadoId">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Código Empleado *</label>
                            <input type="text" class="form-control" id="txtCodigo" required maxlength="35" placeholder="Ej: EMP-001">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nombre Completo *</label>
                            <input type="text" class="form-control" id="txtNombre" required maxlength="65" placeholder="Nombre y apellidos">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" id="txtEmail" required maxlength="50" placeholder="ejemplo@empresa.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Teléfono *</label>
                            <input type="text" class="form-control" id="txtTelefono" required maxlength="9" placeholder="987654321">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Fecha Nacimiento *</label>
                            <input type="date" class="form-control" id="txtFechaNac" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha Ingreso *</label>
                            <input type="date" class="form-control" id="txtFechaIng" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Departamento *</label>
                            <select class="form-select" id="selDepartamento" required></select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Rol *</label>
                            <select class="form-select" id="selRol" required></select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Foto (URL opcional)</label>
                            <input type="text" class="form-control" id="txtFoto" placeholder="/images/default-avatar.png">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="EmpleadosModule.guardarEmpleado()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>// ✅ MÓDULO AISLADO - Gestión de Empleados
window.EmpleadosModule = (function () {
    'use strict';
    const state = {
        empleados: [],
        departamentos: [],
        roles: [],
        modalInstance: null
    };

    async function apiCall(url, options = {}) {
        try {
            const response = await fetch(url, { credentials: 'include', ...options });
            if (response.status === 401) {
                window.location.href = '/login.html';
                return null;
            }
            if (!response.ok) {
                const text = await response.text();
                throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
            }
            return await response.json();
        } catch (error) {
            mostrarAlerta(`Error: ${error.message}`, 'danger');
            throw error;
        }
    }

    async function cargarEmpleados() {
        try {
            state.empleados = await apiCall('/api/empleados?incluirInactivos=true') || [];
            actualizarEstadisticas();
            renderizarEmpleados();
        } catch (error) {
            document.getElementById('lista-empleados').innerHTML = `<div class="col-12"><div class="alert alert-danger">Error al cargar empleados</div></div>`;
        }
    }

    async function cargarCatalogos() {
        state.departamentos = await apiCall('/api/departamentos?incluirInactivos=false') || [];
        state.roles = await apiCall('/api/roles?incluirInactivos=false') || [];

        const depSelect = document.getElementById('selDepartamento');
        if (depSelect) {
            depSelect.innerHTML = '<option value="">Selecciona...</option>';
            state.departamentos.forEach(d => depSelect.innerHTML += `<option value="${d.idDepartamento}">${d.nombre}</option>`);
        }

        const deptoFilter = document.getElementById('select-departamento');
        if (deptoFilter) {
            deptoFilter.innerHTML = '<option value="">Todos los deptos.</option>';
            state.departamentos.forEach(d => deptoFilter.innerHTML += `<option value="${d.idDepartamento}">${d.nombre}</option>`);
        }

        const rolSelect = document.getElementById('selRol');
        if (rolSelect) {
            rolSelect.innerHTML = '<option value="">Selecciona...</option>';
            state.roles.forEach(r => rolSelect.innerHTML += `<option value="${r.idRol}">${r.nombre}</option>`);
        }
    }

    function actualizarEstadisticas() {
        const total = state.empleados.length;
        const activos = state.empleados.filter(e => e.activo).length;
        const inactivos = total - activos;
        const sinUsuario = state.empleados.filter(e => !e.tieneUsuario).length;

        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-activos').textContent = activos;
        document.getElementById('stat-inactivos').textContent = inactivos;
        document.getElementById('stat-sin-usuario').textContent = sinUsuario;
    }

    function renderizarEmpleados(filtrados = null) {
        const empleados = filtrados || state.empleados;
        const container = document.getElementById('lista-empleados');
        if (!container) return;
        if (empleados.length === 0) {
            container.innerHTML = `<div class="col-12"><div class="alert alert-info text-center"><i class="bi bi-people fs-1 mb-2"></i><p>No hay empleados</p></div></div>`;
            return;
        }
        container.innerHTML = empleados.map(emp => `
            <div class="col-md-6 col-lg-4 col-xl-3">
                <div class="card h-100 ${!emp.activo ? 'opacity-50' : ''}">
                    <div class="card-body text-center">
                        <img src="${emp.foto_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(emp.nombre) + '&size=100'}"
                             class="rounded-circle mb-2" style="width:70px;height:70px;object-fit:cover;">
                        <h6 class="card-title mb-1">${emp.nombre}</h6>
                        <p class="text-muted small mb-1">${emp.codigo_empleado}</p>
                        <span class="badge bg-primary">${emp.departamento}</span>
                        <span class="badge bg-secondary">${emp.rol}</span>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between small">
                            <span>${emp.fecha_ingreso}</span>
                            ${emp.activo ? '<span class="badge bg-success">Activo</span>' : '<span class="badge bg-danger">Inactivo</span>'}
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary btn-block w-100 mb-1" onclick="EmpleadosModule.editarEmpleado(${emp.idEmpleado})">Editar</button>
                            ${emp.activo ?
                                `<button class="btn btn-sm btn-outline-danger w-100" onclick="EmpleadosModule.cambiarEstado(${emp.idEmpleado}, false)">Desactivar</button>` :
                                `<button class="btn btn-sm btn-outline-success w-100" onclick="EmpleadosModule.cambiarEstado(${emp.idEmpleado}, true)">Activar</button>`}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function abrirModalNuevo() {
        document.getElementById('formEmpleado')?.reset();
        document.getElementById('empleadoId').value = '';
        document.getElementById('modalTitle').textContent = 'Nuevo Empleado';
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('txtFechaIng').value = today;
        if (!state.modalInstance) {
            state.modalInstance = new bootstrap.Modal(document.getElementById('modalEmpleado'));
        }
        state.modalInstance.show();
    }

    async function editarEmpleado(id) {
        const emp = state.empleados.find(e => e.idEmpleado === id);
        if (!emp) return;
        document.getElementById('empleadoId').value = emp.idEmpleado;
        document.getElementById('txtCodigo').value = emp.codigo_empleado;
        document.getElementById('txtNombre').value = emp.nombre;
        document.getElementById('txtEmail').value = emp.email;
        document.getElementById('txtTelefono').value = emp.telefono;
        document.getElementById('txtFechaNac').value = emp.fecha_nacimiento;
        document.getElementById('txtFechaIng').value = emp.fecha_ingreso;
        document.getElementById('txtFoto').value = emp.foto_url || '';
        document.getElementById('selDepartamento').value = emp.idDepartamento;
        document.getElementById('selRol').value = emp.idRol;
        document.getElementById('modalTitle').textContent = 'Editar Empleado';
        if (!state.modalInstance) {
            state.modalInstance = new bootstrap.Modal(document.getElementById('modalEmpleado'));
        }
        state.modalInstance.show();
    }

    async function guardarEmpleado() {
        const form = document.getElementById('formEmpleado');
        if (!form?.checkValidity()) return form.reportValidity();

        const data = {
            CodigoEmpleado: document.getElementById('txtCodigo').value,
            Nombre: document.getElementById('txtNombre').value,
            Email: document.getElementById('txtEmail').value,
            Telefono: document.getElementById('txtTelefono').value,
            FechaNacimiento: document.getElementById('txtFechaNac').value,
            FechaIngreso: document.getElementById('txtFechaIng').value,
            FotoUrl: document.getElementById('txtFoto').value || null,
            IdDepartamento: parseInt(document.getElementById('selDepartamento').value),
            IdRol: parseInt(document.getElementById('selRol').value)
        };

        const id = document.getElementById('empleadoId').value;
        try {
            if (id) {
                await apiCall(`/api/empleados/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                mostrarAlerta('Empleado actualizado', 'success');
            } else {
                await apiCall('/api/empleados', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                mostrarAlerta('Empleado creado', 'success');
            }
            if (state.modalInstance) state.modalInstance.hide();
            await cargarEmpleados();
        } catch (error) {
            mostrarAlerta('Error al guardar: ' + error.message, 'danger');
        }
    }

    async function cambiarEstado(id, activar) {
        if (!confirm(`¿Estás seguro de ${activar ? 'activar' : 'desactivar'} este empleado?`)) return;
        try {
            await apiCall(`/api/empleados/${id}/${activar ? 'activar' : 'desactivar'}`, { method: 'PUT' });
            mostrarAlerta(`Empleado ${activar ? 'activado' : 'desactivado'}`, 'success');
            await cargarEmpleados();
        } catch (error) {
            mostrarAlerta('Error: ' + error.message, 'danger');
        }
    }

    function mostrarAlerta(mensaje, tipo = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `${mensaje}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 3000);
    }

    async function init() {
        if (!document.getElementById('empleados-container')) return;
        await cargarCatalogos();
        await cargarEmpleados();

        // Eventos de filtrado
        document.getElementById('input-buscar')?.addEventListener('input', e => {
            const t = e.target.value.toLowerCase();
            const f = state.empleados.filter(e =>
                e.nombre.toLowerCase().includes(t) ||
                e.codigo_empleado.toLowerCase().includes(t) ||
                e.email.toLowerCase().includes(t)
            );
            renderizarEmpleados(f);
        });

        document.getElementById('select-estado')?.addEventListener('change', e => {
            const f = e.target.value ? state.empleados.filter(emp => emp.activo === (e.target.value === 'activo')) : state.empleados;
            renderizarEmpleados(f);
        });

        document.getElementById('select-departamento')?.addEventListener('change', e => {
            const deptoId = e.target.value ? parseInt(e.target.value) : null;
            const f = deptoId ? state.empleados.filter(emp => emp.idDepartamento === deptoId) : state.empleados;
            renderizarEmpleados(f);
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    return {
        init,
        abrirModalNuevo,
        editarEmpleado,
        guardarEmpleado,
        cambiarEstado
    };
})();</script>