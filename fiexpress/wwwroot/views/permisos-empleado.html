<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="bi bi-file-text text-primary"></i> Mis Solicitudes de Permiso
            </h2>
            <button class="btn btn-primary" onclick="PermisosEmpleadoModule.abrirModalNuevo()">
                <i class="bi bi-plus-circle"></i> Nueva Solicitud
            </button>
        </div>
    </div>

    <div id="lista-permisos" class="row g-3">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Solicitud -->
<div class="modal fade" id="modalPermiso" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nueva Solicitud de Permiso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formPermiso">
                    <div class="mb-3">
                        <label class="form-label">Tipo de Permiso</label>
                        <select class="form-select" id="tipo" required>
                            <option value="Ausencia">Ausencia</option>
                            <option value="Vacaciones">Vacaciones</option>
                            <option value="Enfermedad">Enfermedad</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha Inicio *</label>
                            <input type="date" class="form-control" id="fechaInicio" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha Fin *</label>
                            <input type="date" class="form-control" id="fechaFin" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Motivo *</label>
                        <textarea class="form-control" id="motivo" rows="3" maxlength="200" required></textarea>
                        <small class="text-muted">Máximo 200 caracteres</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="PermisosEmpleadoModule.solicitar()">Enviar Solicitud</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    window.PermisosEmpleadoModule = (function () {
        async function cargarPermisos() {
            try {
                const res = await fetchAuth('/api/permisos/mis-permisos');
                const permisos = await res.json();
                renderizarPermisos(permisos);
            } catch (error) {
                document.getElementById('lista-permisos').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">Error al cargar permisos</div>
                </div>
            `;
            }
        }

        function renderizarPermisos(permisos) {
            const container = document.getElementById('lista-permisos');
            if (permisos.length === 0) {
                container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="bi bi-file-text fs-1 d-block mb-3"></i>
                        <h5>No has solicitado permisos</h5>
                        <p>Haz clic en "Nueva Solicitud" para comenzar</p>
                    </div>
                </div>
            `;
                return;
            }

            container.innerHTML = permisos.map(p => `
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">${p.tipo}</h6>
                            <span class="badge ${p.estado === 'Aprobado' ? 'bg-success' : p.estado === 'Rechazado' ? 'bg-danger' : 'bg-warning'}">
                                ${p.estado}
                            </span>
                        </div>
                        <p class="text-muted mb-2">${p.motivo}</p>
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> ${p.fecha_inicio} al ${p.fecha_fin} |
                            <i class="bi bi-clock"></i> Solicitado el ${new Date(p.fecha_solicitud).toLocaleDateString()}
                        </small>
                        ${p.supervisor ? `<br><small class="text-muted">Supervisor: ${p.supervisor}</small>` : ''}
                    </div>
                </div>
            </div>
        `).join('');
        }

        function abrirModalNuevo() {
            document.getElementById('formPermiso').reset();
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaInicio').min = hoy;
            document.getElementById('fechaFin').min = hoy;
            new bootstrap.Modal(document.getElementById('modalPermiso')).show();
        }

        async function solicitar() {
            const form = document.getElementById('formPermiso');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                Tipo: document.getElementById('tipo').value,
                FechaInicio: document.getElementById('fechaInicio').value,
                FechaFin: document.getElementById('fechaFin').value,
                Motivo: document.getElementById('motivo').value.trim()
            };

            try {
                await fetchAuth('/api/permisos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                alert('✅ Solicitud enviada exitosamente');
                document.getElementById('modalPermiso').closest('.modal').querySelector('.btn-close').click();
                cargarPermisos();
            } catch (error) {
                alert('❌ Error al enviar solicitud');
            }
        }

        // Inicializar
        cargarPermisos();

        return {
            abrirModalNuevo,
            solicitar
        };
    })();</script>