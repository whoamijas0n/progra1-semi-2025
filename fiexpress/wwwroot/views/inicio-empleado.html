<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Empleado - FiExpress</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* ✅ Pantalla de carga */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

            .loading-overlay.hidden {
                opacity: 0;
                visibility: hidden;
            }

        .loading-logo {
            font-size: 3rem;
            color: white;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }

        .loading-text {
            color: white;
            font-size: 1.2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .loading-progress {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .loading-steps {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            text-align: center;
            min-height: 24px;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .content-hidden {
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .content-visible {
            opacity: 1;
        }

        /* Estilos existentes */
        .stat-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            animation: fadeInUp 0.6s ease;
        }

            .stat-card:hover {
                transform: translateY(-3px);
            }

        .avatar {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 3px solid #e9ecef;
        }

        .badge-status {
            font-size: 0.7rem;
            padding: 0.35em 0.65em;
        }

        .fichaje-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            animation: fadeInUp 0.6s ease;
        }

        .fichaje-entrada {
            border-left-color: #198754;
        }

        .fichaje-salida {
            border-left-color: #dc3545;
        }

        .progress {
            height: 8px;
            border-radius: 4px;
        }

        .turno-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .quick-action-btn {
            transition: all 0.3s ease;
            border: none;
        }

            .quick-action-btn:hover {
                transform: translateY(-2px);
            }

        .dia-activo {
            color: #198754;
            font-weight: bold;
        }

        .dia-inactivo {
            color: #6c757d;
            opacity: 0.6;
        }

        /* Animaciones para elementos individuales */
        .animate-delay-1 {
            animation-delay: 0.1s;
        }

        .animate-delay-2 {
            animation-delay: 0.2s;
        }

        .animate-delay-3 {
            animation-delay: 0.3s;
        }

        .animate-delay-4 {
            animation-delay: 0.4s;
        }

        .animate-delay-5 {
            animation-delay: 0.5s;
        }
    </style>
</head>
<body>
    <!-- ✅ Pantalla de carga -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-logo">
            <i class="bi bi-clock-history"></i>
        </div>
        <div class="loading-text">Cargando tu dashboard...</div>
        <div class="loading-progress">
            <div id="loading-progress-bar" class="loading-progress-bar"></div>
        </div>
        <div id="loading-steps" class="loading-steps">
            Iniciando sistema...
        </div>
    </div>

    <!-- Dashboard Empleado -->
    <div class="container-fluid py-4 content-hidden" id="dashboard-empleado-container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-3">
                    <i class="bi bi-speedometer2 text-primary"></i>
                    Mi Dashboard
                </h2>
                <p class="text-muted">Resumen de tu actividad y asistencia</p>
            </div>
        </div>

        <!-- Información del Empleado -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card animate-delay-1">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-2 text-center">
                                <img id="empleado-avatar"
                                     class="avatar rounded-circle"
                                     alt="Avatar"
                                     onerror="this.src='https://ui-avatars.com/api/?name=U&size=100&background=0D6EFD&color=fff&bold=true'">
                            </div>
                            <div class="col-md-6">
                                <h4 class="mb-1" id="empleado-nombre">Cargando...</h4>
                                <p class="text-muted mb-1">
                                    <i class="bi bi-person-badge me-1"></i>
                                    <span id="empleado-codigo">-</span> |
                                    <span id="empleado-departamento">-</span>
                                </p>
                                <p class="text-muted mb-0">
                                    <i class="bi bi-calendar me-1"></i>
                                    <span id="fecha-actual">-</span>
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="d-flex gap-2 justify-content-end">
                                    <button class="btn btn-outline-primary" onclick="DashboardEmpleado.recargarDashboard()">
                                        <i class="bi bi-arrow-clockwise"></i> Actualizar
                                    </button>
                                    <button class="btn btn-primary" onclick="DashboardEmpleado.verEstadisticasCompletas()">
                                        <i class="bi bi-graph-up me-1"></i>Estadísticas
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estado Actual -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info d-flex align-items-center animate-delay-2">
                    <i class="bi bi-info-circle fs-4 me-3"></i>
                    <div>
                        <h5 class="alert-heading mb-1" id="estado-actual-text">Cargando estado...</h5>
                        <p class="mb-0" id="estado-detalle">Obteniendo información actual</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas Rápidas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card border-start border-primary border-4 animate-delay-1">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Asistencia Mes</h6>
                                <h3 class="mb-0" id="stat-asistencia">0%</h3>
                            </div>
                            <i class="bi bi-person-check fs-1 text-primary opacity-25"></i>
                        </div>
                        <div class="progress mt-2">
                            <div class="progress-bar bg-primary" id="barra-asistencia" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="stat-dias-asistencia">0/0 días</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-start border-success border-4 animate-delay-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Horas Trabajadas</h6>
                                <h3 class="text-success mb-0" id="stat-horas-trabajadas">0h</h3>
                            </div>
                            <i class="bi bi-clock-history fs-1 text-success opacity-25"></i>
                        </div>
                        <small class="text-muted" id="stat-minutos-trabajados">0 minutos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-start border-warning border-4 animate-delay-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Tiempo Retraso</h6>
                                <h3 class="text-warning mb-0" id="stat-retraso">0m</h3>
                            </div>
                            <i class="bi bi-alarm fs-1 text-warning opacity-25"></i>
                        </div>
                        <small class="text-muted">Acumulado mes</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-start border-info border-4 animate-delay-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Horas Extra</h6>
                                <h3 class="text-info mb-0" id="stat-extra">0m</h3>
                            </div>
                            <i class="bi bi-plus-circle fs-1 text-info opacity-25"></i>
                        </div>
                        <small class="text-muted">Tiempo adicional</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="row">
            <!-- Columna Izquierda -->
            <div class="col-lg-8">
                <div class="row">
                    <!-- Turno Activo -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 animate-delay-3">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-clock text-primary me-2"></i>
                                    Mi Turno
                                </h5>
                                <span class="badge bg-primary" id="badge-turno-activo">Activo</span>
                            </div>
                            <div class="card-body">
                                <div id="turno-activo-container">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="text-muted mt-2 mb-0">Cargando turno...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Días del Turno -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 animate-delay-4">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-calendar-week text-success me-2"></i>
                                    Días Laborales
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="dias-turno-container" class="text-center">
                                    <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                                    <p class="text-muted mt-2 mb-0">Cargando días...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fichajes de Hoy -->
                <div class="card mb-4 animate-delay-5">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history text-primary me-2"></i>
                            Mis Fichajes de Hoy
                            <span class="badge bg-primary ms-2" id="contador-fichajes">0</span>
                        </h5>
                        <div>
                            <span class="text-muted small me-2" id="timestamp-fichajes"></span>
                            <button class="btn btn-sm btn-outline-primary" onclick="DashboardEmpleado.recargarFichajes()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="fichajes-hoy-container">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="text-muted mt-2 mb-0">Cargando fichajes...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha -->
            <div class="col-lg-4">
                <!-- Acciones Rápidas -->
                <div class="card mb-4 animate-delay-3">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-lightning-charge text-warning me-2"></i>
                            Acciones Rápidas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary quick-action-btn" onclick="DashboardEmpleado.verMisFichajes()">
                                <i class="bi bi-clock-history me-2"></i>Historial Fichajes
                            </button>
                            <button class="btn btn-outline-success quick-action-btn" onclick="DashboardEmpleado.solicitarPermiso()">
                                <i class="bi bi-file-text me-2"></i>Solicitar Permiso
                            </button>
                            <button class="btn btn-outline-info quick-action-btn" onclick="DashboardEmpleado.verNotificaciones()">
                                <i class="bi bi-bell me-2"></i>Notificaciones
                            </button>
                            <button class="btn btn-outline-warning quick-action-btn" onclick="DashboardEmpleado.verHorario()">
                                <i class="bi bi-calendar-week me-2"></i>Mi Horario Completo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Progreso del Mes -->
                <div class="card mb-4 animate-delay-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up text-info me-2"></i>
                            Progreso del Mes
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">Días transcurridos</small>
                                <small class="text-muted" id="progreso-mes-text">0%</small>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-primary" id="barra-mes" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">Objetivo asistencia</small>
                                <small class="text-muted" id="objetivo-asistencia-text">0%</small>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-success" id="barra-objetivo" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="text-center">
                            <small class="text-muted" id="dias-restantes">0 días restantes</small>
                        </div>
                    </div>
                </div>

                <!-- Rendimiento -->
                <div class="card animate-delay-5">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-award text-warning me-2"></i>
                            Mi Rendimiento
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Promedio diario:</span>
                            <span class="badge bg-info" id="promedio-diario">0h</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Días consecutivos:</span>
                            <span class="badge bg-success" id="dias-consecutivos">0</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Próximo objetivo:</span>
                            <span class="badge bg-warning" id="proximo-objetivo">+5%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ✅ DASHBOARD EMPLEADO - CON PERSISTENCIA DE DATOS Y BOTÓN DE REFRESH
        window.DashboardEmpleado = (function () {
            'use strict';

            const state = {
                datos: null,
                intervalos: [],
                pasosCarga: [
                    "Iniciando sistema...",
                    "Cargando información personal...",
                    "Obteniendo estadísticas...",
                    "Consultando turno activo...",
                    "Cargando fichajes del día...",
                    "Calculando progreso del mes...",
                    "Preparando interfaz...",
                    "¡Listo!"
                ],
                pasoActual: 0
            };

            // Clave para guardar en sessionStorage
            const STORAGE_KEY = 'fiExpress_dashboard_data';

            // ✅ NUEVO: Control de pantalla de carga
            function actualizarProgresoCarga(paso, mensajePersonalizado = null) {
                const progressBar = document.getElementById('loading-progress-bar');
                const stepsText = document.getElementById('loading-steps');

                const progreso = ((paso + 1) / state.pasosCarga.length) * 100;
                progressBar.style.width = `${progreso}%`;

                const mensaje = mensajePersonalizado || state.pasosCarga[paso];
                stepsText.textContent = mensaje;

                state.pasoActual = paso;
            }

            function mostrarPantallaCarga() {
                const overlay = document.getElementById('loading-overlay');
                const contenido = document.getElementById('dashboard-empleado-container');

                overlay.classList.remove('hidden');
                contenido.classList.add('content-hidden');
                contenido.classList.remove('content-visible');

                // Reiniciar progreso
                actualizarProgresoCarga(0);
            }

            function ocultarPantallaCarga() {
                const overlay = document.getElementById('loading-overlay');
                const contenido = document.getElementById('dashboard-empleado-container');

                // Último paso de progreso
                actualizarProgresoCarga(state.pasosCarga.length - 1, "¡Dashboard listo!");

                setTimeout(() => {
                    overlay.classList.add('hidden');
                    contenido.classList.remove('content-hidden');
                    contenido.classList.add('content-visible');
                }, 800);
            }

            // ✅ NUEVO: Guardar datos en sessionStorage
            function guardarDatosEnStorage(datos) {
                try {
                    const datosConTimestamp = {
                        ...datos,
                        timestamp: Date.now()
                    };
                    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(datosConTimestamp));
                } catch (error) {
                    console.warn('No se pudo guardar en sessionStorage:', error);
                }
            }

            // ✅ NUEVO: Cargar datos desde sessionStorage
            function cargarDatosDesdeStorage() {
                try {
                    const datosGuardados = sessionStorage.getItem(STORAGE_KEY);
                    if (!datosGuardados) return null;

                    const datos = JSON.parse(datosGuardados);
                    // Verificar que los datos no sean demasiado viejos (por ejemplo, 5 minutos)
                    const cincoMinutos = 5 * 60 * 1000;
                    if (Date.now() - datos.timestamp > cincoMinutos) {
                        sessionStorage.removeItem(STORAGE_KEY);
                        return null;
                    }

                    return datos;
                } catch (error) {
                    console.warn('Error al cargar datos desde sessionStorage:', error);
                    return null;
                }
            }

            // API Helper MEJORADO
            async function apiCall(url, options = {}) {
                try {
                    console.log(`🔍 Llamando API: ${url}`);
                    const response = await fetch(url, {
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        },
                        ...options
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`❌ Error ${response.status}:`, errorText);

                        if (response.status === 404) {
                            throw new Error(`Endpoint no encontrado: ${url}`);
                        }

                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log(`✅ Respuesta API ${url}:`, data);
                    return data;

                } catch (error) {
                    console.error('❌ API Call Error:', error);
                    mostrarNotificacion(`Error: ${error.message}`, 'danger');
                    return null;
                }
            }

            // Cargar dashboard completo
            async function cargarDashboard(forceRefresh = false) {
                console.log('📊 Cargando dashboard empleado...');

                // ✅ NUEVO: Si no es forzado, intentar cargar desde sessionStorage
                if (!forceRefresh) {
                    const datosGuardados = cargarDatosDesdeStorage();
                    if (datosGuardados) {
                        console.log('✅ Usando datos guardados en sessionStorage');
                        state.datos = datosGuardados;
                        actualizarVistaCompleta();
                        ocultarPantallaCarga();
                        return;
                    }
                }

                // Si no hay datos guardados o es un refresh forzado, cargar desde API
                mostrarPantallaCarga();

                try {
                    actualizarProgresoCarga(1, "Cargando información personal...");

                    const dashboardData = await apiCall('/api/estadisticas/dashboard-empleado');

                    if (!dashboardData) {
                        mostrarNotificacion('No se pudieron cargar los datos del dashboard', 'warning');
                        ocultarPantallaCarga();
                        return;
                    }

                    state.datos = dashboardData;

                    // ✅ NUEVO: Guardar los datos en sessionStorage
                    guardarDatosEnStorage(dashboardData);

                    actualizarProgresoCarga(2, "Procesando estadísticas...");
                    actualizarEstadisticas();

                    actualizarProgresoCarga(3, "Configurando turno activo...");
                    actualizarTurnoActivo();

                    actualizarProgresoCarga(4, "Cargando fichajes del día...");
                    actualizarFichajesHoy();

                    actualizarProgresoCarga(5, "Actualizando información...");
                    actualizarInfoEmpleado();
                    actualizarEstadoActual();
                    actualizarDiasTurno();
                    actualizarProgresoMes();
                    actualizarRendimiento();
                    actualizarFechas();

                    actualizarProgresoCarga(6, "Finalizando carga...");
                    mostrarNotificacion('Dashboard actualizado correctamente', 'success');

                    // Pequeño delay para que se vea el último paso
                    setTimeout(ocultarPantallaCarga, 500);

                } catch (error) {
                    console.error('Error crítico al cargar dashboard:', error);
                    mostrarNotificacion('Error crítico al cargar el dashboard', 'danger');
                    ocultarPantallaCarga();
                }
            }

            // Actualizar toda la vista (para recargas)
            function actualizarVistaCompleta() {
                actualizarInfoEmpleado();
                actualizarEstadoActual();
                actualizarEstadisticas();
                actualizarTurnoActivo();
                actualizarDiasTurno();
                actualizarFichajesHoy();
                actualizarProgresoMes();
                actualizarRendimiento();
                actualizarFechas();
            }

            // Resto de las funciones permanecen igual...
            function actualizarInfoEmpleado() {
                const emp = state.datos.empleado;
                if (!emp) return;

                document.getElementById('empleado-nombre').textContent = emp.nombre || 'Usuario';
                document.getElementById('empleado-codigo').textContent = emp.codigo_empleado || '-';
                document.getElementById('empleado-departamento').textContent = emp.departamento || '-';

                const avatarImg = document.getElementById('empleado-avatar');
                if (emp.foto_url) {
                    avatarImg.src = emp.foto_url;
                } else {
                    const nombre = emp.nombre || 'Usuario';
                    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&size=100&background=0D6EFD&color=fff&bold=true`;
                    avatarImg.src = avatarUrl;
                }
            }

            function actualizarEstadoActual() {
                const estado = state.datos.estadoActual || 'Sin información';
                const ultimoFichaje = state.datos.ultimoFichaje;

                document.getElementById('estado-actual-text').textContent = estado;

                let detalle = 'Actualizado: ' + new Date().toLocaleTimeString();
                if (ultimoFichaje) {
                    detalle = `Último fichaje: ${ultimoFichaje.tipo} a las ${ultimoFichaje.hora}`;
                }
                document.getElementById('estado-detalle').textContent = detalle;

                const alert = document.querySelector('.alert-info');
                if (estado.includes('trabajo')) {
                    alert.className = 'alert alert-success d-flex align-items-center animate-delay-2';
                } else if (estado.includes('Fuera')) {
                    alert.className = 'alert alert-warning d-flex align-items-center animate-delay-2';
                } else {
                    alert.className = 'alert alert-info d-flex align-items-center animate-delay-2';
                }
            }

            function actualizarEstadisticas() {
                const resumen = state.datos.resumenMes;
                if (!resumen) return;

                const porcentajeAsistencia = resumen.porcentajeAsistencia || 0;
                document.getElementById('stat-asistencia').textContent = porcentajeAsistencia + '%';
                document.getElementById('barra-asistencia').style.width = porcentajeAsistencia + '%';
                document.getElementById('stat-dias-asistencia').textContent =
                    `${resumen.diasTrabajados || 0}/${resumen.totalDias || 0} días`;

                const horas = Math.floor((resumen.totalMinutosTrabajados || 0) / 60);
                const minutos = (resumen.totalMinutosTrabajados || 0) % 60;
                document.getElementById('stat-horas-trabajadas').textContent = horas + 'h';
                document.getElementById('stat-minutos-trabajados').textContent =
                    `${resumen.totalMinutosTrabajados || 0} minutos`;

                document.getElementById('stat-retraso').textContent = (resumen.totalMinutosRetraso || 0) + 'm';
                document.getElementById('stat-extra').textContent = (resumen.totalMinutosExtra || 0) + 'm';
            }

            function actualizarTurnoActivo() {
                const container = document.getElementById('turno-activo-container');
                const turno = state.datos.horarioActivo;

                if (!turno) {
                    container.innerHTML = `
                                    <div class="text-center text-muted py-3">
                                        <i class="bi bi-clock fs-1 d-block mb-2 opacity-50"></i>
                                        <p class="mb-2">No tienes un turno activo asignado</p>
                                        <small class="text-muted">Contacta con tu supervisor para asignarte un horario</small>
                                    </div>
                                `;
                    document.getElementById('badge-turno-activo').textContent = 'Sin turno';
                    document.getElementById('badge-turno-activo').className = 'badge bg-secondary';
                    return;
                }

                container.innerHTML = `
                                <div class="text-center">
                                    <h4 class="text-primary mb-3">${turno.nombreTurno || 'Turno'}</h4>
                                    <div class="mb-3">
                                        <div class="fs-5 fw-bold text-dark">${turno.horaEntrada || '--:--'} - ${turno.horaSalida || '--:--'}</div>
                                        <small class="text-muted">Horario de trabajo</small>
                                    </div>
                                    <div class="mb-3">
                                        <span class="badge bg-info">Tolerancia: ${turno.toleranciaMinutos || 0} min</span>
                                    </div>
                                </div>
                            `;

                document.getElementById('badge-turno-activo').textContent = 'Activo';
                document.getElementById('badge-turno-activo').className = 'badge bg-success';
            }

            function actualizarDiasTurno() {
                const container = document.getElementById('dias-turno-container');
                const turno = state.datos.horarioActivo;

                if (!turno || !turno.diasActivos) {
                    container.innerHTML = '<p class="text-muted">No hay información de días</p>';
                    return;
                }

                const dias = [
                    { nombre: 'Lun', key: 'lunes' },
                    { nombre: 'Mar', key: 'martes' },
                    { nombre: 'Mié', key: 'miercoles' },
                    { nombre: 'Jue', key: 'jueves' },
                    { nombre: 'Vie', key: 'viernes' },
                    { nombre: 'Sáb', key: 'sabado' },
                    { nombre: 'Dom', key: 'domingo' }
                ];

                const hoy = new Date().getDay();
                const diaActual = hoy === 0 ? 6 : hoy - 1;

                container.innerHTML = `
                                <div class="row g-1">
                                    ${dias.map((dia, index) => `
                                        <div class="col">
                                            <div class="text-center p-2 rounded ${turno.diasActivos[dia.key] ?
                        (index === diaActual ? 'bg-primary text-white' : 'bg-light') :
                        'bg-secondary text-white opacity-50'}">
                                                <div class="fw-bold">${dia.nombre}</div>
                                                <small>${turno.diasActivos[dia.key] ? '✓' : '✗'}</small>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <small class="text-muted mt-2 d-block">Hoy: ${dias[diaActual].nombre}</small>
                            `;
            }

            function actualizarFichajesHoy() {
                const container = document.getElementById('fichajes-hoy-container');
                const fichajes = state.datos.fichajesHoy || [];

                document.getElementById('contador-fichajes').textContent = fichajes.length;
                document.getElementById('timestamp-fichajes').textContent =
                    'Actualizado: ' + new Date().toLocaleTimeString();

                if (fichajes.length === 0) {
                    container.innerHTML = `
                                    <div class="text-center text-muted py-4">
                                        <i class="bi bi-clock fs-1 d-block mb-2"></i>
                                        <p class="mb-2">No hay fichajes registrados hoy</p>
                                        <small class="text-muted">Recuerda fichar tu entrada y salida</small>
                                    </div>
                                `;
                    return;
                }

                container.innerHTML = fichajes.map(fichaje => `
                                <div class="card fichaje-card mb-2 ${fichaje.tipo === 'Entrada' ? 'fichaje-entrada' : 'fichaje-salida'}">
                                    <div class="card-body py-3">
                                        <div class="row align-items-center">
                                            <div class="col-1 text-center">
                                                <i class="bi ${fichaje.tipo === 'Entrada' ? 'bi-box-arrow-in-right text-success' : 'bi-box-arrow-right text-danger'} fs-5"></i>
                                            </div>
                                            <div class="col-7">
                                                <div class="d-flex align-items-center">
                                                    <span class="badge ${fichaje.tipo === 'Entrada' ? 'bg-success' : 'bg-danger'} me-2">
                                                        ${fichaje.tipo}
                                                    </span>
                                                    <strong class="fs-6">${fichaje.hora}</strong>
                                                </div>
                                            </div>
                                            <div class="col-4 text-end">
                                                <small class="text-muted">${fichaje.fecha}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('');
            }

            function actualizarProgresoMes() {
                const hoy = new Date();
                const totalDiasMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0).getDate();
                const progresoMes = (hoy.getDate() / totalDiasMes) * 100;

                document.getElementById('progreso-mes-text').textContent = Math.round(progresoMes) + '%';
                document.getElementById('barra-mes').style.width = progresoMes + '%';

                const resumen = state.datos.resumenMes;
                const objetivoAsistencia = resumen?.porcentajeAsistencia || 0;
                document.getElementById('objetivo-asistencia-text').textContent = Math.round(objetivoAsistencia) + '%';
                document.getElementById('barra-objetivo').style.width = objetivoAsistencia + '%';

                const diasRestantes = totalDiasMes - hoy.getDate();
                document.getElementById('dias-restantes').textContent = `${diasRestantes} días restantes`;
            }

            function actualizarRendimiento() {
                const resumen = state.datos.resumenMes;
                if (!resumen) return;

                const promedioDiario = resumen.totalDias > 0 ?
                    Math.round(resumen.totalMinutosTrabajados / resumen.totalDias / 60) : 0;
                document.getElementById('promedio-diario').textContent = promedioDiario + 'h';

                const diasConsecutivos = Math.min(resumen.diasTrabajados || 0, 5);
                document.getElementById('dias-consecutivos').textContent = diasConsecutivos;

                const asistenciaActual = resumen.porcentajeAsistencia || 0;
                const proximoObjetivo = Math.min(asistenciaActual + 5, 100);
                document.getElementById('proximo-objetivo').textContent = `+${proximoObjetivo - asistenciaActual}%`;
            }

            function actualizarFechas() {
                const ahora = new Date();
                const opciones = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                };
                document.getElementById('fecha-actual').textContent =
                    ahora.toLocaleDateString('es-ES', opciones);
            }

            // Funciones públicas
            async function recargarDashboard() {
                // ✅ NUEVO: Forzar recarga desde API
                await cargarDashboard(true);
            }

            async function recargarFichajes() {
                await recargarDashboard();
            }

            function verEstadisticasCompletas() {
                if (window.cargarVista) {
                    window.cargarVista('estadisticas-personales', 'Mis Estadísticas');
                } else {
                    mostrarNotificacion('Navegación no disponible en este momento', 'warning');
                }
            }

            function verMisFichajes() {
                if (window.cargarVista) {
                    window.cargarVista('fichajes-personales', 'Mis Fichajes');
                } else {
                    mostrarNotificacion('Navegación no disponible en este momento', 'warning');
                }
            }

            function solicitarPermiso() {
                if (window.cargarVista) {
                    window.cargarVista('permisos-empleado', 'Solicitar Permiso');
                } else {
                    mostrarNotificacion('Navegación no disponible en este momento', 'warning');
                }
            }

            function verNotificaciones() {
                if (window.cargarVista) {
                    window.cargarVista('notificaciones-empleado', 'Notificaciones');
                } else {
                    mostrarNotificacion('Navegación no disponible en este momento', 'warning');
                }
            }

            function verHorario() {
                if (window.cargarVista) {
                    window.cargarVista('horario-personal', 'Mi Horario');
                } else {
                    mostrarNotificacion('Navegación no disponible en este momento', 'warning');
                }
            }

            function mostrarNotificacion(mensaje, tipo = 'info') {
                const alertasAnteriores = document.querySelectorAll('.alert-fixed');
                alertasAnteriores.forEach(alerta => alerta.remove());

                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 alert-fixed`;
                alertDiv.style.zIndex = '9999';
                alertDiv.style.minWidth = '300px';
                alertDiv.innerHTML = `
                                <div class="d-flex align-items-center">
                                    <i class="bi ${tipo === 'success' ? 'bi-check-circle' : tipo === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
                                    <span>${mensaje}</span>
                                </div>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                document.body.appendChild(alertDiv);

                setTimeout(() => {
                    if (alertDiv.parentNode) alertDiv.remove();
                }, 4000);
            }

            function configurarAutoRefresh() {
                const intervalo = setInterval(() => {
                    if (!document.hidden) {
                        console.log('🔄 Auto-refresh del dashboard');
                        cargarDashboard(true); // Forzar recarga en auto-refresh
                    }
                }, 120000);
                state.intervalos.push(intervalo);
            }

            async function init() {
                if (!document.getElementById('dashboard-empleado-container')) {
                    console.log('❌ No se encontró el contenedor del dashboard');
                    return;
                }

                console.log('🚀 Iniciando dashboard empleado...');
                // ✅ NUEVO: Cargar sin forzar, para usar datos guardados si existen
                await cargarDashboard(false);
                configurarAutoRefresh();
                console.log('✅ Dashboard empleado iniciado correctamente');
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }

            return {
                init,
                recargarDashboard,
                recargarFichajes,
                verEstadisticasCompletas,
                verMisFichajes,
                solicitarPermiso,
                verNotificaciones,
                verHorario
            };
        })();
    </script>
</body>
</html>