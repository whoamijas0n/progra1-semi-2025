<!-- Vista de Gestión de Usuarios -->
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<div class="container-fluid py-4" id="usuarios-container">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="bi bi-person-badge text-primary"></i>
                Gestión de Usuarios
            </h2>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <h6 class="text-muted">Total Usuarios</h6>
                    <h3 id="stat-total">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <h6 class="text-muted">Activos</h6>
                    <h3 class="text-success" id="stat-activos">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <h6 class="text-muted">Inactivos</h6>
                    <h3 class="text-warning" id="stat-inactivos">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-info border-4">
                <div class="card-body">
                    <h6 class="text-muted">Sin Usuario</h6>
                    <h3 class="text-info" id="stat-sin-usuario">0</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de búsqueda y acciones -->
    <div class="row mb-4">
        <div class="col-md-6">
            <input type="text" class="form-control" id="input-buscar" placeholder="🔍 Buscar por usuario, nombre o email...">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="select-estado">
                <option value="">Todos los estados</option>
                <option value="activo">Activos</option>
                <option value="inactivo">Inactivos</option>
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-primary w-100" onclick="UsuariosModule.abrirModalNuevo()">
                <i class="bi bi-plus-lg"></i> Nuevo Usuario
            </button>
        </div>
    </div>

    <!-- Lista de usuarios -->
    <div class="row g-3" id="lista-usuarios">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear/Editar Usuario -->
<div class="modal fade" id="modalUsuario" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Nuevo Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formUsuario">
                    <input type="hidden" id="usuarioId">

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Empleado *</label>
                            <select class="form-select" id="selEmpleado" required>
                                <option value="">Seleccione un empleado...</option>
                            </select>
                            <small class="text-muted">Solo se muestran empleados activos sin usuario asignado</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre de Usuario *</label>
                            <input type="text" class="form-control" id="txtUsername" required
                                   placeholder="Ej: juan.perez" minlength="3" maxlength="50">
                            <small class="text-muted">Mínimo 3 caracteres, sin espacios</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contraseña *</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="txtPassword" required
                                       minlength="6" maxlength="35" placeholder="Mínimo 6 caracteres">
                                <button class="btn btn-outline-secondary" type="button" id="btnTogglePassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <small class="text-muted">Mínimo 6 caracteres</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="chkActivo" checked>
                                <label class="form-check-label" for="chkActivo">Usuario activo</label>
                            </div>
                            <small class="text-muted">Los usuarios inactivos no pueden iniciar sesión</small>
                        </div>
                    </div>

                    <!-- Información del empleado seleccionado -->
                    <div class="row" id="info-empleado" style="display: none;">
                        <div class="col-md-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Información del Empleado</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small><strong>Nombre:</strong> <span id="info-nombre">-</span></small>
                                        </div>
                                        <div class="col-md-6">
                                            <small><strong>Email:</strong> <span id="info-email">-</span></small>
                                        </div>
                                        <div class="col-md-6">
                                            <small><strong>Departamento:</strong> <span id="info-departamento">-</span></small>
                                        </div>
                                        <div class="col-md-6">
                                            <small><strong>Rol:</strong> <span id="info-rol">-</span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="UsuariosModule.guardarUsuario()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cambiar Contraseña -->
<div class="modal fade" id="modalPassword" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cambiar Contraseña</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formPassword">
                    <input type="hidden" id="passwordUsuarioId">
                    <div class="mb-3">
                        <label class="form-label">Nueva Contraseña *</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="txtNewPassword" required
                                   minlength="6" maxlength="35" placeholder="Mínimo 6 caracteres">
                            <button class="btn btn-outline-secondary" type="button" id="btnToggleNewPassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <small class="text-muted">Mínimo 6 caracteres</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="UsuariosModule.cambiarPassword()">Actualizar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ✅ MÓDULO AISLADO - Gestión de Usuarios
    window.UsuariosModule = (function () {
        'use strict';

        // Estado privado del módulo
        const state = {
            usuarios: [],
            empleadosSinUsuario: [],
            modalInstance: null,
            modalPasswordInstance: null
        };

        // API Helper
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    credentials: 'include',
                    ...options
                });

                if (!response.ok) {
                    const text = await response.text();
                    console.error(`API Error ${response.status}:`, text);
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API Call Error:', error);
                mostrarAlerta(`Error: ${error.message}`, 'danger');
                throw error;
            }
        }

        // Cargar usuarios
        async function cargarUsuarios() {
            console.log('📥 Cargando usuarios...');
            try {
                state.usuarios = await apiCall('/api/usuarios?incluirInactivos=true');
                console.log('✅ Usuarios cargados:', state.usuarios.length, state.usuarios);
                actualizarEstadisticas();
                renderizarUsuarios();
            } catch (error) {
                console.error('❌ Error al cargar usuarios:', error);
                document.getElementById('lista-usuarios').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            Error al cargar usuarios: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // Cargar empleados sin usuario
        async function cargarEmpleadosSinUsuario() {
            console.log('📥 Cargando empleados sin usuario...');
            try {
                state.empleadosSinUsuario = await apiCall('/api/usuarios/empleados-sin-usuario');
                console.log('✅ Empleados sin usuario cargados:', state.empleadosSinUsuario.length);

                // Llenar select del modal
                const selectEmpleado = document.getElementById('selEmpleado');
                if (selectEmpleado) {
                    selectEmpleado.innerHTML = '<option value="">Seleccione un empleado</option>';
                    state.empleadosSinUsuario.forEach(emp => {
                        selectEmpleado.innerHTML += `
                            <option value="${emp.idEmpleado}"
                                    data-nombre="${emp.nombre}"
                                    data-email="${emp.email}"
                                    data-departamento="${emp.departamento}"
                                    data-rol="${emp.rol}">
                                ${emp.codigo_empleado} - ${emp.nombre} (${emp.departamento})
                            </option>
                        `;
                    });
                }
            } catch (error) {
                console.error('❌ Error al cargar empleados sin usuario:', error);
            }
        }

        // Actualizar estadísticas
        function actualizarEstadisticas() {
            const total = state.usuarios.length;
            const activos = state.usuarios.filter(u => u.activo).length;
            const inactivos = total - activos;

            // Calcular empleados sin usuario (aproximado)
            const totalEmpleados = state.usuarios.length + state.empleadosSinUsuario.length;
            const sinUsuario = state.empleadosSinUsuario.length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-activos').textContent = activos;
            document.getElementById('stat-inactivos').textContent = inactivos;
            document.getElementById('stat-sin-usuario').textContent = sinUsuario;
        }

        // Renderizar usuarios
        function renderizarUsuarios() {
            const container = document.getElementById('lista-usuarios');

            if (state.usuarios.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="bi bi-people fs-1 d-block mb-3"></i>
                            <h5>No hay usuarios registrados</h5>
                            <p>Haz clic en "Nuevo Usuario" para crear uno</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = state.usuarios.map(user => `
                <div class="col-md-6 col-lg-4 col-xl-3">
                    <div class="card h-100 ${!user.activo ? 'opacity-50' : ''}">
                        <div class="card-body text-center">
                            <img src="${user.empleado?.foto_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.username) + '&size=100'}"
                                 class="rounded-circle mb-3"
                                 style="width: 80px; height: 80px; object-fit: cover;"
                                 alt="${user.username}">
                            <h6 class="card-title mb-1">${user.username}</h6>
                            <p class="text-muted small mb-2">${user.empleado?.nombre || 'Sin empleado'}</p>
                            <span class="badge bg-primary mb-2">${user.empleado?.departamento || 'N/A'}</span>
                            <span class="badge bg-secondary mb-2">${user.empleado?.rol || 'N/A'}</span>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center small mb-3">
                                <span class="text-muted">
                                    <i class="bi bi-calendar"></i>
                                    ${user.ultimo_login ? new Date(user.ultimo_login).toLocaleDateString() : 'Nunca'}
                                </span>
                                ${user.activo ?
                    '<span class="badge bg-success">Activo</span>' :
                    '<span class="badge bg-danger">Inactivo</span>'}
                            </div>
                           
                            <div class="btn-group w-100">
    <button class="btn btn-sm btn-outline-primary" onclick="UsuariosModule.editarUsuario(${user.idUsuario})">
        <i class="bi bi-pencil"></i> Editar
    </button>
    <button class="btn btn-sm btn-outline-warning" onclick="UsuariosModule.cambiarPasswordModal(${user.idUsuario}, '${user.username}')">
        <i class="bi bi-key"></i>
    </button>
    ${user.activo ?
                    `<button class="btn btn-sm btn-outline-danger" onclick="UsuariosModule.eliminarUsuario(${user.idUsuario}, '${user.username}')">
            <i class="bi bi-trash"></i> Desactivar
        </button>` :
                    `<button class="btn btn-sm btn-outline-success" onclick="UsuariosModule.activarUsuario(${user.idUsuario}, '${user.username}')">
            <i class="bi bi-check-circle"></i> Activar
        </button>`
    }
</div>

                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Abrir modal para nuevo usuario
        async function abrirModalNuevo() {
            console.log('➕ Abriendo modal para nuevo usuario');

            // Recargar empleados sin usuario
            await cargarEmpleadosSinUsuario();

            document.getElementById('formUsuario').reset();
            document.getElementById('usuarioId').value = '';
            document.getElementById('modalTitle').textContent = 'Nuevo Usuario';
            document.getElementById('chkActivo').checked = true;
            document.getElementById('info-empleado').style.display = 'none';

            // Configurar evento para mostrar información del empleado
            const selEmpleado = document.getElementById('selEmpleado');
            selEmpleado.addEventListener('change', function () {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    document.getElementById('info-nombre').textContent = selectedOption.dataset.nombre;
                    document.getElementById('info-email').textContent = selectedOption.dataset.email;
                    document.getElementById('info-departamento').textContent = selectedOption.dataset.departamento;
                    document.getElementById('info-rol').textContent = selectedOption.dataset.rol;
                    document.getElementById('info-empleado').style.display = 'block';

                    // Sugerir username basado en el email
                    const email = selectedOption.dataset.email;
                    const usernameSugerido = email.split('@')[0];
                    document.getElementById('txtUsername').value = usernameSugerido;
                } else {
                    document.getElementById('info-empleado').style.display = 'none';
                }
            });

            if (!state.modalInstance) {
                state.modalInstance = new bootstrap.Modal(document.getElementById('modalUsuario'));
            }
            state.modalInstance.show();

            console.log('✅ Modal de usuario abierto');
        }

        // Editar usuario
        // Editar usuario
        async function editarUsuario(id) {
            console.log('✏️ Editando usuario ID:', id);
            try {
                const user = await apiCall(`/api/usuarios/${id}`);
                console.log('✅ Datos del usuario cargados:', user);

                // Rellenar formulario
                document.getElementById('usuarioId').value = user.idUsuario;
                document.getElementById('txtUsername').value = user.username;
                document.getElementById('txtPassword').value = ''; // No se muestra la contraseña actual
                document.getElementById('chkActivo').checked = user.activo;

                // Mostrar info del empleado (solo lectura)
                document.getElementById('info-nombre').textContent = user.empleado.nombre;
                document.getElementById('info-email').textContent = user.empleado.email;
                document.getElementById('info-departamento').textContent = user.empleado.departamento;
                document.getElementById('info-rol').textContent = user.empleado.rol;
                document.getElementById('info-empleado').style.display = 'block';

                // ✅ Establecer el IdEmpleado en un campo oculto o en el select (solo lectura visual)
                const select = document.getElementById('selEmpleado');
                select.innerHTML = `<option value="${user.empleado.idEmpleado}" selected>${user.empleado.nombre} (${user.empleado.departamento})</option>`;
                select.disabled = true; // Visualmente deshabilitado, pero el valor se envía

                document.getElementById('modalTitle').textContent = 'Editar Usuario';
                if (!state.modalInstance) {
                    state.modalInstance = new bootstrap.Modal(document.getElementById('modalUsuario'));
                }
                state.modalInstance.show();
            } catch (error) {
                console.error('❌ Error al cargar usuario:', error);
                mostrarAlerta('Error al cargar usuario: ' + error.message, 'danger');
            }
        }

        // Guardar usuario
        // Guardar usuario
        async function guardarUsuario() {
            const form = document.getElementById('formUsuario');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const usuarioId = document.getElementById('usuarioId').value;
            const data = {
                IdEmpleado: parseInt(document.getElementById('selEmpleado').value),
                Username: document.getElementById('txtUsername').value.trim(),
                Password: document.getElementById('txtPassword').value,
                // Activo se maneja por el backend o por otro endpoint
            };

            try {
                if (usuarioId) {
                    // ✅ Actualizar con todos los datos
                    await apiCall(`/api/usuarios/${usuarioId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    mostrarAlerta('Usuario actualizado exitosamente', 'success');
                } else {
                    // Crear nuevo
                    await apiCall('/api/usuarios', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    mostrarAlerta('Usuario creado exitosamente', 'success');
                }

                if (state.modalInstance) {
                    state.modalInstance.hide();
                }
                await cargarUsuarios();
                await cargarEmpleadosSinUsuario();
            } catch (error) {
                console.error('Error al guardar:', error);
                mostrarAlerta('Error al guardar: ' + error.message, 'danger');
            }
        }

        // Abrir modal para cambiar contraseña
        function cambiarPasswordModal(id, username) {
            console.log('🔑 Cambiando contraseña para usuario:', username);

            document.getElementById('passwordUsuarioId').value = id;
            document.getElementById('txtNewPassword').value = '';

            if (!state.modalPasswordInstance) {
                state.modalPasswordInstance = new bootstrap.Modal(document.getElementById('modalPassword'));
            }
            state.modalPasswordInstance.show();
        }

        // Cambiar contraseña
        async function cambiarPassword() {
            const usuarioId = document.getElementById('passwordUsuarioId').value;
            const nuevaPassword = document.getElementById('txtNewPassword').value;

            if (!nuevaPassword || nuevaPassword.length < 6) {
                mostrarAlerta('La contraseña debe tener al menos 6 caracteres', 'warning');
                return;
            }

            try {
                await apiCall(`/api/usuarios/${usuarioId}/cambiar-password`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nuevaPassword: nuevaPassword
                    })
                });

                mostrarAlerta('Contraseña actualizada exitosamente', 'success');

                if (state.modalPasswordInstance) {
                    state.modalPasswordInstance.hide();
                }
            } catch (error) {
                console.error('❌ Error al cambiar contraseña:', error);
                mostrarAlerta('Error al cambiar contraseña: ' + error.message, 'danger');
            }
        }

        // Eliminar usuario (desactivar)
        async function eliminarUsuario(id, username) {
            if (!confirm(`¿Estás seguro de desactivar al usuario ${username}?`)) return;

            try {
                await apiCall(`/api/usuarios/${id}`, { method: 'DELETE' });
                mostrarAlerta('Usuario desactivado exitosamente', 'success');
                await cargarUsuarios();
                await cargarEmpleadosSinUsuario(); // Actualizar estadísticas
            } catch (error) {
                mostrarAlerta('Error al desactivar: ' + error.message, 'danger');
            }
        }

        // Activar usuario
        async function activarUsuario(id, username) {
            if (!confirm(`¿Estás seguro de activar al usuario ${username}?`)) return;
            try {
                await apiCall(`/api/usuarios/${id}/activar`, { method: 'PUT' });
                mostrarAlerta('Usuario activado exitosamente', 'success');
                await cargarUsuarios();
                await cargarEmpleadosSinUsuario(); // Actualizar estadísticas
            } catch (error) {
                mostrarAlerta('Error al activar: ' + error.message, 'danger');
            }
        }

        // Mostrar alerta
        function mostrarAlerta(mensaje, tipo = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => alertDiv.remove(), 3000);
        }

        // Inicializar
        async function init() {
            console.log('🚀 Iniciando módulo de usuarios...');

            // Verificar que estamos en la vista correcta
            if (!document.getElementById('usuarios-container')) {
                console.log('⏭️ No estamos en la vista de usuarios, saliendo...');
                return;
            }

            await cargarUsuarios();
            await cargarEmpleadosSinUsuario();

            // Configurar búsqueda
            const inputBuscar = document.getElementById('input-buscar');
            if (inputBuscar) {
                inputBuscar.addEventListener('input', (e) => {
                    const texto = e.target.value.toLowerCase();
                    const filtrados = state.usuarios.filter(user =>
                        user.username.toLowerCase().includes(texto) ||
                        (user.empleado?.nombre || '').toLowerCase().includes(texto) ||
                        (user.empleado?.email || '').toLowerCase().includes(texto)
                    );
                    const temp = state.usuarios;
                    state.usuarios = filtrados;
                    renderizarUsuarios();
                    state.usuarios = temp;
                });
            }

            // Configurar filtro de estado
            const selectEstado = document.getElementById('select-estado');
            if (selectEstado) {
                selectEstado.addEventListener('change', (e) => {
                    const estado = e.target.value;
                    let filtrados = state.usuarios;

                    if (estado === 'activo') {
                        filtrados = state.usuarios.filter(u => u.activo);
                    } else if (estado === 'inactivo') {
                        filtrados = state.usuarios.filter(u => !u.activo);
                    }

                    const temp = state.usuarios;
                    state.usuarios = filtrados;
                    renderizarUsuarios();
                    state.usuarios = temp;
                });
            }

            // Configurar toggle de contraseñas
            document.getElementById('btnTogglePassword')?.addEventListener('click', function () {
                const passwordInput = document.getElementById('txtPassword');
                const icon = this.querySelector('i');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.className = 'bi bi-eye-slash';
                } else {
                    passwordInput.type = 'password';
                    icon.className = 'bi bi-eye';
                }
            });

            document.getElementById('btnToggleNewPassword')?.addEventListener('click', function () {
                const passwordInput = document.getElementById('txtNewPassword');
                const icon = this.querySelector('i');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.className = 'bi bi-eye-slash';
                } else {
                    passwordInput.type = 'password';
                    icon.className = 'bi bi-eye';
                }
            });

            console.log('✅ Módulo de usuarios iniciado');
        }

        // Iniciar cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // API pública del módulo
        return {
            init,
            abrirModalNuevo,
            editarUsuario,
            guardarUsuario,
            cambiarPasswordModal,
            cambiarPassword,
            eliminarUsuario,
            activarUsuario 
        };
    })();
</script>